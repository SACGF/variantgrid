!function(e){"use strict";"function"==typeof define&&define.amd?define(["jquery","./jquery.fmatter","./grid.grouping"],e):"object"==typeof module&&module.exports?module.exports=function(t,r){return t||(t=window),void 0===r&&(r="undefined"!=typeof window?require("jquery"):require("jquery")(t)),require("./jquery.fmatter"),require("./grid.grouping"),e(r),r}:e(jQuery)}(function(e){"use strict";function t(e,r,o){if(!(this instanceof t))return new t(e);this.aggregator=e,this.finilized=!1,this.context=r,this.pivotOptions=o}function r(t,r,o,n,i){var a,s,u=n.length,l=this;for(l.items=[],l.indexesOfSourceData=[],l.trimByCollect=t,l.caseSensitive=r,l.skipSort=o,l.fieldLength=u,l.fieldNames=new Array(u),l.fieldSortDirection=new Array(u),l.fieldCompare=new Array(u),a=0;a<u;a++){switch(s=n[a],l.fieldNames[a]=s[i||"dataName"],s.sorttype){case"integer":case"int":l.fieldCompare[a]=function(e,t){return e=Math.floor(Number(e)),t=Math.floor(Number(t)),e===t?0:e<t?-1:1};break;case"number":case"currency":case"float":l.fieldCompare[a]=function(e,t){return e=Number(e),t=Number(t),e===t?0:e<t?-1:1};break;default:l.fieldCompare[a]=e.isFunction(s.compare)?s.compare:function(e,t){var r=e,o=t;if(null==r&&(r=""),null==o&&(o=""),r=String(r),o=String(o),this.caseSensitive||(r=r.toUpperCase(),o=o.toUpperCase()),r===o){if(e===t)return 0;if(void 0===e)return-1;if(void 0===t)return 1;if(null===e)return-1;if(null===t)return 1}return r<o?-1:1}}l.fieldSortDirection[a]="desc"===s.sortorder?-1:1}}var o=e.jgrid;t.prototype.calc=function(t,r,o,n,i){var a=this;if(void 0!==t)switch(a.result=a.result||0,t=parseFloat(t),a.aggregator){case"sum":a.result+=t;break;case"count":a.result++;break;case"avg":a.finilized?(a.count=a.count||0,a.result=(a.result*a.count+t)/(a.count+1),a.count++):(a.result+=t,a.count=a.count||0,a.count++);break;case"min":a.result=Math.min(a.result,t);break;case"max":a.result=Math.max(a.result,t);break;default:e.isFunction(a.aggregator)&&(a.result=a.aggregator.call(a.context,{previousResult:a.result,value:t,fieldName:r,item:o,iItem:n,items:i}))}},t.prototype.getResult=function(e,t,r){var o=this;(void 0!==o.result||r)&&(r&&void 0!==o.result&&(o.result=0,o.count=0),void 0===o.result||o.finilized||"avg"!==o.aggregator||(o.result=o.result/o.count,o.finilized=!0),e[t]=o.result)},r.prototype.compareVectorsEx=function(e,t){var r,o,n=this,i=n.fieldLength;for(r=0;r<i;r++)if(0!==(o=n.fieldCompare[r](e[r],t[r])))return{index:r,result:o};return{index:-1,result:0}},r.prototype.getIndexOfDifferences=function(e,t){return null===t||null===e?0:this.compareVectorsEx(e,t).index},r.prototype.compareVectors=function(e,t){var r=this.compareVectorsEx(e,t);return(r.index>=0?this.fieldSortDirection[r.index]:1)>0?r.result:-r.result},r.prototype.getItem=function(e){return this.items[e]},r.prototype.getIndexLength=function(){return this.items.length},r.prototype.getIndexesOfSourceData=function(e){return this.indexesOfSourceData[e]},r.prototype.createDataIndex=function(t){var r,o,n,i,a,s,u,l,f,g=this,p=t.length,c=g.fieldLength,m=g.fieldNames,d=g.indexesOfSourceData,y=g.items;for(r=0;r<p;r++){for(u=t[r],o=new Array(c),i=0;i<c;i++)void 0!==(n=u[m[i]])&&("string"==typeof n&&g.trimByCollect&&(n=e.trim(n)),o[i]=n);if(l=0,(f=y.length-1)<0)y.push(o),d.push([r]);else if(0!==(a=g.compareVectors(o,y[f])))if(1===a||g.skipSort)y.push(o),d.push([r]);else if(1!==(a=g.compareVectors(y[0],o)))if(0!==a)for(;;){if(f-l<2){y.splice(f,0,o),d.splice(f,0,[r]);break}if(s=Math.floor((l+f)/2),0===(a=g.compareVectors(y[s],o))){d[s].push(r);break}1===a?f=s:l=s}else d[0].push(r);else y.unshift(o),d.unshift([r]);else d[f].push(r)}},o.extend({pivotSetup:function(n,i){var a,s,u,l,f,g,p,c,m,d,y,h,x,v,w,b,S,I,O,C,D,A,T,k,F,N,R,H,V,j=this[0],Y=e.isArray,B={},q={groupField:[],groupSummary:[],groupSummaryPos:[]},P={grouping:!0,groupingView:q},L=e.extend({totals:!1,useColSpanStyle:!1,trimByCollect:!0,skipSortByX:!1,skipSortByY:!1,caseSensitive:!1,footerTotals:!1,groupSummary:!0,groupSummaryPos:"header",frozenStaticCols:!1,defaultFormatting:!0,data:n},i||{}),z=n.length,M=L.xDimension,X=L.yDimension,E=L.aggregates,G=L.totalText||L.totals||L.rowTotals||L.totalHeader,U=Y(M)?M.length:0,Q=Y(X)?X.length:0,J=Y(E)?E.length:0,K=Q-(1===J?1:0),W=[],Z=[],$=[],_=[],ee=["pivotInfos"],te=new Array(J),re=new Array(Q),oe=function(t,o,i){var a=new r(L.trimByCollect,L.caseSensitive,o,t);return e.isFunction(i)&&(a.compareVectorsEx=i),a.createDataIndex(n),a},ne=function(t,r,n,i,a){var s,u,l;switch(t){case 1:s=X[i].totalText||"{0} {1} {2}",u="y"+a+"t"+i;break;case 2:s=L.totalText||"{0}",u="t";break;default:s=J>1?r.label||"{0}":e.isFunction(X[i].label)?X[i].label:H.getItem(a)[i],u="y"+a}return l=e.extend({},r,{name:u+(J>1?"a"+n:""),label:e.isFunction(s)?s.call(j,2===t?{aggregate:r,iAggregate:n,pivotOptions:L}:1===t?{yIndex:H.getItem(a),aggregate:r,iAggregate:n,yLevel:i,pivotOptions:L}:{yData:H.getItem(a)[i],yIndex:H.getItem(a),yLevel:i,pivotOptions:L}):o.template.apply(j,2===t?[String(s),r.aggregator,r.member,n]:[String(s),r.aggregator,r.member,H.getItem(a)[i],i])}),delete l.member,delete l.aggregator,l},ie=function(e,t,r){var o,n;for(o=0;o<J;o++)void 0===(n=E[o]).template&&void 0===n.formatter&&L.defaultFormatting&&(n.template="count"===n.aggregator?"integer":"number"),$.push(ne(e,n,o,t,r))},ae=function(t,r,n){var i,a,s,u;for(i=K-1;i>=r;i--)if(Z[i]){for(a=0;a<=i;a++)(F=W[a].groupHeaders)[F.length-1].numberOfColumns+=J;for(s=(f=X[i]).totalHeader,u=f.headerOnTop,a=i+1;a<=K-1;a++)W[a].groupHeaders.push({titleText:u&&a===i+1||!u&&a===K-1?e.isFunction(s)?s.call(j,n,i):o.template.call(j,String(s||""),n[i],i):"",startColumnName:"y"+(t-1)+"t"+i+(1===J?"":"a0"),numberOfColumns:J})}},se=function(e){var r=new t("count"===E[e].aggregator?"sum":E[e].aggregator,j,i);return r.groupInfo={iRows:[],rows:[],ys:[],iYs:[]},r},ue=function(e,t,r,o){var n,i,a,s=H.getIndexOfDifferences(t,r);if(null!==r)for(s=Math.max(s,0),n=K-1;n>=s;n--)i="y"+e+"t"+n+(J>1?"a"+o:""),Z[n]&&void 0===T[i]&&((a=re[n][o]).getResult(T,i),T.pivotInfos[i]={colType:1,iA:o,a:E[o],level:n,iRows:a.groupInfo.iRows,rows:a.groupInfo.rows,ys:a.groupInfo.ys,iYs:a.groupInfo.iYs},t!==r&&(re[n][o]=se(o)))};if(0===U||0===J)throw"xDimension or aggregates options are not set!";for(R=oe(M,L.skipSortByX,L.compareVectorsByX),H=oe(X,L.skipSortByY,L.compareVectorsByY),i.xIndex=R,i.yIndex=H,s=0;s<U;s++)g={name:"x"+s,label:null!=(l=M[s]).label?e.isFunction(l.label)?l.label.call(j,l,s,L):l.label:l.dataName,frozen:L.frozenStaticCols},s<U-1&&!l.skipGrouping&&!l.additionalProperty&&(q.groupField.push(g.name),q.groupSummary.push(L.groupSummary),q.groupSummaryPos.push(L.groupSummaryPos)),delete(g=e.extend(g,l)).dataName,delete g.footerText,l.additionalProperty?ee.push(g.name):($.push(g),P.sortname=g.name);for(U<2&&(P.grouping=!1),q.hideFirstGroupCol=!0,s=0;s<Q;s++)f=X[s],Z.push(!!(f.totals||f.rowTotals||f.totalText||f.totalHeader));for(k=H.getItem(0),ie(0,Q-1,0),V=H.getIndexLength(),I=1;I<V;I++){for(O=H.getItem(I),s=H.getIndexOfDifferences(O,k),u=K-1;u>=s;u--)Z[u]&&ie(1,u,I-1);k=O,ie(0,Q-1,I)}for(s=K-1;s>=0;s--)Z[s]&&ie(1,s,V-1);for(G&&ie(2),k=H.getItem(0),u=0;u<K;u++)W.push({useColSpanStyle:L.useColSpanStyle,groupHeaders:[{titleText:e.isFunction(X[u].label)?X[u].label.call(j,{yData:k[u],yIndex:k,yLevel:u,pivotOptions:L}):k[u],startColumnName:1===J?"y0":"y0a0",numberOfColumns:J}]});for(I=1;I<V;I++){for(O=H.getItem(I),ae(I,s=H.getIndexOfDifferences(O,k),k),u=K-1;u>=s;u--)W[u].groupHeaders.push({titleText:e.isFunction(X[u].label)?X[u].label.call(j,{yData:O[u],yIndex:O,yLevel:u,pivotOptions:L}):O[u],startColumnName:"y"+I+(1===J?"":"a0"),numberOfColumns:J});for(u=0;u<s;u++)(F=W[u].groupHeaders)[F.length-1].numberOfColumns+=J;k=O}if(ae(V,0,k),G)for(s=0;s<K;s++)W[s].groupHeaders.push({titleText:s<K-1?"":L.totalHeader||"",startColumnName:"t"+(1===J?"":"a0"),numberOfColumns:J});for(b=R.getIndexLength(),m=0;m<b;m++){for(d=R.getItem(m),T={pivotInfos:y={iX:m,x:d}},s=0;s<U;s++)T["x"+s]=d[s];if(S=R.getIndexesOfSourceData(m),G)for(u=0;u<J;u++)te[u]=se(u);for(k=null,function(){var e,t;for(e=K-1;e>=0;e--)if(Z[e])for(null==re[e]&&(re[e]=new Array(J)),t=0;t<J;t++)re[e][t]=se(t)}(),I=0;I<V;I++){for(O=H.getItem(I),C=H.getIndexesOfSourceData(I),u=0;u<J;u++){for(null!==k&&ue(I-1,O,k,u),D=[],s=0;s<C.length;s++)N=C[s],e.inArray(N,S)>=0&&D.push(N);if(D.length>0){for(h=new Array(D.length),x=new t((A=E[u]).aggregator,j,i),p=0;p<D.length;p++)s=D[p],a=n[s],h[p]=a,x.calc(a[A.member],A.member,a,s,n),G&&((v=te[u]).calc(a[A.member],A.member,a,s,n),w=v.groupInfo,e.inArray(s,w.iYs)<0&&(w.iYs.push(I),w.ys.push(O)),e.inArray(s,w.iRows)<0&&(w.iRows.push(s),w.rows.push(a))),function(t,r,o,i,a,s,u){var l,f,g;if(t!==r)for(l=K-1;l>=0;l--)Z[l]&&((f=re[l][i]).calc(a[o.member],o.member,a,s,n),g=f.groupInfo,e.inArray(u,g.iYs)<0&&(g.iYs.push(u),g.ys.push(t)),e.inArray(s,g.iRows)<0&&(g.iRows.push(s),g.rows.push(a)))}(O,k,A,u,a,s,I);c="y"+I+(1===J?"":"a"+u),x.getResult(T,c),y[c]={colType:0,iY:I,y:O,iA:u,a:A,iRows:D,rows:h}}}k=O}if(null!==k)for(u=0;u<J;u++)ue(V-1,k,k,u);if(G)for(u=0;u<J;u++)c="t"+(1===J?"":"a"+u),(v=te[u]).getResult(T,c),w=v.groupInfo,y[c]={colType:2,iA:u,a:E[u],iRows:w.iRows,rows:w.rows,iYs:w.iYs,ys:w.ys};_.push(T)}if(L.footerTotals||L.colTotals){for(z=_.length,s=0;s<U;s++)B["x"+s]=M[s].footerText||"";for(s=U;s<$.length;s++){for(c=$[s].name,x=new t(L.footerAggregator||"sum",j,i),p=0;p<z;p++)T=_[p],x.calc(T[c],c,T,p,_);x.getResult(B,c)}}return i.colHeaders=W,{colModel:$,additionalProperties:ee,options:i,rows:_,groupOptions:P,groupHeaders:W,summary:B}},jqPivot:function(t,r,n,i){return this.each(function(){function a(){var i,a=l.pivotSetup.call(u,t,r),f=a.groupHeaders,g=function(e){var t,r=0;for(t in e)e.hasOwnProperty(t)&&r++;return r}(a.summary)>0,p=a.groupOptions.groupingView,c=o.from.call(s,a.rows);if(!r.skipSortByX)for(i=0;i<p.groupField.length;i++)c.orderBy(p.groupField[i],null!=n&&n.groupingView&&null!=n.groupingView.groupOrder&&"desc"===n.groupingView.groupOrder[i]?"d":"a","text","");if(r.data=t,l.call(u,e.extend(!0,{datastr:e.extend(c.select(),g?{userdata:a.summary}:{}),datatype:"jsonstring",footerrow:g,userDataOnFooter:g,colModel:a.colModel,additionalProperties:a.additionalProperties,pivotOptions:a.options,viewrecords:!0,sortname:r.xDimension[0].dataName},a.groupOptions,n||{})),f.length)for(i=0;i<f.length;i++)f[i]&&f[i].groupHeaders.length&&l.setGroupHeaders.call(u,f[i]);r.frozenStaticCols&&l.setFrozenColumns.call(u)}var s=this,u=e(s),l=e.fn.jqGrid;"string"==typeof t?e.ajax(e.extend({url:t,dataType:"json",success:function(e){t=o.getAccessor(e,i&&i.reader?i.reader:"rows"),a()}},i||{})):a()})}})});
//# sourceMappingURL=grid.pivot.js.map