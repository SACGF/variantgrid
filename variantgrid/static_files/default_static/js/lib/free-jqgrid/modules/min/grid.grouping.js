!function(r){"use strict";"function"==typeof define&&define.amd?define(["jquery","./grid.base"],r):"object"==typeof module&&module.exports?module.exports=function(e,o){return e||(e=window),void 0===o&&(o="undefined"!=typeof window?require("jquery"):require("jquery")(e)),require("./grid.base"),r(o),o}:r(jQuery)}(function(r){"use strict";var e=r.jgrid,o=r.fn.jqGrid;e.extend({groupingSetup:function(){return this.each(function(){var i,n,t,l,a,u=this,s=u.p,d=s.colModel,p=s.groupingView;if(null===p||"object"!=typeof p&&!r.isFunction(p))s.grouping=!1;else if(p.groupField.length){for(void 0===p.visibiltyOnNextGrouping&&(p.visibiltyOnNextGrouping=[]),p.lastvalues=[],p._locgr||(p.groups=[]),p.counters=[],i=0;i<p.groupField.length;i++)p.groupOrder[i]||(p.groupOrder[i]="asc"),p.groupText[i]||(p.groupText[i]="{0}"),"boolean"!=typeof p.groupColumnShow[i]&&(p.groupColumnShow[i]=!0),"boolean"!=typeof p.groupSummary[i]&&(p.groupSummary[i]=!1),p.groupSummaryPos[i]||(p.groupSummaryPos[i]="footer"),l=d[s.iColByName[p.groupField[i]]],!0===p.groupColumnShow[i]?(p.visibiltyOnNextGrouping[i]=!0,null!=l&&!0===l.hidden&&o.showCol.call(r(u),p.groupField[i])):(p.visibiltyOnNextGrouping[i]=r("#"+e.jqID(s.id+"_"+p.groupField[i])).is(":visible"),null!=l&&!0!==l.hidden&&o.hideCol.call(r(u),p.groupField[i]));for(p.summary=[],p.hideFirstGroupCol&&(p.formatDisplayField[0]=function(r){return r}),n=0,t=d.length;n<t;n++)l=d[n],p.hideFirstGroupCol&&(l.hidden||p.groupField[0]!==l.name||(l.formatter=function(){return""})),l.summaryType&&(a={nm:l.name,st:l.summaryType,v:"",sr:l.summaryRound,srt:l.summaryRoundType||"round"},l.summaryDivider&&(a.sd=l.summaryDivider,a.vd=""),p.summary.push(a))}else s.grouping=!1})},groupingPrepare:function(e,i){return this.each(function(){var n,t,l,a,u,s,d,p,g,m=this,f=m.p,c=f.groupingView,h=c.groups,y=c.counters,v=c.lastvalues,x=c.isInTheSameGroup,w=c.groupField.length,F=!1,C=o.groupingCalculations.handler,j=function(e,o){if(null==e&&c.useDefaultValuesOnGrouping){var i,n=void 0!==f.iColByName[o]?f.colModel[f.iColByName[o]]:f.additionalProperties[f.iPropByName[o]];null!=n&&null!=n.formatter&&(null!=n.formatoptions&&void 0!==n.formatoptions.defaultValue?e=n.formatoptions.defaultValue:"string"==typeof n.formatter&&void 0!==(i=r(m).jqGrid("getGridRes","formatter."+n.formatter+".defaultValue"))&&(e=i))}return e};for(n=0;n<w;n++)if(s=c.groupField[n],d=j(e[s],s),d,p=c.displayField[n],null==(g=null==p?null:j(e[p],p))&&(g=d),void 0!==d){for(l=[],t=0;t<=n;t++)l.push(e[c.groupField[t]]);for(a={idx:n,dataIndex:s,value:d,displayValue:g,startRow:i,cnt:1,keys:l,summary:[]},u={cnt:1,pos:h.length,summary:r.extend(!0,[],c.summary)},0===i?(h.push(a),v[n]=d,y[n]=u):"object"==typeof d||(r.isArray(x)&&r.isFunction(x[n])?x[n].call(m,v[n],d,n,c):v[n]===d)?F?(h.push(a),v[n]=d,y[n]=u):((u=y[n]).cnt+=1,h[u.pos].cnt=u.cnt):(h.push(a),v[n]=d,F=!0,y[n]=u),h[u.pos].summary=function(){var o,i,n;for(o=0;o<u.summary.length;o++)i=u.summary[o],n=r.isArray(i.st)?i.st[a.idx]:i.st,r.isFunction(n)?i.v=n.call(m,i.v,i.nm,e,a):(i.v=C.call(r(m),n,i.v,i.nm,i.sr,i.srt,e),"avg"===n.toLowerCase()&&i.sd&&(i.vd=C.call(r(m),n,i.vd,i.sd,i.sr,i.srt,e)));return u.summary}(),t=u.pos-1;t>=0;t--)if(h[t].idx<h[u.pos].idx){h[u.pos].parentGroupIndex=t,h[u.pos].parentGroup=h[t];break}}}),this},getGroupHeaderIndex:function(o,i){var n=this[0].p,t=i?r(i).closest("tr.jqgroup"):r("#"+e.jqID(o)),l=parseInt(t.data("jqgrouplevel"),10),a=n.id+"ghead_"+l+"_";return isNaN(l)||!t.hasClass("jqgroup")||o.length<=a.length?-1:parseInt(o.substring(a.length),10)},groupingToggle:function(o,i){return this.each(function(){var n,t,l,a=this,u=a.p,s=u.groupingView,d=s.minusicon,p=s.plusicon,g=i?r(i).closest("tr.jqgroup"):r("#"+e.jqID(o)),m=function(r){return r.find(">td>span.tree-wrap")},f=!0,c=!1,h=[],y=function(r){var e,o=r.length;for(e=0;e<o;e++)h.push(r[e])},v=parseInt(g.data("jqgrouplevel"),10);for(u.frozenColumns&&g.length>0&&(t=g[0].rowIndex,g=(g=r(a.rows[t])).add(a.grid.fbRows[t])),l=m(g),e.hasAllClasses(l,d)?(l.removeClass(d).addClass(p),c=!0):l.removeClass(p).addClass(d),g=g.next();g.length;g=g.next())if(g.hasClass("jqfoot")){if(n=parseInt(g.data("jqfootlevel"),10),c){if(n=parseInt(g.data("jqfootlevel"),10),(!s.showSummaryOnHide&&n===v||n>v)&&y(g),n<v)break}else if((n===v||s.showSummaryOnHide&&n===v+1)&&y(g),n<=v)break}else if(g.hasClass("jqgroup"))if(n=parseInt(g.data("jqgrouplevel"),10),c){if(n<=v)break;y(g)}else{if(n<=v)break;n===v+1&&(m(g).removeClass(d).addClass(p),y(g)),f=!1}else(c||f)&&y(g);r(h).css("display",c?"none":""),u.frozenColumns&&r(a).triggerHandler("jqGridResetFrozenHeights",[{header:{resizeDiv:!1,resizedRows:{iRowStart:-1,iRowEnd:-1}},resizeFooter:!1,body:{resizeDiv:!0,resizedRows:{iRowStart:t,iRowEnd:g.length?g[0].rowIndex-1:-1}}}]),a.fixScrollOffsetAndhBoxPadding(),r(a).triggerHandler("jqGridGroupingClickGroup",[o,c]),r.isFunction(u.onClickGroup)&&u.onClickGroup.call(a,o,c)}),!1},groupingRender:function(i,n){function t(o,i,n,t,l){var s,d,g,m,y,v,x,w,F,C,j,b,q,G=f[o],S="",R=0,I=!0;if(0!==i&&0!==f[o].idx)for(s=o;s>=0;s--)if(f[s].idx===f[o].idx-i){G=f[s];break}for(d=G.cnt,j=void 0===l?t:0;j<h;j++){for(g="&#160;",C=c[j],w=0;w<G.summary.length;w++)if(F=G.summary[w],b=r.isArray(F.st)?F.st[n.idx]:F.st,q=r.isArray(C.summaryTpl)?C.summaryTpl[n.idx]:C.summaryTpl||"{0}",F.nm===C.name){"string"==typeof b&&"avg"===b.toLowerCase()&&(F.sd&&F.vd?F.v=F.v/F.vd:F.v&&d>0&&(F.v=F.v/d));try{F.groupCount=G.cnt,F.groupIndex=G.dataIndex,F.groupValue=G.value,v=a.formatter("",F.v,j,F)}catch(r){v=F.v}g=e.format(q,v),C.summaryFormat&&(g=C.summaryFormat.call(a,n,g,v,C,F));break}m=!1,y=!1,void 0!==l&&I&&(C.hidden||(g=l,I=!1,t>1&&(m=!0,R=t-1),y=C.align,C.align="rtl"===u.direction?"right":"left",p.iconColumnName=C.name)),x=!1,R>0&&!C.hidden&&"&#160;"===g?(x=!0,y&&(C.align=y),R--):(S+="<td role='gridcell' "+a.formatCol(j,1,"")+(m?"colspan='"+t+"'":"")+">"+g+"</td>",m=!1,y&&(C.align=y),x&&(C.hidden=!1,R--))}return S}var l="",a=this[0],u=a.p,s=0,d=[],p=u.groupingView,g=r.makeArray(p.groupSummary),m=p.groupField.length,f=p.groups,c=u.colModel,h=c.length,y=u.page,v="jqGridShowHideCol.groupingRender",x=function(r){return o.getGuiStyles.call(a,"gridRow",r)},w=x("jqgroup ui-row-"+u.direction),F=x("jqfoot ui-row-"+u.direction);return r.each(c,function(r,e){var o;for(o=0;o<m;o++)if(p.groupField[o]===e.name){d[o]=r;break}}),g.reverse(),r.each(f,function(o,v){var x,C,j,b,q,G,S,R,I=u.id+"ghead_"+v.idx,N=I+"_"+o,V=r.isFunction(p.groupCollapse)?p.groupCollapse.call(a,{group:v,rowid:N}):p.groupCollapse,O=1,k=0,T=m-1===v.idx,D=null!=v.parentGroup&&v.parentGroup.collapsed,P="<span style='cursor:pointer;margin-"+("rtl"===u.direction?"right:":"left:")+12*v.idx+"px;' class='"+p.commonIconClass+" "+(V?p.plusicon:p.minusicon)+" tree-wrap' onclick=\"jQuery('#"+e.jqID(u.id).replace("\\","\\\\")+"').jqGrid('groupingToggle','"+N+"', this);return false;\"></span>";if(p._locgr&&!(v.startRow+v.cnt>(y-1)*n&&v.startRow<y*n))return!0;D&&(V=!0),void 0!==V&&(v.collapsed=V),s++;try{r.isArray(p.formatDisplayField)&&r.isFunction(p.formatDisplayField[v.idx])?(v.displayValue=p.formatDisplayField[v.idx].call(a,v.displayValue,v.value,c[d[v.idx]],v.idx,p),x=v.displayValue):x=a.formatter(N,v.displayValue,d[v.idx],v.value)}catch(r){x=v.displayValue}if(l+="<tr id='"+N+"' data-jqgrouplevel='"+v.idx+"' "+(V&&D?"style='display:none;' ":"")+"role='row' class='"+w+" "+I+"'>","string"!=typeof(R=r.isFunction(p.groupText[v.idx])?p.groupText[v.idx].call(a,x,v.cnt,v.summary):e.template(p.groupText[v.idx],x,v.cnt,v.summary))&&"number"!=typeof R&&(R=x),"header"===p.groupSummaryPos[v.idx]?(O=1,"cb"!==c[0].name&&"cb"!==c[1].name||O++,"subgrid"!==c[0].name&&"subgrid"!==c[1].name||O++,l+=t(o,0,v,O,P+"<span class='cell-wrapper'>"+R+"</span>")):l+="<td role='gridcell' style='padding-left:"+12*v.idx+"px;' colspan='"+h+"'>"+P+R+"</td>",l+="</tr>",T){for(G=f[o+1],q=v.startRow,S=void 0!==G?G.startRow:f[o].startRow+f[o].cnt,p._locgr&&(k=(y-1)*n)>v.startRow&&(q=k),j=q;j<S&&i[j-k];j++)l+=i[j-k].join("");if("header"!==p.groupSummaryPos[v.idx]){if(void 0!==G){for(C=0;C<p.groupField.length&&G.dataIndex!==p.groupField[C];C++);s=p.groupField.length-C}for(b=0;b<s;b++)g[b]&&(l+="<tr data-jqfootlevel='"+(v.idx-b)+(V&&(v.idx-b>0||!p.showSummaryOnHide)?"' style='display:none;'":"'")+" role='row' class='"+F+"'>",l+=t(o,b,f[v.idx-b],0),l+="</tr>");s=C}}}),this.off(v).on(v,function(){var e,o,i,n,t=u.iColByName[p.iconColumnName];if(r.inArray("header",p.groupSummaryPos)>=0){for(n=0;n<c.length;n++)if(!c[n].hidden){i=n;break}if(void 0===i||t===i)return;for(e=0;e<a.rows.length;e++)o=a.rows[e],r(o).hasClass("jqgroup")&&(r(o.cells[i]).html(o.cells[t].innerHTML),r(o.cells[t]).html("&nbsp;"));p.iconColumnName=c[i].name}}),l},groupingGroupBy:function(i,n){return this.each(function(){var t,l,a=this,u=a.p,s=u.groupingView;for("string"==typeof i&&(i=[i]),u.grouping=!0,s._locgr=!1,void 0===s.visibiltyOnNextGrouping&&(s.visibiltyOnNextGrouping=[]),t=0;t<s.groupField.length;t++)l=u.colModel[u.iColByName[s.groupField[t]]],!s.groupColumnShow[t]&&s.visibiltyOnNextGrouping[t]&&null!=l&&!0===l.hidden&&o.showCol.call(r(a),s.groupField[t]);for(t=0;t<i.length;t++)s.visibiltyOnNextGrouping[t]=r(u.idSel+"_"+e.jqID(i[t])).is(":visible");u.groupingView=r.extend(u.groupingView,n||{}),s.groupField=i,r(a).trigger("reloadGrid")})},groupingRemove:function(e){return this.each(function(){var i,n=this,t=n.p,l=n.tBodies[0],a=t.groupingView;if(void 0===e&&(e=!0),t.grouping=!1,!0===e){for(i=0;i<a.groupField.length;i++)!a.groupColumnShow[i]&&a.visibiltyOnNextGrouping[i]&&o.showCol.call(r(n),a.groupField);r("tr.jqgroup, tr.jqfoot",l).remove(),r("tr.jqgrow",l).filter(":hidden").show()}else r(n).trigger("reloadGrid")})},groupingCalculations:{handler:function(r,e,o,i,n,t){var l,a,u={sum:function(){return parseFloat(e||0)+parseFloat(t[o]||0)},min:function(){return""===e?parseFloat(t[o]||0):Math.min(parseFloat(e),parseFloat(t[o]||0))},max:function(){return""===e?parseFloat(t[o]||0):Math.max(parseFloat(e),parseFloat(t[o]||0))},count:function(){return""===e&&(e=0),t.hasOwnProperty(o)?e+1:0},avg:function(){return u.sum()}};if(!u[r])throw"jqGrid Grouping No such method: "+r;return l=u[r](),null!=i&&("fixed"===n?l=l.toFixed(i):(a=Math.pow(10,i),l=Math.round(l*a)/a)),l}}})});
//# sourceMappingURL=grid.grouping.js.map