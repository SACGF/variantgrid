/**
 * @license OData plugin for Free-jqGrid
 *
 * Copyright (c) 2014-2017, Mark Babayev (https://github.com/mirik123) markolog@gmail.com
 * License MIT (MIT-LICENSE.txt)
 *
 * inspired by Richard Bennett gist code: jqGrid.ODataExtensions.js
 * https://gist.github.com/dealproc/6678280
 */
!function(e){"use strict";"function"==typeof define&&define.amd?define(["jquery","free-jqgrid/grid.base"],e):"object"==typeof module&&module.exports?module.exports=function(t,a){return void 0===a&&(a="undefined"!=typeof window?require("jquery"):require("jquery")(t||window)),require("free-jqgrid/grid.base"),e(a),a}:e(jQuery)}(function(e){"use strict";e.jgrid.odataHelper={resolveJsonReferences:function(e,t){function a(e,i,l){if("object"!=typeof e||!e)return e;if("[object Array]"===Object.prototype.toString.call(e)){for(r=0;r<e.length;r++){if("object"!=typeof e[r]||!e[r])return e[r];e[r].$ref?e[r]=a(e[r],r,e):e[r]=a(e[r],i,e)}return e}if(e.$ref)return n=e.$ref,o[n]?o[n]:void t.push([l,i,n]);if(e.$id){var d=e.$id;if(delete e.$id,e.$values)e=e.$values.map(a);else{var s;for(s in e)e.hasOwnProperty(s)&&(e[s]=a(e[s],s,e))}o[d]=e}return e}var r,n,o={};for(t=t||[],"string"==typeof e&&(e=JSON.parse(e)),e=a(e),r=0;r<t.length;r++)(n=t[r])[0][n[1]]=o[n[2]];return e},convertXmlToJson:function(t){var a,r,n,o,i,l,d={};if(!t)return null;if(1===t.nodeType){if(t.attributes.length>0)for(d["@attributes"]={},r=0;r<t.attributes.length;r++)n=t.attributes.item(r),d["@attributes"][n.nodeName]=n.nodeValue}else 3===t.nodeType?d=t.nodeValue:t.nodeType||(d=t);if(t.hasChildNodes&&t.hasChildNodes())for(a=0;a<t.childNodes.length;a++){if(3===(o=t.childNodes.item(a)).nodeType)return o.nodeValue;void 0===d[i=o.nodeName]?d[i]=e.jgrid.odataHelper.convertXmlToJson(o):(void 0===d[i].push&&(l=d[i],d[i]=[],d[i].push(l)),d[i].push(e.jgrid.odataHelper.convertXmlToJson(o)))}return e.isEmptyObject(d)?null:d},parseMetadata:function(t,a){var r;switch(a){case"xml":r=function(t){var a={},r=[],n={},o=e("Schema",t).attr("Namespace")+".";return e("EntityContainer EntitySet",t).each(function(t,n){a[e(n).attr("EntityType").replace(o,"")]=e(n).attr("Name"),r.push(e(n).attr("Name"))}),e("EntityType, ComplexType",t).each(function(){var o,i,l,d,s,u,c,p,f;i=e(this).find("Property,NavigationProperty"),l=e("Key PropertyRef",this),d=l&&l.length>0?l.first().attr("Name"):"",p=e(this).attr("Name"),i&&(o=[],i.each(function(a,n){f={},e.each(n.attributes,function(){f[this.name]=this.value}),s=f.Name===d,c="NavigationProperty"===n.tagName,u="Property"===n.tagName&&e('ComplexType[Name="'+f.Name+'"]',t).length>0,o.push(e.extend({iskey:s,isComplex:u,isNavigation:c,isCollection:e.inArray(f.Name,r)>=0},f))}),a[p]&&(n[a[p]]=o),n[p]=o)}),n}(t);break;case"json":r=function(t){var a,r,n,o,i,l,d,s,u,c,p,f,m={},y={},g=[];for(l=0;l<t.EntityContainer.Elements.length;l++)y[t.EntityContainer.Elements[l].Type.ElementType.Definition.Name]=t.EntityContainer.Elements[l].Name,g.push(t.EntityContainer.Elements[l].Name);for(l=0;l<t.SchemaElements.length;l++)if(r=Array.prototype.concat(t.SchemaElements[l].DeclaredProperties,t.SchemaElements[l].NavigationProperties).filter(function(e){return!!e}),n=t.SchemaElements[l].DeclaredKey,o=n&&n.length>0?n[0].Name:"",f=t.SchemaElements[l].Name,r){for(a=[],d=0;d<r.length;d++)i=r[d].Name===o,c=r[d].Type.IsNullable,p=r[d].Type.Definition.Namespace+r[d].Type.Definition.Name,u=!(s=!!r[d].Type.Definition.DeclaredProperties)&&!r[d].Type,a.push({Name:r[d].Name,Type:p,Nullable:c,iskey:i,isComplex:s,isNavigation:u,isCollection:e.inArray(r[d].Name,g)>=0});y[f]&&(m[y[f]]=a),m[f]=a}return m}(t);break;case"datajs":r=function(t){var a,r,n,o,i,l,d,s,u,c,p,f,m={},y={},g=[],h=[],v=[],x=t.dataServices.schema[0],b=x.namespace+".";for(l=0;l<x.entityContainer[0].entitySet.length;l++)y[x.entityContainer[0].entitySet[l].entityType.replace(b,"")]=x.entityContainer[0].entitySet[l].name,g.push(x.entityContainer[0].entitySet[l].name);for(l=0;l<x.complexType.length;l++)v.push(x.complexType[l].name);for(h=Array.prototype.concat(x.entityType,x.complexType).filter(function(e){return!!e}),l=0;l<h.length;l++)if(r=Array.prototype.concat(h[l].property,h[l].navigationProperty).filter(function(e){return!!e}),n=h[l].key,o=n&&n.propertyRef.length>0?n.propertyRef[0].name:"",f=h[l].name,r){for(a=[],d=0;d<r.length;d++)i=r[d].name===o,c="false"!==r[d].nullable,p=r[d].type,s=!!r[d].type&&e.inArray(r[d].type.replace(b,""),v)>=0,u=!r[d].type,a.push({Name:r[d].name,Type:p,Nullable:c,iskey:i,isComplex:s,isNavigation:u,isCollection:e.inArray(r[d].name,g)>=0});y[f]&&(m[y[f]]=a),m[f]=a}return m}(t)}return r},loadError:function(t,a,r){var n=t.status,o=a,i=r;if(!t.responseJSON)if(t.responseXML)t.responseText=t.responseText.replace(/<(\/?)([^:>\s]*:)?([^>]+)>/g,"<$1$3>"),t.responseXML=e.parseXML(t.responseText),t.responseJSON=e.jgrid.odataHelper.convertXmlToJson(t.responseXML);else if(t.responseText)try{t.responseJSON=e.parseJSON(t.responseText)}catch(e){}if(t.responseJSON){var l=t.responseJSON["@odata.error"]||t.responseJSON["odata.error"]||t.responseJSON.error;l&&(l.innererror?l.innererror.internalexception?(o=l.innererror.internalexception.message,i=l.innererror.internalexception.stacktrace||""):(o=l.innererror.message,i=l.innererror.stacktrace||""):(o=l.message.value||l.message,i=l.stacktrace||""))}else r&&e.isPlainObject(r)&&(o=r.message,i=r.stack,n=r.code);return"<div>Status/error code: "+n+"</div><div>Message: "+o+'</div><div style="font-size: 0.8em;">'+i+"</div><br/>"}},e.jgrid.cmTemplate.odataComplexType={editable:!1,formatter:function(t,a,r){return e(this).jqGrid("odataJson",t,a,r)}},e.jgrid.cmTemplate.odataNavigationProperty={editable:!1,formatter:function(t,a,r){return a.colModel.odata.expand&&"link"!==a.colModel.odata.expand?"json"===a.colModel.odata.expand?e(this).jqGrid("odataJson",t,a,r):"subgrid"===a.colModel.odata.expand?e(this).jqGrid("odataSubgrid",t,a,r):void 0:e(this).jqGrid("odataLink",t,a,r)}},e.jgrid.cmTemplate["Edm.GeographyPoint"]={editable:!1,formatter:function(t,a,r){if(!t&&"xml"===this.p.datatype){var n=e(r).filter(function(){return this.localName.toLowerCase()===a.colModel.name.toLowerCase()});t=e.jgrid.odataHelper.convertXmlToJson(n[0])}return t.crs&&t.coordinates?e.jgrid.format("<div>{0}</div><div>[{1},{2}]</div>",t.crs.properties.name,t.coordinates[0],t.coordinates[1]):e.jgrid.format("<div>{0}</div>",t)}},e.jgrid.extend({odataLink:function(t,a,r){var n,o=this[0].p;if("xml"!==o.datatype){if(r[a.colModel.name+"@odata.navigationLink"])return n=r[a.colModel.name+"@odata.navigationLink"],e.jgrid.format('<a href="{0}/{1}" target="_self">{2}</a>',o.odata.baseUrl,n,a.colModel.name);n=r[o.jsonReader.id]}else n=function(t){return e(r).filter(function(){return this.localName&&this.localName.toLowerCase()===t}).text()}(o.xmlReader.id.toLowerCase());return o.odata.iscollection?e.jgrid.format('<a href="{0}({1})/{2}" target="_self">{2}</a>',o.url,n,a.colModel.name):e.jgrid.format('<a href="{0}/{1}" target="_self">{1}</a>',o.url,a.colModel.name)},odataJson:function(t,a,r){var n,o={};if("xml"===this[0].p.datatype){var i=e(r).filter(function(){return this.localName.toLowerCase()===a.colModel.name.toLowerCase()});t=e.jgrid.odataHelper.convertXmlToJson(i[0])}for(n in t)t.hasOwnProperty(n)&&n&&n.indexOf("@odata.")<0&&n.indexOf("@attributes")<0&&(o[n]=t[n]);return JSON.stringify(o,null,1)},odataSubgrid:function(t,a,r){var n,o,i,l=this[0].p;o="xml"!==l.datatype?r[l.jsonReader.id]:function(t){return e(r).filter(function(){return this.localName&&this.localName.toLowerCase()===t}).text()}(l.xmlReader.id.toLowerCase());for(n in l._index)if(l._index.hasOwnProperty(n)&&n&&o===l._index[n].toString()){o=n;break}return i='<a style="cursor:pointer" data-id="{0}" onclick=\'$("#{2}").jqGrid("setGridParam", { odata: {activeEntitySet: "{1}" } });$("#{2}").jqGrid("expandSubGridRow", "{0}");return false;\'>{1}</a>',i=e.jgrid.format(i,o,a.colModel.name,a.gid)},parseColumns:function(t,a){var r,n,o,i,l,d,s,u,c=0,p=[];for(c=0;c<t.length;c++)r="Edm.Int16,Edm.Int32,Edm.Int64".indexOf(t[c].Type)>=0,n="Edm.Decimal,Edm.Double,Edm.Single".indexOf(t[c].Type)>=0,i="Edm.Byte,Edm.SByte".indexOf(t[c].Type)>=0,o=t[c].Type&&t[c].Type.indexOf("Edm.")>=0&&(t[c].Type.indexOf("Date")>=0||t[c].Type.indexOf("Time")>=0),l=e.jgrid.cmTemplate[t[c].Type]?t[c].Type:t[c].isComplex?"odataComplexType":t[c].isNavigation?"odataNavigationProperty":r?"integerStr":n?"numberStr":i?"booleanCheckbox":"text",d={integer:r,number:n,date:o,required:!t[c].Nullable||"false"===t[c].Nullable},s=r?"integer":n?"number":o?"datetime":i?"checkbox":"text",u=t[c].isNavigation||t[c].isComplex?'<span class="ui-icon ui-icon-arrowreturn-1-s" style="display:inline-block;vertical-align:middle;"></span>'+t[c].Name:t[c].Name,p.push(e.extend({label:u,name:t[c].Name,index:t[c].Name,editable:!t[c].isNavigation&&!t[c].iskey,searchrules:d,editrules:d,searchtype:s,inputtype:s,edittype:s,key:t[c].iskey,odata:{expand:t[c].isNavigation?a:t[c].isComplex?"json":null,isnavigation:t[c].isNavigation,iscomplex:t[c].isComplex,iscollection:t[c].isCollection}},e.jgrid.cmTemplate[l]));return p},odataInit:function(t){function a(t,a,r,n){var o,i;if(a&&(r||"nu"===n||"nn"===n)){if(r)for(o=0;o<t.colModel.length;o++)if((i=t.colModel[o]).name===a){if(i.odata.nosearch)return;if(i.odata.unformat&&!(a=e.isFunction(i.odata.unformat)?i.odata.unformat(a,r,n):i.odata.unformat))return;i.searchrules&&(i.searchrules.integer||i.searchrules.number||i.searchrules.date)?i.searchrules&&i.searchrules.date&&(r=new Date(r).toISOString()):r="'"+r+"'";break}switch(n){case"in":case"cn":return"indexof("+a+",tolower("+r+")) gt -1";case"ni":case"nc":return"indexof("+a+",tolower("+r+")) eq -1";case"bw":return"startswith("+a+","+r+") eq true";case"bn":return"startswith("+a+","+r+") eq false";case"ew":return"endswith("+a+","+r+") eq true";case"en":return"endswith("+a+","+r+") eq false";case"nu":return a+" eq null";case"nn":return a+" ne null";default:return a+" "+n+" "+r}}}function r(e,t){var n,o,i,l="";if(e.groups&&e.groups.length){for(n=0;n<e.groups.length;n++)l+="("+r(e.groups[n],t)+")",n<e.groups.length-1&&(l+=" "+e.groupOp.toLowerCase()+" ");e.rules&&e.rules.length&&(l+=" "+e.groupOp.toLowerCase()+" ")}if(e.rules.length)for(n=0;n<e.rules.length;n++)(i=a(t,(o=e.rules[n]).field,o.data,o.op))&&(l+=i+" "+e.groupOp.toLowerCase()+" ");return l=l.trim().replace(/\s(and|or)$/,"").trim()}function n(t,n,o){var i={};if(!t.odata.iscollection)return!n.version||n.version<4?i.$format="xml"===n.datatype?"atom":"application/json;odata=fullmetadata":i.$format="xml"===n.datatype?"atom":"application/json;odata.metadata=full",i;if(i={$top:o.rows,$skip:(parseInt(o.page,10)-1)*t.rowNum},"jsonp"===n.datatype&&(i.$callback=n.callback),!n.version||n.version<4?(i.$inlinecount="allpages",i.$format="xml"===n.datatype?"atom":"application/json;odata=fullmetadata"):(i.$count=!0,i.$format="xml"===n.datatype?"atom":"application/json;odata.metadata=full"),o.sidx&&(i.$orderby=o.sidx+" "+o.sord),!o._search)return i;if(o.filters){var l=r(e.parseJSON(o.filters),t);l.length>0&&(i.$filter=l)}else i.$filter=a(t,o.searchField,o.searchString,o.searchOper);return i}function o(t,a,r,n){var o,i=t.colModel.filter(function(e){return e.name===t.odata.activeEntitySet})[0];n=t._index[n],o=t.odata.iscollection?e.jgrid.format("{0}({1})/{2}",t.url,n,t.odata.activeEntitySet):e.jgrid.format("{0}/{1}",t.url,t.odata.activeEntitySet);var l={datatype:a.datatype,version:a.version,gencolumns:!1,expandable:a.expandable,odataurl:o,errorfunc:a.errorfunc,annotations:a.annotations,entitySet:t.odata.activeEntitySet};e("#"+r).html('<table id="'+r+'_t" class="scroll"></table>'),e("#"+r+"_t").jqGrid({colModel:t.odata.subgridCols[t.odata.activeEntitySet],odata:e.extend({},t.odata,i.odata),loadonce:!0,beforeInitGrid:function(){e(this).jqGrid("odataInit",l)},loadError:function(t,a,r){var n=e.jgrid.odataHelper.loadError(t,a,r);n=e("#errdialog").html()+n,e("#errdialog").html(n).dialog("open")}})}function i(t,a){var r,i={datatype:a.datatype,jsonpCallback:a.callback};if(t.odata||(t.odata={iscollection:!0}),e.extend(t,{serializeGridData:function(e){return e=n(t,a,e),this.p.odata.postData=e,e},ajaxGridOptions:i,mtype:"GET",url:a.odataurl},i),t.colModel)for(r=0;r<t.colModel.length;r++)if(t.colModel[r].odata&&"subgrid"===t.colModel[r].odata.expand){t.subGrid=!0,t.subGridRowExpanded=function(e,r){return o(t,a,e,r)},t.odata.activeEntitySet=t.colModel[r].name,t.loadonce=!0;break}var l={contentType:"application/"+("jsonp"===a.datatype?"json":a.datatype)+";charset=utf-8",datatype:"jsonp"===a.datatype?"json":a.datatype};t.inlineEditing=e.extend(!0,{beforeSaveRow:function(e,t){return"edit"===e.extraparam.oper?(e.url=a.odataurl,e.mtype=a.odataverbs.inlineEditingEdit,e.url+="("+t+")"):(e.url=a.odataurl,e.mtype=a.odataverbs.inlineEditingAdd),!0},serializeSaveData:function(e){return JSON.stringify(e)},ajaxSaveOptions:l},t.inlineEditing||{}),e.extend(t.formEditing,{onclickSubmit:function(e,r,n){return"add"===n?(e.url=a.odataurl,e.mtype=a.odataverbs.formEditingAdd):"edit"===n&&(e.url=a.odataurl+"("+r[t.id+"_id"]+")",e.mtype=a.odataverbs.formEditingEdit),r},ajaxEditOptions:l,serializeEditData:function(e){return JSON.stringify(e)}}),e.extend(t.formDeleting,{url:a.odataurl,mtype:"DELETE",serializeDelData:function(){return""},onclickSubmit:function(e,t){return e.url+="("+t+")",""},ajaxDelOptions:l});var d=t.colModel.filter(function(e){return!!e.key})[0];if(d=d?d.name:t.sortname||"id","xml"===a.datatype){a.annotations&&e.extend(!0,t,{loadBeforeSend:function(e){e.setRequestHeader("Prefer",'odata.include-annotations="*"')}});e.extend(!0,t,{xmlReader:{root:function(a){(a=a.childNodes[0]).innerHTML=a.innerHTML.replace(/<(\/?)([^:>\s]*:)?([^>]+)>/g,"<$1$3>");var r=e(a).attr("m:context");return r&&(t.odata.baseUrl=r.substring(0,r.indexOf("/$metadata")),t.odata.entityType=r.substring(r.indexOf("#")+1).replace("/$entity","")),(r=e(a).attr("m:type"))&&(t.odata.entityType=r.replace("#","")),a},row:function(t){return t="entry"===t.localName?[t]:e(">entry",t)},cell:function(t){return e(">content>properties",t).get(0).childNodes},records:function(t){return e(">feed>entry",t).length},page:function(){var e=t.odata.postData.$skip+t.rowNum;return Math.ceil(e/t.rowNum)},total:function(a){var r=e(">feed>entry",a).length,n=t.odata.postData.$skip+t.rowNum;return Math.ceil(n/t.rowNum)+(r>0?1:0)},repeatitems:!0,userdata:"userdata",id:d}})}else e.extend(!0,t,{jsonReader:{root:function(e){var a=e["@odata.context"];return a&&(t.odata.baseUrl=a.substring(0,a.indexOf("/$metadata")),t.odata.entityType=a.substring(a.indexOf("#")+1).replace("/$entity","")),(a=e["@odata.type"])&&(t.odata.entityType=a.replace("#","")),e.value||[e]},repeatitems:!0,id:d}}),a.annotations?e.extend(!0,t,{loadBeforeSend:function(e){e.setRequestHeader("Prefer",'odata.include-annotations="*"')},jsonReader:{records:function(e){return e[a.annotationName].records},page:function(e){return e[a.annotationName].page},total:function(e){return e[a.annotationName].total},userdata:function(e){return e[a.annotationName].userdata}}}):e.extend(!0,t,{jsonReader:{records:function(e){return e["odata.count"]||e["@odata.count"]},page:function(e){var a;if(e["odata.nextLink"])a=parseInt(e["odata.nextLink"].split("skip=")[1],10);else{a=t.odata.postData.$skip+t.rowNum;var r=e["odata.count"]||e["@odata.count"];a>r&&(a=r)}return Math.ceil(a/t.rowNum)},total:function(e){var a=e["odata.count"]||e["@odata.count"];return Math.ceil(a/t.rowNum)},userdata:"userdata"}})}return this.each(function(){var a=this,r=e(this),n=this.p;if(a.grid&&n){var o=e.extend(!0,{gencolumns:!1,odataurl:n.url,datatype:"json",entitySet:null,annotations:!1,annotationName:"@jqgrid.GridModelAnnotate",odataverbs:{inlineEditingAdd:"POST",inlineEditingEdit:"PATCH",formEditingAdd:"POST",formEditingEdit:"PUT"}},t||{});if("jsonp"===o.datatype&&(o.callback="jsonpCallback"),o.entitySet){if(o.gencolumns){var l=e.extend(!0,{parsecolfunc:null,parsemetadatafunc:null,successfunc:null,errorfunc:null,async:!1,entitySet:null,metadatatype:t.datatype||"xml",metadataurl:(t.odataurl||n.url)+"/$metadata"},t||{});l.async&&(l.successfunc=function(){a.grid.hDiv&&(a.grid.hDiv.loading=!1),r.jqGrid("setGridParam",{datatype:o.datatype}).trigger("reloadGrid")},a.grid.hDiv&&(a.grid.hDiv.loading=!0)),r.jqGrid("odataGenColModel",l)}i(n,o)}else e.isFunction(o.errorfunc)&&o.errorfunc({},"entitySet cannot be empty",0)}})},odataGenColModel:function(t){var a,r,n=this[0],o=n.p,i=e(n),l=e.extend(!0,{parsecolfunc:null,parsemetadatafunc:null,successfunc:null,errorfunc:null,entitySet:null,metadataurl:o.url+"/$metadata",metadatatype:"xml",expandable:"link",async:!1},t||{});if("jsonp"===l.metadatatype&&(l.callback="jsonpCallback"),l.entitySet)return e.ajax({url:l.metadataurl,type:"GET",dataType:l.metadatatype,jsonpCallback:l.callback,async:l.async,cache:!1}).done(function(t,n,d){var s=0,u=0,c=0;if("json"!==l.metadatatype&&"jsonp"!==l.metadatatype||(t=e.jgrid.odataHelper.resolveJsonReferences(t)),!(a=i.triggerHandler("jqGridODataParseMetadata",t))&&e.isFunction(l.parsemetadatafunc)&&(a=l.parsemetadatafunc(t,n,d)),a)r=a;else if((a=e.jgrid.odataHelper.parseMetadata(t,l.metadatatype))&&(!(r=i.triggerHandler("jqGridODataParseColumns",[l,a]))&&e.isFunction(l.parsecolfunc)&&(r=l.parsecolfunc(l,a)),!r)){r={};for(s in a)a.hasOwnProperty(s)&&s&&(r[s]=i.jqGrid("parseColumns",a[s],l.expandable))}if(r){for(c in r)if(r.hasOwnProperty(c)&&c)for(s=0;s<o.colModel.length;s++)for(u=0;u<r[c].length;u++)if(r[c][u].name===o.colModel[s].name){e.extend(!0,r[c][u],o.colModel[s]);break}o.colModel=r[l.entitySet],o.colModel||e.isFunction(l.errorfunc)&&l.errorfunc({data:t,status:n,xhr:d},"EntitySet "+l.entitySet+" is not found"),o.odata||(o.odata={iscollection:!0}),o.odata.subgridCols=r,e.isFunction(l.successfunc)&&l.successfunc()}else e.isFunction(l.errorfunc)&&l.errorfunc({data:t,status:n,xhr:d},"parse $metadata error")}).fail(function(t,a,r){if(e.isFunction(l.errorfunc)){var n=e.jgrid.odataHelper.loadError(t,a,r);l.errorfunc({xhr:t,error:a,code:r},n)}}),r;e.isFunction(l.errorfunc)&&l.errorfunc({},"entitySet cannot be empty",0)}})});
//# sourceMappingURL=grid.odata.js.map