{% extends "uicore/page/base.html" %}
{% load ui_help %}
{% load js_tags %}
{% load ui_menu_bars %}
{% load tz %}
{% block title %}{{ accession }}{% endblock title %}
{% block submenu %}{% menu_bar_data %}{% endblock %}
{% block content %}
<div class="container">
    <h3>Transcript Version {{ accession }}</h3> 
    
    <p>
    Back to <a class="hover-link" href="{% url 'view_transcript' transcript.pk %}">{{ transcript }}</a> ({{ version_count }} versions)
    </p>

    {% if transcript.annotation_consortium == 'R' %}
        {% page_help 'genes/transcript_version_refseq' 'RefSeq transcript versions' %}
    {% endif %}
    {% if transcript.annotation_consortium == 'E' %}
        {% page_help 'genes/transcript_version_ensembl' 'Ensembl transcript versions' %}
    {% endif %}

    {% if tv_sequence_info %}
        <table class="table">
            <thead>
            <tr>
                <th>Source</th>
                <th>Retrieval Date</th>
                <th>Length</th>
            </tr>
            </thead>
            <tr>
                <td>
                    {% if tv_sequence_info.fasta_import %}
                        Imported via {{ tv_sequence_info.fasta_import }} on {{ tv_sequence_info.fasta_import.created|localtime }}
                    {% else %}
                        Retrieved from {{ transcript.get_annotation_consortium_display }} API
                    {% endif %}
                </td>
                <td>{{ tv_sequence_info.created|localtime }}</td>
                <td>{{ tv_sequence_info.length }}</td>
            </tr>
        </table>
    {% else %}
        <ul class="messages">
            <li class="warning">
                Could not retrieve transcript sequence information from {{ transcript.get_annotation_consortium_display }} API
                {% if no_transcript_message %}
                    {{ no_transcript_message }}
                {% endif %}
            </li>
        </ul>
    {% endif %}

    {% if transcript_versions_by_build %}
        <table class="table">
            <thead>
            <tr>
                <th>Genome Build</th>
                <th>Gene</th>
                <th>BioType</th>
                <th>Alignment Gap</th>
                <th>Coordinates</th>
                <th>Length</th>
                <th>JSON</th>
                {% if user.is_staff %}
                    <th>Import Filename</th>
                {% endif %}
                <th>External Link</th>
            </tr>
            </thead>
        {% for genome_build_id, transcript_version in transcript_versions_by_build.items %}
            <tr>
                <td>{{ genome_build_id }}</td>
                <td><a class="hover-link" href="{% url 'view_gene' transcript_version.gene.pk %}">{{ transcript_version.gene }}</a></td>
                <td>{{ transcript_version.biotype }}</td>
                <td>{{ transcript_version.alignment_gap }}</td>
                {% if transcript_version.has_valid_data %}
                    <td>{{ transcript_version.coordinates }}</td>
                    <td>{{ transcript_version.length }}</td>
                    <td><a class="hover-link" href="#transcript-{{ transcript_version.pk }}-json" data-toggle="modal">Show</a>
                        <div id="transcript-{{ transcript_version.pk }}-json" class="modal" tabindex="-1">
                            <div class="modal-dialog modal-dialog-scrollable modal-xl">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">API Response</h5>
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                          <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                    {% code_json transcript_version.data css_class="modal-body" %}
                                </div>
                            </div>
                        </div>
                    </td>
                {% else %}
                    <td> N/A</td>
                    <td> N/A</td>
                    <td> <code>{}</code></td>
                {% endif %}
                {% if user.is_staff %}
                    <td>{{ transcript_version.import_source }}</td>
                {% endif %}
                <td><a class="hover-link external-link" target="_blank" href="{{ transcript_version.get_external_url }}">
                        {{ transcript.get_annotation_consortium_display }} page.
                    </a>
                </td>
            </tr>
        {% endfor %}
        </table>
    {% else %}
    <div class="alert alert-danger">We don't have any data for this transcript version on file.</div>
    {% endif %}

    {% if alignment_gap %}
        <h3>Alignment Gap</h3>
        <p>
            Genomic coordinates for transcript exons/CDS etc are made by aligning cDNA sequences to the genome.
            These sequences are not identical and the alignment may have gaps.
            These are detected by the GFF/GTF containing a "gap_count" attribute, or the cDNA transcript length
            from Fasta or retrieved from API having a different length than the sum of exons lengths in the alignment.
        </p>
        <p>
            When a TranscriptVersion has an alignment gap, we can't use the genome to convert to/from HGVS, and so use ClinGen Allele Registry.
            This will make conversion slower for these transcripts.
        </p>

    {% endif %}

    {% if differences %}
        <h3>Potential Differences</h3>
        
        <ul class="messages">
            <li class="warning">
                Transcripts differ between genome versions, which may affect HGVS coordinates between builds
            </li>
        </ul>        

        {% for builds, diff in differences %}
            
            <table class="table">
                <thead>
                <tr>
                    <th>
                    <th>{{ builds.0 }}
                    <th>{{ builds.1 }}
                </tr>
                </thead>
                {% for d, vals in diff.items %}
                <tr>
                    <th>{{ d }}
                    <td>{{ vals.0 }}
                    <td>{{ vals.1 }}
                </tr>
                {% endfor %}
            </table>
        {% endfor %}
    {% endif %}

</div>
{% endblock content %}