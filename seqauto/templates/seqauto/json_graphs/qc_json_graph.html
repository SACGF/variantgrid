{% load static %}
{% load js_tags %}
<script type="text/javascript" src="{% static 'js/lib/plotly-latest.min.js' %}"></script>
<script>
	var qc_data = {{ qc_data | jsonify }};
	var current_label = "{{ current_label }}";
    var label_column = "{{ label_column }}";
    var gold_column = "{{ gold_column }}";

	function createBar(name, color) {
		return {x : [], y: [], type: 'bar', name: name, marker: { color: color} };
	}

	function plotColumn() {
		var column = $('option:selected',this).attr('value');
		var labels = qc_data[label_column];
		var is_gold = qc_data[gold_column];
		var column_data = qc_data[column];

		var gold = createBar("gold", "rgb(255,215,0)");
		var active = createBar("current", 'rgba(222,45,38,0.8)');
		var other = createBar("other", 'rgba(204,204,204,0.8)');

		for (var i=0 ; i<labels.length ; ++i) {
			var label = labels[i];
			// JSON can't handle newlines, so had to escape them 
			label = label.replace("__newline__", "\n");

            /*  Issue #701 - Sort bar by date.
                We need to put labels/data (NaN is invisible) in all categories so that they are sorted together.
                See https://community.plot.ly/t/how-to-sort-bars-in-a-bar-chart/274/2 */

            gold['x'].push(label);
            active['x'].push(label);
            other['x'].push(label);

            var gold_data = NaN;
            var active_data = NaN;
            var other_data = NaN;

			if (label == current_label) {
                active_data = column_data[i];
			} else if (is_gold[i]) {
                gold_data = column_data[i];
			} else {
                other_data = column_data[i];
			}

            gold['y'].push(gold_data);
            active['y'].push(active_data);
            other['y'].push(other_data);
		}

		var data = [gold, active, other];

		var layout = {
		  	title: column,
		    paper_bgcolor: 'rgba(0,0,0,0)',
		    plot_bgcolor: 'rgba(0,0,0,0)'
		};
		
		Plotly.newPlot('plotly-graph-container', data, layout);
	}
	
	$(document).ready(function() {
		$("select#id_column").change(plotColumn);
		$("select#id_column").each(plotColumn); // initial plot
	});

</script>

<div id='plotly-graph-container'></div>