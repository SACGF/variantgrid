{% extends menu_data_base %}
{% load static %}
{% load related_data_tags %}
{% load related_analyses_tags %}
{% load help_tags %}
{% load js_tags %}
{% load vcf_import_info_tags %}

{% block title %}{{ sample.name }}{% endblock %}
{% block head %}
<style>
	hr {
		width: 80%;
		margin-top: 20px;
		margin-bottom: 20px;
	}

	#sample-stats {
		margin-bottom: 20px;
	}

    #sample-grid-container {
        width: 100%;
    }

    #bam-files-path-container > * {
        float: left;
    }

    #bam-files-path-container .igv-link-container > * {
        float: left;
    }

</style>
<script>
function getBams() {
    var bams = [];
    var bamFilePath = $("#id_bam_file_path").val();
    if (bamFilePath) {
        bams.push(bamFilePath);
    }
    return bams;
}

window.ANALYSIS_SETTINGS = {
    show_igv_links : true,
    igv_data : {{ igv_data | jsonify }},
    open_variant_details_in_new_window: true,
};

function setPatientLink() {
    var patientSelector = $("#id_patient");
    patientSelector.parent().append("<a class='cross-link' id='patient-link'>View Patient</a>");
    function mySetPatientLink() {
        var pk = patientSelector.find(":selected").val();
        setCrossLink($("#patient-link"), Urls.view_patient, pk);
    }
    mySetPatientLink();
    patientSelector.change(mySetPatientLink);
}


function setIGVLink() {
    console.log("setIGVLink");
    var bfpl = $("<span id='bam-files-path-container'></span>");
    var bamFilePathSelector = $("#id_bam_file_path");
    var parentContainer = bamFilePathSelector.parent();
    var kids = parentContainer.children();
    kids.each(function() {
        $(this).appendTo(bfpl);
    });
    parentContainer.append(bfpl);
    bfpl.append("<div id='igv-link-container'></div>");
    parentContainer.append("<div class='clear'></div>");

    function setBamFilesPathLink() {
        var lc = $("#igv-link-container");
        lc.empty();
        if (bamFilePathSelector.val()) {
            var igvLinkHMTL = create_igv_link('', 'getBams');
            lc.append(igvLinkHMTL);
            $('.igv-link-container', bfpl).append("<div>Open BAM in IGV</div>");
        }
    }
    setBamFilesPathLink();
    bamFilePathSelector.change(setBamFilesPathLink);
}
</script>
<script src="{% static 'js/lib/free-jqgrid/jquery.jqgrid.min.js' %}"></script>
<script type="text/javascript" src="{% static 'js/grid.js' %}"></script>
<link rel="stylesheet" type="text/css" media="screen" href="{% static 'js/lib/free-jqgrid/css/ui.jqgrid.min.css' %}" />
{% endblock %}

{% block jsdocumentready %}
    setPatientLink();
    setIGVLink();

    $("#sample-tabs").tabs();
    
    var sampleForm = $("#sample-form");
    var patientSelect = $("#id_patient", sampleForm);
    patientSelect.change(function() {
        let specimenSelect = $("#id_specimen", sampleForm);
        clearAutocompleteChoice(specimenSelect);
    });
    var dialog = setupCreatePatientDialog();
    var sampleName = $("#id_name").val();
    addCreatePatientButton(dialog, patientSelect, sampleName);

    
{% endblock %}

{% block submenu_page_content %}

<div id="sample">
    {% load vcf_history_trail_tags %}
    {% vcf_history_trail sample.vcf %}

    <div id="sample-tabs">
    <ul>
        <li><a href="#details">Details</a></li>
        {% if sample.samplestats.import_status == 'S' %}
        <li><a href="#sample-stats">Stats</a></li>
        <li><a href="{% url 'sample_variants_tab' sample.pk %}">Variants</a></li>
        {% endif %}
        {% if sample.import_status == 'S' or sample.import_status == 'A' %}
        <li><a href="{% url 'sample_graphs_tab' sample.pk %}">Graphs</a></li>
        {% endif %}
        {% if sample.qc_gene_list and url_name_visible.view_qc_gene_list_tab %}
        <li><a href="{% url 'view_qc_gene_list_tab' sample.qc.pk %}">Genes of Interest</a></li>
        {% endif %}
        {% if sample.sequencing_run and url_name_visible.view_sample_qc_tab %}
        <li><a href="{% url 'view_sample_qc_tab' sample.pk %}">QC</a></li>
        {% endif %}
        {% if has_write_permission %}
        <li><a href="{% url 'sample_permissions_tab' sample.pk %}">Sharing / Permissions</a></li>
        {% endif %}
    </ul>
    <div id="details">
	    {% page_help user 'data/view_sample_help' 'Sample Help' %}

    	<form method="post" id='sample-form'>
    		{% csrf_token %}
            <p>
                <label for="id_genome_build">Genome build:</label>
                <span id='id_genome_build'> {{ sample.vcf.genome_build }}</span>
            </p>
    		{{ form.as_p }}
    		{% if has_write_permission %}
    			<button id='save-sample' class="btn btn-primary">save</button>
    		{% else %}
    			You can view but not modify this data.
    		{% endif %}
    		{% include "messages/messages.html" %}
            {% vcf_import_info sample.vcf 'Please click the VCF icon at the top of the page, then the "View upload processing" link.' %}

            {{ form.media }}
    	</form>
    </div>
    {% if sample.samplestats.import_status == 'S' %}
    <div id="sample-stats">
		<table>
		<tr><th> <th> <th> Total %
			{% if sample.samplestatspassingfilter %}
			<th> (Pass Filters) </tr>
			{% endif %}
		<tr><th>Total
			<td> {{ sample.samplestats.total_count }}
			<td>100.0
			{% if sample.samplestatspassingfilter %}
			<td>({{ sample.samplestatspassingfilter.total_count }})
			{% endif %}
		<tr><td>&nbsp;</td>
		<tr><th>SNPs		<td>{{ sample.samplestats.snp_count }}
							<td>{{ sample.samplestats.snp_percent | floatformat }}
							{% if sample.samplestatspassingfilter %}
							<td>({{ sample.samplestatspassingfilter.snp_count }})
							{% endif %}
		<tr><th>Insertions	<td>{{ sample.samplestats.insertions_count }}
							<td>{{ sample.samplestats.insertions_percent | floatformat }}
							{% if sample.samplestatspassingfilter %}
							<td>({{ sample.samplestatspassingfilter.insertions_count }})
							{% endif %}
		<tr><th>Deletions	<td>{{ sample.samplestats.deletions_count }}
							<td>{{ sample.samplestats.deletions_percent | floatformat }}
							{% if sample.samplestatspassingfilter %}
							<td>({{ sample.samplestatspassingfilter.deletions_count }})
							{% endif %}
		</table>

        <h3>Zygosity</h3>
		<table>
		<tr><td>      <th>Count
                                {% if sample.samplestatspassingfilter %}
                                <th> (Pass Filters) </tr>
                                {% endif %}
		<tr><th>Ref           <td>{{ sample.samplestats.ref_count }}
                                {% if sample.samplestatspassingfilter %}
                                <td>({{ sample.samplestatspassingfilter.ref_count }})
                                {% endif %}
		<tr><th>Het	          <td>{{ sample.samplestats.het_count }}
                                {% if sample.samplestatspassingfilter %}
                                <td>({{ sample.samplestatspassingfilter.het_count }})
                                {% endif %}
		<tr><th>Hom           <td>{{ sample.samplestats.hom_count }}
                                {% if sample.samplestatspassingfilter %}
                                <td>({{ sample.samplestatspassingfilter.hom_count }})
                                {% endif %}
        <tr><th>Unk           <td>{{ sample.samplestats.unk_count }}
                                {% if sample.samplestatspassingfilter %}
                                <td>({{ sample.samplestatspassingfilter.unk_count }})
                                {% endif %}
		</table>
		
		{% if sample_locus_count %}
            <h3>Ploidy</h3>
            <table>
                <tr><th>Locus Count <th> Count
                {% for slc in sample_locus_count %}
                    <tr><td>{{ slc.locus_count }}
                            {% if slc.locus_count == 1 %}
                                (HOM)
                            {% elif slc.locus_count == 2 %}
                                (HET)
                            {% endif %}
                        <td>{{ slc.count }} 
                {% endfor %}
            </table>
            </p>
		{% endif %}
		
		{% if sex_guess %}
		<h3>Sex</h3>
		{{ sample.samplestats.chrx_sex_guess }} (chrX Hom: {{ sample.samplestats.x_hom_count }}, Het: {{ sample.samplestats.x_het_count }})
        {% endif %}
    </div>
	{% endif %}
 
    {% related_data_for_samples samples show_sample_info=False %}
    {% related_analyses_for_samples samples show_sample_info=False %}

    </div>
<div id="error-dialog" class="no-close" title="Error">
</div>
</div>

{% include "snpdb/create_patient_dialog.html" %}

{% endblock %}
