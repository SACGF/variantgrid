{% extends menu_data_base %}
{% load static %}
{% load related_data_tags %}
{% load related_analyses_tags %}
{% load help_tags %}
{% load js_tags %}
{% load vcf_import_info_tags %}
{% load tz %}

{% block title %}{{ sample.name }}{% endblock %}
{% block head %}
<style>
	hr {
		width: 80%;
		margin-top: 20px;
		margin-bottom: 20px;
	}

	#sample-stats {
		margin-bottom: 20px;
	}

    #sample-grid-container {
        width: 100%;
    }

    #bam-files-path-container > * {
        float: left;
    }

    #bam-files-path-container .igv-link-container > * {
        float: left;
    }

    .sample-gene-list-link div {
        margin-left: 2px;
    }

</style>
<script>
function getBams() {
    var bams = [];
    var bamFilePath = $("#id_bam_file_path").val();
    if (bamFilePath) {
        bams.push(bamFilePath);
    }
    return bams;
}

window.ANALYSIS_SETTINGS = {
    show_igv_links : true,
    igv_data : {{ igv_data | jsonify }},
    open_variant_details_in_new_window: true,
};

function setPatientLink() {
    var patientSelector = $("#id_patient");
    patientSelector.parent().append("<a class='cross-link' id='patient-link'>View Patient</a>");
    function mySetPatientLink() {
        var pk = patientSelector.find(":selected").val();
        setCrossLink($("#patient-link"), Urls.view_patient, pk);
    }
    mySetPatientLink();
    patientSelector.change(mySetPatientLink);
}


function setIGVLink() {
    var bfpl = $("<span id='bam-files-path-container'></span>");
    var bamFilePathSelector = $("#id_bam_file_path");
    var parentContainer = bamFilePathSelector.parent();
    var kids = parentContainer.children();
    kids.each(function() {
        $(this).appendTo(bfpl);
    });
    parentContainer.append(bfpl);
    bfpl.append("<div id='igv-link-container'></div>");
    parentContainer.append("<div class='clear'></div>");

    function setBamFilesPathLink() {
        var lc = $("#igv-link-container");
        lc.empty();
        if (bamFilePathSelector.val()) {
            var igvLinkHMTL = create_igv_link('', 'getBams');
            lc.append(igvLinkHMTL);
            $('.igv-link-container', bfpl).append("<div>Open BAM in IGV</div>");
        }
    }
    setBamFilesPathLink();
    bamFilePathSelector.change(setBamFilesPathLink);
}

$(document).ready(function() {
    setPatientLink();
    setIGVLink();

    $("#sample-tabs").tabs();

    var sampleForm = $("#sample-form");
    var patientSelect = $("#id_patient", sampleForm);
    patientSelect.change(function() {
        let specimenSelect = $("#id_specimen", sampleForm);
        clearAutocompleteChoice(specimenSelect);
    });
    var dialog = setupCreatePatientDialog();
    var sampleName = $("#id_name").val();
    addCreatePatientButton(dialog, patientSelect, sampleName);
});
</script>
<script src="{% static 'js/lib/free-jqgrid/jquery.jqgrid.min.js' %}"></script>
<script type="text/javascript" src="{% static 'js/grid.js' %}"></script>
<link rel="stylesheet" type="text/css" media="screen" href="{% static 'js/lib/free-jqgrid/css/ui.jqgrid.min.css' %}" />
{% endblock %}

{% block submenu_page_content %}

<div id="sample">
    {% load vcf_history_trail_tags %}
    {% vcf_history_trail sample.vcf %}

    <div id="sample-tabs">
    <ul>
        <li><a href="#details">Details</a></li>
        {% if sample.samplestats.import_status == 'S' %}
        <li><a href="#sample-stats">Stats</a></li>
        {% if somalier_enabled and sample.somaliersampleextract.somalierancestry %}
            <li><a href="#sample-ancestry">Ancestry</a></li>
        {% endif %}
        <li><a href="{% url 'sample_variants_tab' sample.pk %}">Variants</a></li>
        {% endif %}
        {% if sample.import_status == 'S' or sample.import_status == 'A' %}
        <li><a href="{% url 'sample_graphs_tab' sample.pk %}">Graphs</a></li>
        {% endif %}
        {% if url_name_visible.sample_gene_lists_tab %}
        <li>
            <a class="sample-gene-list-link" href="{% url 'sample_gene_lists_tab' sample.pk %}">
                <div class="left">Genes of Interest</div>
                {% if sample.activesamplegenelist %}
                <div title="Active GeneList" class="left icon16 check-mark-green"></div>
                {% endif %}
                <div class="left">({{ sample.samplegenelist_set.count }})</div>
            </a>
        </li>
        {% endif %}
        {% if sample.sequencing_run and url_name_visible.view_sample_qc_tab %}
        <li><a href="{% url 'view_sample_qc_tab' sample.pk %}">QC</a></li>
        {% endif %}
        {% if has_write_permission %}
        <li><a href="{% url 'sample_permissions_tab' sample.pk %}">Sharing / Permissions</a></li>
        {% endif %}
    </ul>
    <div id="details">
	    {% page_help user 'data/view_sample_help' 'Sample Help' %}

    	<form method="post" id='sample-form'>
    		{% csrf_token %}
            <p>
                <label for="id_genome_build">Genome build:</label>
                <span id='id_genome_build'> {{ sample.vcf.genome_build }}</span>
            </p>
    		{{ form.as_p }}
    		{% if has_write_permission %}
    			<button id='save-sample' class="btn btn-primary">save</button>
    		{% else %}
    			You can view but not modify this data.
    		{% endif %}
    		{% include "messages/messages.html" %}
            {% vcf_import_info sample.vcf 'Please click the VCF icon at the top of the page, then the "View upload processing" link.' %}

            {{ form.media }}
    	</form>
    </div>
    {% if sample.samplestats.import_status == 'S' %}
    <div id="sample-stats">
		<table>
		<tr><th> <th> <th> Total %
			{% if sample.samplestatspassingfilter %}
			<th> (Pass Filters) </tr>
			{% endif %}
		<tr><th>Total
			<td> {{ sample.samplestats.total_count }}
			<td>100.0
			{% if sample.samplestatspassingfilter %}
			<td>({{ sample.samplestatspassingfilter.total_count }})
			{% endif %}
		<tr><td>&nbsp;</td>
		<tr><th>SNPs		<td>{{ sample.samplestats.snp_count }}
							<td>{{ sample.samplestats.snp_percent | floatformat }}
							{% if sample.samplestatspassingfilter %}
							<td>({{ sample.samplestatspassingfilter.snp_count }})
							{% endif %}
		<tr><th>Insertions	<td>{{ sample.samplestats.insertions_count }}
							<td>{{ sample.samplestats.insertions_percent | floatformat }}
							{% if sample.samplestatspassingfilter %}
							<td>({{ sample.samplestatspassingfilter.insertions_count }})
							{% endif %}
		<tr><th>Deletions	<td>{{ sample.samplestats.deletions_count }}
							<td>{{ sample.samplestats.deletions_percent | floatformat }}
							{% if sample.samplestatspassingfilter %}
							<td>({{ sample.samplestatspassingfilter.deletions_count }})
							{% endif %}
		</table>

        <h3>Zygosity</h3>
		<table>
		<tr><td>      <th>Count
                                {% if sample.samplestatspassingfilter %}
                                <th> (Pass Filters) </tr>
                                {% endif %}
		<tr><th>Ref           <td>{{ sample.samplestats.ref_count }}
                                {% if sample.samplestatspassingfilter %}
                                <td>({{ sample.samplestatspassingfilter.ref_count }})
                                {% endif %}
		<tr><th>Het	          <td>{{ sample.samplestats.het_count }}
                                {% if sample.samplestatspassingfilter %}
                                <td>({{ sample.samplestatspassingfilter.het_count }})
                                {% endif %}
		<tr><th>Hom           <td>{{ sample.samplestats.hom_count }}
                                {% if sample.samplestatspassingfilter %}
                                <td>({{ sample.samplestatspassingfilter.hom_count }})
                                {% endif %}
        <tr><th>Unk           <td>{{ sample.samplestats.unk_count }}
                                {% if sample.samplestatspassingfilter %}
                                <td>({{ sample.samplestatspassingfilter.unk_count }})
                                {% endif %}
		</table>
		
		{% if sample_locus_count %}
            <h3>Ploidy</h3>
            <table>
                <tr><th>Locus Count <th> Count
                {% for slc in sample_locus_count %}
                    <tr><td>{{ slc.locus_count }}
                            {% if slc.locus_count == 1 %}
                                (HOM)
                            {% elif slc.locus_count == 2 %}
                                (HET)
                            {% endif %}
                        <td>{{ slc.count }} 
                {% endfor %}
            </table>
            </p>
		{% endif %}
		
		{% if sex_guess %}
		<h3>Sex</h3>
		{{ sample.samplestats.chrx_sex_guess }} (chrX Hom: {{ sample.samplestats.x_hom_count }}, Het: {{ sample.samplestats.x_het_count }})
        {% endif %}
    </div>
	{% endif %}
     {% if somalier_enabled %}
        {% with ancestry=sample.somaliersampleextract.somalierancestry %}
            {% if ancestry %}
                <div id="sample-ancestry">
                    <p>
                        Prediction by <a href="https://github.com/brentp/somalier">Somalier</a>
                    </p>
                    <table>
                        <tr>
                            <th>Predicted</th>
                            <th>AFR prob</th>
                            <th>AMR prob</th>
                            <th>EAS prob</th>
                            <th>EUR prob</th>
                            <th>SAS prob</th>
                        </tr>
                        <tr>
                            <td>{{ ancestry.get_predicted_ancestry_display }}</td>
                            <td>{{ ancestry.AFR_prob }}</td>
                            <td>{{ ancestry.AMR_prob }}</td>
                            <td>{{ ancestry.EAS_prob }}</td>
                            <td>{{ ancestry.EUR_prob }}</td>
                            <td>{{ ancestry.SAS_prob }}</td>
                        </tr>
                    </table>

                    <h3>Extract</h3>
                    <table>
                        <tr>
                            <th>Date</th>
                            <td>{{ sample.somaliersampleextract.vcf_extract.created | localtime }}</td>
                        </tr>
                        <tr>
                            <th>REF count</th>
                            <td>{{ sample.somaliersampleextract.ref_count }}</td>
                        </tr>
                        <tr>
                            <th>HET count</th>
                            <td>{{ sample.somaliersampleextract.het_count }}</td>
                        </tr>
                        <tr>
                            <th>HOM count</th>
                            <td>{{ sample.somaliersampleextract.hom_count }}</td>
                        </tr>
                    </table>
                </div>
            {% endif %}
        {% endwith %}
    {% endif %}


    {% related_data_for_samples samples show_sample_info=False %}
    {% related_analyses_for_samples samples show_sample_info=False %}

    {% if somalier_enabled and related_samples.exists %}
        <h3>Related Samples</h3>
        <p>Relatedness of 0.5 is a parent/child or sibling.</p>
        <table>
            <tr>
                <th>Sample</th>
                <th>relatedness</th>
                <th>ibs0</th>
                <th>ibs2</th>
                <th>hom_concordance</th>
                <th>hets_a</th>
                <th>hets_b</th>
                <th>hets_ab</th>
                <th>shared_hets</th>
                <th>hom_alts_a</th>
                <th>hom_alts_b</th>
                <th>shared_hom_alts</th>
                <th>N</th>
                <th>x_ibs0</th>
                <th>x_ibs2</th>
            </tr>
            {% for rp in related_samples %}
                <tr>
                    <td>
                        {% if rp.sample_a == sample %}
                            <a href="{% url 'view_sample' rp.sample_b.pk %}">{{ rp.sample_b }}</a>
                        {% else %}
                            <a href="{% url 'view_sample' rp.sample_a.pk %}">{{ rp.sample_a }}</a>
                        {% endif %}
                    </td>
                    <td>{{ rp.relatedness }}</td>
                    <td>{{ rp.ibs0 }}</td>
                    <td>{{ rp.ibs2 }}</td>
                    <td>{{ rp.hom_concordance }}</td>
                    <td>{{ rp.hets_a }}</td>
                    <td>{{ rp.hets_b }}</td>
                    <td>{{ rp.hets_ab }}</td>
                    <td>{{ rp.shared_hets }}</td>
                    <td>{{ rp.hom_alts_a }}</td>
                    <td>{{ rp.hom_alts_b }}</td>
                    <td>{{ rp.shared_hom_alts }}</td>
                    <td>{{ rp.n }}</td>
                    <td>{{ rp.x_ibs0 }}</td>
                    <td>{{ rp.x_ibs2 }}</td>
                </tr>
            {% endfor %}
        </table>
    {% endif %}
    </div>
<div id="error-dialog" class="no-close" title="Error">
</div>
</div>

{% include "snpdb/create_patient_dialog.html" %}

{% endblock %}
