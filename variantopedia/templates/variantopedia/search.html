{% extends "uicore/page/base.html" %}
{% load english_tags %}
{% load crispy_forms_field %}
{% load ui_utils %}
{% load ui_menu_bars %}
{% load search_tags %}
{% load user_tag_color_tags %}
{% load settings_tags %}

{% block submenu %}{% menu_bar_data %}{% endblock %}

{% block title %}Search{% endblock %}
{% block head %}
    {% render_tag_styles_and_formatter %}
    <style>
        .example {
            font-family: monospace;
            color: #444444;
            display: inline-block;
            background-color: #f2f2f2;
            border-radius: 2px;
            padding: 2px 4px 2px 4px;
            margin: 4px 4px 4px 0;
        }
        .search-message {
            padding: 3px 3px 3px 0;
            color: #444;
            display: block;
        }
        .search-results a:hover .search-identifier {
            color: #44a;
            text-decoration: underline;
        }
        .list-group-item-action {
            cursor: pointer;
        }
        .list-group-item-action .search-identifier {
            color: #444466;
            cursor: pointer !important;
        }
        .search-results .list-group-item-action {
            background-color: #fafafc;
        }
        .search-results .list-group-item-action:hover {
            background-color: #f6f6ff;
        }
        .searched, .searched label {
            color: #448844 !important;
        }
    </style>
    <script>
        $(document).ready(() => {
            $('#big_search').select();
            $('#big_search').focus(() => {
               $('#big_search').select();
            });
        });
    </script>
{% endblock %}
{% block content %}
    {% settings_value 'VARIANT_VCF_DB_PREFIX' as variant_vcf_db_prefix %}
    {% settings_value 'SEARCH_SUMMARY' as show_search_summary %}

    <div class="container">
        <div>
            <h3>Search</h3>
        </div>

        <form id="search-form inline-form" method="get">
            <div class="input-group">
                <input id="big_search" class="form-control" name="search" placeholder="Search" value="{{ form.search.value }}" autofocus="autofocus">
                <div class="input-group-append">
                    <button id='search-page-button' class="input-group-append btn btn-primary">Go</button>
                </div>
            </div>
        </form>

        {% if search %}
            {% comment %}
            <p>
                <b>Searched:</b>
                {% if search_results.search_types %}
                    {{ search_results.search_types_string }}.
                {% else %}
                    <b>error - could not recognise search pattern.</b>
                {% endif %}
            </p>
            {% endcomment %}
            <div id='results' class="mt-4">
                <div class="row">
                    {% if search_results.results %}
                        <h4 class="col-8">{% count search_results.results singular="1 Result" plural="Results" %} Found for "{{ search }}"</h4>
                    {% else %}
                        <h4 class="col-8 no-value">No Results Found</h4>
                    {% endif %}
                    <div class="col-4 text-right">
                        <a class="hover-link" href="{% url 'view_user_settings' %}" title="Default Genome Build can be changed on the user settings page under Settings">Preferred Genome Build</a> : {{ search_results.genome_build_preferred }}
                    </div>
                </div>

                {% if search_results.results %}
                    <ul class="list-group search-results">
                        {% for search_result in search_results.results %}
                            {% with preview=search_result.preview %}
                                <a class="list-group-item list-group-item-action {% if search_result.messages %}list-group-item-warning{% endif %}" href="{{ preview.internal_url }}">
                                    <div class="row d-flex align-items-center" style="color:#444">
                                        <div class="col-3 text-right">
                                            {% if preview.icon %}<i class="{{ preview.icon }} mr-2" style="opacity:0.75"></i>{% endif %}
                                            <label>{{ preview.category }}</label>
                                            {% if search_result.sub_name %}<div class="text-info text-small">via {{ search_result.sub_name }} Search</div>{% endif %}
                                            <span>
                                            {% with extras=search_result.header_extra %}
                                                {% if extras %}
                                                    {% for extra in extras %}
                                                        &nbsp;<span class="text-small">{{ extra }}</span>
                                                    {% endfor %}
                                                {% endif %}
                                            {% endwith %}
                                            </span>
                                        </div>
                                        <div class="col-9">
                                            <label class="search-identifier">{{ preview.identifier }}</label>{% if preview.title %}&nbsp;<span class="search-title">{{ preview.title }}</span>{% endif %}
                                            {% if search_summary %}
                                                {% search_summary request.user search_result %}
                                            {% endif %}
                                            {% if search_result.messages %}
                                                <div class="mt-2">
                                                    {% for message in search_result.messages %}
                                                        <div class="text-danger">{{ 'W' | severity_icon }}{{ message|safe }}</div>
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </a>
                            {% endwith %}
                        {% endfor %}
                    </ul>

                    {% comment %}
                    <table class="table">
                        {% for search_result in search_results.results %}
                            <tr {% if not search_result.is_preferred_build or not search_result.is_preferred_annotation %}
                                class="not-preferred hover-detail" title="Search result is not in preferred build and/or annotation consortium"
                            {% if not search_result.is_debug_data %}
                                <tr {% if not search_result.is_preferred_build or not search_result.is_preferred_annotation %}
                                    class="not-preferred hover-detail" title="Search result is not in preferred build and/or annotation consortium"
                                {% endif %}
                                    <td>{{ search_result.header_string }}</td>
                                    <td>{% if search_result.messages %}{% for message in search_result.messages %}
                                        <span class="search-message text-danger">{{ message|safe }}</span>
                                    {% endfor %}<br>{% endif %}
                                        {% if search_result.record %}
                                            <a class="hover-link" href="{{ search_result.record.get_absolute_url }}">{{ search_result.record }}</a>
                                            {% if show_search_summary %}
                                                {% search_summary request.user search_result %}
                                            {% endif %}
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                    </table>
                    {% endcomment %}
                {% endif %}
            </div>
        {% endif %}

        <div class="card mt-4">
            <div class="card-header">Accepted Inputs</div>
            <div class="card-body">
                {% for search_result in search_results.grouped_search_infos %}
                    <div class="row d-flex align-items-center" style="min-height:30px;">
                        <div class="col-3 text-right {% if not search_result.sub_name and search_result.matched_pattern %}searched{% endif %}">
                            {% ifchanged search_result.preview_category %}
                                <i class="{{ search_result.preview_icon }} mr-2" style="opacity:0.75"></i>
                                <label>
                                    {{ search_result.preview_category }}
                                </label>
                            {% endifchanged %}
                        </div>
                        <div class="col-9">
                            {% if search_result.admin_only %}<i class="fa-solid fa-key mr-2"></i>{% endif %}
                            {% if search_result.sub_name %}
                                <label {% if search_result.matched_pattern %}class="searched"{% endif %}>{{ search_result.sub_name }}</label><span class="d-inline mx-1">-</span>
                            {% endif %}
                            {% if search_result.example %}
                                {% if search_result.example.note %}
                                    {{ search_result.example.note }}
                                {% endif %}
                                {% if search_result.example.examples %}
                                    {% for example in search_result.example.examples %}
                                        <span class="example ml-1">{{ example }}</span>
                                        <nomin> </nomin>
                                    {% endfor %}
                                {% endif %}
                            {% else %}
                                You can search for this
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>
            {% if search %}
                <div class="card-footer">
                    Inputs highlighted in <span class="searched">green</span> were included in this search.
                </div>
            {% endif %}
        </div>

        {% comment %}
        <h4>Accepted Inputs</h4>
        <div class="row equal">
            <div class="col-12 col-lg-6">
                <div class="card">
                    <div class="card-header">Variants</div>
                    <div class="card-body">
                        {% labelled label="HGVS" %}
                            Supports 'c.' and '.g'. If no transcript version is provided, the most recent is used.<br/>
                            <span class="example">NM_001080463.1:c.5972T>A</span><br/>
                            <span class="example">NM_000492.3(CFTR):c.1438G>T</span><br/>
                            <span class="example">NC_000007.13:g.117199563G>T</span><br/>
                            The <a class="hover-link" href="http://reg.clinicalgenome.org/redmine/projects/registry/gene_to_hgvs">ClinGen Allele Registry</a> is useful to find transcripts.
                        {% endlabelled %}
                        {% labelled label="Locus" %}<span class="example">chr1:169519049</span>{% endlabelled %}
                        {% labelled label="Variant" %}
                            <span class="example">1:169519049 T>C</span>, <span class="example">1-169519049-T-C</span> (gnomAD style) or by ID: <span class="example">v1001 or {{ variant_vcf_db_prefix }}1001</span>
                        {% endlabelled %}
                        {% labelled label="dbSNP ID" %}<span class="example">rs6025</span>{% endlabelled %}
                        {% labelled label="ClinGenAllele" %}<span class="example">CA285410130</span>{% endlabelled %}
                    </div>
                </div>
            </div>
            <div class="col-12 col-lg-6">
                <div class="card">
                    <div class="card-header">Data</div>
                    <div class="card-body">
                        {% labelled label="Gene Symbol" %}
                            1 word, case insensitive name match <span class="example">gata2</span>, <span class="example">GATA2</span>.<br/>
                        {% endlabelled %}
                        {% if url_name_visible.genes %}
                            // This stuff is still searchable even if genes URL is not visible, but of limited use in such environments
                            {% labelled label="Gene ID" %}
                                <span class="example">ENSG00000179348</span>
                            {% endlabelled %}
                            {% labelled label="Transcript ID" %}
                                <span class="example">NM_001080463</span> or with version <span class="example">NM_001080463.2</span>
                            {% endlabelled %}
                        {% endif %}
                        {% labelled label="Ontology" %}
                            <span class="example">OMIM:616299</span> or <span class="example">HP:0001332</span> or <span class="example">MONDO:0002974</span><br/>or text such as <span class="example">intestinal polyposis</span>
                            <br/>or for a dedicated MONDO search <a class="external-link" href="https://www.ebi.ac.uk/ols/ontologies/mondo">OLS Ontology Search</a>
                        {% endlabelled %}
                        {% if url_name_visible.analysis %}
                            {% labelled label="Analysis" %}
                                a1105 -> For analyis "1105"
                            {% endlabelled %}
                        {% endif %}
                        {% if url_name_visible.patients %}
                            {% labelled label="Cohort" %}
                                case insensitive search match in name
                            {% endlabelled %}
                            {% labelled label="Sample" %}
                                case insensitive search match in name
                            {% endlabelled %}
                            {% labelled label="Patients" %}
                                <span class="example">Last, First</span> or <span class="example">First</span> or <span class="example">Last</span>
                            {% endlabelled %}
                            {% labelled label="Pedigree" %}
                                case insensitive search match in name
                            {% endlabelled %}
                        {% endif %}
                        {% if url_name_visible.sequencing_data %}
                            {% labelled label="Flowcell" %}
                                1 word: 6 digits then underscore <span class="example">160513_NB501009_0029_AH3FFJBGXY</span>
                            {% endlabelled %}
                        {% endif %}
                        {% labelled label="Classification" %}
                            The Lab Record ID of the record <span class="example">vc1545</span>
                        {% endlabelled %}
                        {% labelled label="Lab, Organisation" %}
                            At least three letters <span class="example">path</span>
                        {% endlabelled %}
                        {% if external_codes %}
                            {% labelled label="Patient/Case/Pathology tests with external codes" %}
                                <ul>
                                    {% for code in external_codes %}
                                        <li>{{ code }}</li>
                                    {% endfor %}
                                </ul>
                            {% endlabelled %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        </div>
        {% endcomment %}

        <div class="alert alert-warning mt-4">
            Search is under development.<br/>
            Many of the variant searches have not been converted to the new method, and the ones that do need notes and examples<br/>
            The ability to create variants if they're not present is not available.<br/>
            Patterns of when a search is active need to be tweaked.<br/>
            And just a lot of little fixes here and there.xx
        </div>
    </div>

{% endblock %}
