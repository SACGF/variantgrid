{% extends "uicore/page/base.html" %}
{% load datatable_tags %}
{% load classification_tags %}
{% load ui_menu_bars %}
{% load ui_help %}
{% load user_tags %}
{% load ui_utils %}
{% block title %}Condition Matching{% endblock %}
{% block submenu %}{% menu_bar_classifications %}{% endblock submenu %}
{% block head %}
    <style>
        tr.selected {
            background-color: #ccffcc;
        }
        .condition-match-input::placeholder {
            color: #bbb;
        }
        .toggle-cell {
            width: 100px;
        }
        .term-cell {
            width: 200px;
        }
        .relevance-cell {
            width: 300px;
        }
    </style>
    <script>
        const gene_symbol = "{{ clinvar_export.gene_symbol }}";
        const basicHighlight = ["autosomal", "x-linked", "recessive", "dominant", gene_symbol];
        const basicHighlightStr = basicHighlight.join("|");
        const highlightRegex = new RegExp(`(${basicHighlightStr})`, 'ig');

        function submitUserChoices() {
            // FIXME
            // POST a single change to the server
            let id = $('#mp-id').val();

            let selectedText = $('#mp-selected').val();
            let {terms, _} = parseTermText(selectedText);

            let finalText = terms.join(", ");
            let mode = 'N';
            if (terms.length >= 2) {
                mode = $('[name=mp-multimode]:checked').val();
                switch (mode) {
                    case "U": finalText += "; uncertain"; break;
                    case "C": finalText += "; co-occurring"; break;
                    default: finalText += "; uncertain/co-occurring"; break;
                }
            }
            console.log(finalText); // though we if change this to API no need to mangle them together
            applyChange(parseInt(id, 10), terms, mode);
        }

        function parseTermText(text) {
            let termText = null;
            let join = 'N';

            let parts = text.split(";");
            if (parts.length == 2) {
                termText = parts[0].trim();
                join = parts[1].trim().toLowerCase();
                if (join.includes('/')) {
                    join = 'N';
                } else if (join.includes('un')) {
                    join = 'U';
                } else if (join.includes('co')) {
                    join = 'C';
                }
            } else {
                termText = text;
            }
            let terms = termText.split(",").map(tt => tt.trim());

            return {
                terms,
                join
            }
        }

        function toggleTerm(fullText, term) {
            let termArray = fullText.split(",").map(tt => tt.trim()).filter(tt => tt.length);
            let termDict = {};
            for (let term of termArray) {
                termDict[term] = true;
            }
            if (termDict[term]) {
                delete termDict[term];
            } else {
                termDict[term] = true;
            }
            let termList = Object.keys(termDict);
            if (termList.length > 0) {
                termList.sort();
                return termList.join(", ");
            } else {
                return '';
            }
        }

        function highlightDescription(description) {
            if (!description) {
                return description;
            }
            return description.replace(highlightRegex, "<b>$1</b>")
        }

        function idSafe(id) {
            return id.replace(":", "-");
        }

        function ontologyTr(onto) {
            let row = $('<tr>', {id: `result-${idSafe(onto.id)}`, class: 'onto-row'});
            let toggleButton = $('<button>', {class:'btn btn-outline-primary', text:'Toggle'}).click(() => {
                let fullText = $('#mp-selected').val();
                let newText = toggleTerm(fullText, onto.id);
                $('#mp-selected').val(newText);
                updateOntoRowSelections();
            });

            $('<td>', {class: 'toggle-cell', html:toggleButton}).appendTo(row);

             $('<td>', {class: 'term-cell', html:[
                $('<a>', {class: 'external-link', target:'blank', href:onto.url, text:onto.id}),
                $('<br>'),
                onto.title
            ]}).appendTo(row);

            let contexts = $('<td>', {class: 'relevance-cell'});
            contexts.append(renderContext(onto));

            contexts.appendTo(row);
            let description = $('<td>', {class:'description-cell text-muted' }).appendTo(row);
            description.append(highlightDescription(onto.definition))
            if (onto.sibling_count || onto.children_count) {
                $('<div>', {html:[
                    $('<a>', {text: `Siblings: ${onto.sibling_count}, Children: ${onto.children_count}`})
                ]}).appendTo(description);
            }

            let scoreDetail = $('<div>');
            for (let score_part of onto.scores) {
                let score = score_part.score.toFixed(0);

                $('<div>', {class:'mt-2',
                    html: [
                        $('<div>', {html:[
                            $('<span>', {class: 'text-monospace', html: score}),
                            $('<span>', {text: " : " + score_part.name + " out of " + score_part.max})
                        ]}),
                        $('<div>', {class:'text-muted', html:score_part.note})
                    ]
                }).appendTo(scoreDetail);
            }

            let scoreCell = $('<td>', {class:'score-cell text-monospace text-right', 'data-toggle': 'popover', 'title': 'score', 'data-content': scoreDetail.prop('outerHTML')}).appendTo(row);
            $('<div>', {text: onto.score.toFixed(0)}).appendTo(scoreCell);

            return row;
        }

        function updateOntoRowSelections() {
            $('.onto-row').removeClass('selected');
            let allSelected = $('#mp-selected').val().split(',').map(t => t.trim()).filter(t => t.length > 0);
            for (let selected of allSelected) {
                $(`#result-${idSafe(selected)}`).addClass('selected');
            }
        }

        function renderOntologies(ontos) {
            ontos.sort((a, b) => {
                let score1 = a.score + (a.selected ? 10000 : 0);
                let score2 = b.score + (b.selected ? 10000 : 0);
                return score2 - score1;
            });

            let tbody = $('#mp-results tbody');
            tbody.empty();
            for (let onto of ontos) {
                ontologyTr(onto).appendTo(tbody);
            }
        }

        function searchMondo(data) {
            let searchText = data.searchText;
            let geneSymbol = data.geneSymbol;
            let selected = data.selected;

            let url = '{% url "api_mondo_search" %}';
            let resultsDom = $("#mp-results");
            resultsDom.LoadingOverlay('show');

            $.ajax({
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                data: {
                    "search_term": searchText,
                    "gene_symbol": geneSymbol,
                    "selected": selected
                },
                url: url,
                type: 'GET',
                error: (call, status, text) => {
                    resultsDom.LoadingOverlay('hide');
                    resultsDom.find('tbody').empty().append($('<tr>', {html:
                            $('<td>', {'col-span': 4, text: 'Error retrieving mondo terms'})
                    }));
                    console.log(status);
                    console.log(text);
                    // $('<div/>', {class:'no-value w-100 text-center', text:'Error Retrieving'}).appendTo(resultsDom);
                    // FIXME show errors
                },
                success: async (results) => {
                    resultsDom.LoadingOverlay('hide');
                    renderOntologies(results);
                    updateOntoRowSelections();
                }
            });
        }

        function renderContext(onto) {
            let allContexts = $('<div>');
            if (onto.direct_reference) {
                $('<div>', {html: [
                        $(`<i class="fas fa-circle text-dark"></i>`),
                        $('<span>', {text: "Referenced in Condition Text" })
                ]}).appendTo(allContexts);
            }
            if (onto.text_search) {
                 $('<div>', {html: [
                        $(`<i class="fas fa-circle text-secondary"></i>`),
                        $('<span>', {text: "Text search" })
                ]}).appendTo(allContexts);
            }
            if (onto.gene_relationships && onto.gene_relationships.length) {
                html = [
                        $(`<i class="fas fa-circle text-success"></i>`),
                        $('<span>', {text: "Established gene relationship"}),
                        " "
                    ];
                let first = true;
                for (let relationship of onto.gene_relationships) {
                    if (!first) {
                        html.push(", ");
                    } else {
                        first = false;
                    }
                    if (relationship.relation === "panelappau") {
                        let extra = relationship.extra || {};
                        let tooltip = `Phenotype: ${extra.phenotype_row}<br/>Evidence: ${extra.evidence ? extra.evidence.join(',') : ''}<br/>Via related term: ${relationship.via}`;
                        html.push( $('<span>', {class: 'text-muted', text: 'PanelApp AU', 'data-toggle':'popover', 'title': 'Gene Relationship', 'data-content': tooltip}) );
                    } else if (relationship.source === "hpo_disease") {
                        let tooltip = `Via related term: ${relationship.via}`;
                        html.push( $('<span>', {class: 'text-muted', text: 'NCBI', 'data-toggle':'popover', 'title': 'Gene Relationship', 'data-content': tooltip}) );
                    } else if (relationship.source === "mondo_file") {
                        let tooltip = `Relationship: ${relationship.relation}`;
                        html.push( $('<span>', {class: 'text-muted', text: "MONDO", 'data-toggle':'popover', 'title': 'Gene Relationship', 'data-content': tooltip}) );
                    } else {
                        let tooltip = `Relationship: ${relationship.relation}`;
                        html.push( $('<span>', {class: 'text-muted', text: relationship.source, 'data-toggle':'popover', 'title': 'Gene Relationship', 'data-content': tooltip}) );
                    }
                }
                $('<div>', {
                    html: html
                }).appendTo(allContexts);
            }
            return allContexts;
        }

        function triggerSearchMondo() {
            let searchText = $('#mp-search-text').val();
            let geneSymbol = $('#mp-gene-symbol').text();
            let selected = $('#mp-selected').val();
            if (geneSymbol === "-") {
                geneSymbol = "";
            }

            searchMondo({
                searchText,
                geneSymbol,
                selected
            });
        }

        function renderSuggestion(suggestion, id) {
            let dom = $('<div>');
            if (suggestion.terms && suggestion.terms.length) {
                let termStyle = '';
                if (!suggestion.is_applied) {
                    let wrapper = $(`#condition-match-${suggestion.id}`);
                    let parentId = wrapper.attr('data-parent-id');
                    if (parentId) {
                        let parent = $(`#condition-match-${parentId}`).attr('data-name');
                        dom.append($('<div>', {class:'text-muted font-italic', text:`Inherits from ${parent}`}));
                    } else {
                        dom.append($('<div>', {class:'text-muted font-italic', text:`No terms provided`}));
                    }

                    $('<label>', {style: 'margin-left:1.25rem', html:[
                        $('<input>', {type: 'checkbox', class:'form-check-input suggestion-checkbox', checked:'checked', click:() => {checkSuggestionCount()}}),
                        'Suggestion',
                    ]}).appendTo(dom);
                    termStyle = 'opacity:0.5';
                }
                for (let term of suggestion.terms) {
                    // TODO use generated URL
                    let termDom = $('<div>', {style:termStyle, html:[
                            $('<a>', {href:`/ontology/term/${term.id.replace(':','_')}`, text:term.id, target:'_blank', title:term.definition, 'data-toggle':'tooltip'}),
                            ' ',
                            term.name
                    ]});
                    dom.append(termDom);
                }
                if (suggestion.terms.length > 1) {
                    let joiner_text = 'combination type undecided';
                    switch (suggestion.joiner) {
                        case 'U': joiner_text = 'uncertain';
                        case 'C': joiner_text = 'co-occurring';
                    }
                    $('<div>', {text: joiner_text, class:'text-muted'}).appendTo(dom);
                }
            } else {
                let wrapper = $(`#condition-match-${suggestion.id}`);
                let parentId = wrapper.attr('data-parent-id');
                if (parentId) {
                    let parent = $(`#condition-match-${parentId}`).attr('data-name');
                    dom.append($('<span>', {class:'text-muted font-italic', text:`Inherits from ${parent}`}));
                } else {
                    dom.append($('<span>', {class:'text-muted font-italic', text:`No terms suggested`}));
                }
            }
            if (suggestion.messages && suggestion.messages.length) {
                for (let message of suggestion.messages) {
                    let messageDom = $('<div>', {html:[
                            severityIcon(message.severity),
                            ' ',
                            message.text
                    ]}).appendTo(dom);
                }
            }
            return dom;
        }

        function checkSuggestionCount() {
            let checkedCount = $('.suggestion-checkbox:checked').parents('.condition-match-placeholder').length;
            let button = $('#approve-suggestions');
            button.text(`Approve ${checkedCount} suggestion${checkedCount == 1 ? '' : 's'}`);
            if (checkedCount == 0) {
                button.hide();
            } else {
                button.show();
            }
        }

        function approveSuggestions() {
            let checked = $('.suggestion-checkbox:checked').parents('.condition-match-placeholder');
            let changes = [];
            for (let placeholder of checked) {
                placeholder = $(placeholder);
                let cid = parseInt(placeholder.attr('data-id'));
                let terms = placeholder.attr('data-terms').split(",");
                let joiner = placeholder.attr('data-join');
                changes.push({
                    'ctm_id': cid,
                    'terms': terms,
                    'joiner': joiner
                });
            }
            if (changes.length) {
                applyChanges(changes);
            }
        }

        function applyChange(id, terms, joiner) {
            applyChanges([{
                'ctm_id': id,
                'terms': terms,
                'joiner': joiner
            }])
        }

        function applyChanges(changes) {
            $('#condition-list').LoadingOverlay('show');
            $.ajax({
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                data: JSON.stringify({"changes": changes}),
                url: '{% url 'condition_text_matching_api' condition_text.pk %}', // FIXME generate the URLS
                type: 'POST',
                error: (call, status, text) => {
                    $('#condition-list').LoadingOverlay('hide');
                    alert('There was an error updating this term');
                    console.log(status);
                    console.log(text);
                },
                success: async (results) => {
                    console.log("SUCCESS");
                    applySuggestionUpdates(results);
                    $('#condition-list').LoadingOverlay('hide');
                }
            });
        }

        function updateSuggestions() {
            $('#condition-list').LoadingOverlay('show');
            $.ajax({
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                url: '{% url 'condition_text_matching_api' condition_text.pk %}', // FIXME generate the URLS
                type: 'GET',
                error: (call, status, text) => {
                    $('#condition-list').LoadingOverlay('hide');
                    alert('There was an error retrieving terms');
                    console.log(status);
                    console.log(text);
                },
                success: async (results) => {
                    applySuggestionUpdates(results, true);
                    $('#condition-list').LoadingOverlay('hide');
                }
            });
        }

        function applySuggestionUpdates(results, complete) {
            let suggestions = results.suggestions;
            if (complete) {
                $('.condition-match-placeholder').empty().removeAttr('data-terms').removeAttr('data-join', '');
            }
            for (let suggestion of suggestions) {
                let wrapper = $(`#condition-match-${suggestion.id}`);
                wrapper.html(renderSuggestion(suggestion));
                wrapper.attr('data-terms', suggestion.terms.map(term => term.id).join(","));
                wrapper.attr('data-join', suggestion.joiner);
            }
            let inheritings = $('.condition-match-placeholder:not([data-terms])');
            for (let inheriting of inheritings) {
                inheriting = $(inheriting);
                let parentId = inheriting.attr('data-parent-id');
                if (parentId) {
                    let parent = $(`#condition-match-${parentId}`).attr('data-name');
                    inheriting.html($('<span>', {class:'text-muted font-italic', text:`Inherits from ${parent}`}))
                }
            }
            checkSuggestionCount();
        }

        $(document).ready(() => {
            updateSuggestions();
            checkSuggestionCount();

            // open MODAL
            // TODO : Make it so you can't click this button until the server
            $('.mondo-picker').click(function () {
                let mondoButton = $(this);
                let geneSymbol = mondoButton.attr('data-gene-symbol');
                let label = mondoButton.attr('data-label');
                let inheritance = mondoButton.attr('data-mode-of-inheritance');
                if (geneSymbol == '') {
                    $('#mp-gene-symbol').text('-').addClass('no-value');
                } else {
                    $('#mp-gene-symbol').text(geneSymbol).removeClass('no-value');
                }
                let recordId = $(this).attr('data-id');
                let selected = $(`#condition-match-${recordId}`).attr('data-terms');
                let joiner = $(`#condition-match-${recordId}`).attr('data-join');
                // let parsedMatch = parseTermText(selected);
                $(`[name=mp-multimode][value=${joiner}]`).trigger('click');

                $('#mp-id').val(recordId);
                $('#mp-search-text').val(`{{ condition_text.normalized_text }}`.trim());
                $('#mp-selection-title').text(label);
                $('#mp-selected').val(selected);
                if (inheritance == 'N/A') {
                    $('#mp-mode-of-inheritance').html($('<span>', {class: 'no-value', text: 'N/A'}));
                } else if (inheritance == 'None') {
                    $('#mp-mode-of-inheritance').html($('<span>', {class: 'no-value', text: 'Not Specified'}));
                } else {
                    $('#mp-mode-of-inheritance').text(inheritance);
                }
                $('#mondoModal').modal('show');

                triggerSearchMondo();
                return false;
            });

            $('#mp-search-button').click(() => {
                triggerSearchMondo();
            });

            $('#mp-selected').change(() => {
                updateOntoRowSelections();
            })
        });
    </script>
{% endblock %}
{% block content %}
    <div class="modal fade" data-backdrop="static" id="mondoModal" tabindex="-1" aria-labelledby="mondoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="mondoModalLabel">Mondo Picker for <span id="mp-selection-title">?</span></h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <input id="mp-id" type="hidden" />
                    {% labelled label="Search Text" %}
                        <div class="input-group">
                            <input class="form-control" type="text" id="mp-search-text" />
                            <span class="input-group-append"><button id="mp-search-button" class="btn btn-outline-primary" name="action">Search</button></span>
                        </div>
                    {% endlabelled %}
                    {% labelled label="Gene Symbol" %}<span id="mp-gene-symbol">None</span>{% endlabelled %}
                    {% labelled label="Mode of Inheritance" %}<span id="mp-mode-of-inheritance">N/A</span>{% endlabelled %}
                    {% labelled label="Mutli-Mode" %}
                        <div id="mp-multimode" >
                            <div class="btn-group btn-group-toggle" data-toggle="buttons">
                                <label class="btn btn-outline-secondary"><input type="radio" name="mp-multimode" id="mp-multimode-n" value="N" checked="checked">?</label>
                                <label class="btn btn-outline-secondary"><input type="radio" name="mp-multimode" id="mp-multimode-u" value="U">Uncertain</label>
                                <label class="btn btn-outline-secondary"><input type="radio" name="mp-multimode" id="mp-multimode-c" value="C">Co-occuring</label>
                            </div>
                        </div>
                        <div id="mp-singlemode" class="collapse no-value">N/A</div>
                    {% endlabelled %}
                    {% labelled label="Terms" %}<input class="form-control" id="mp-selected" />{% endlabelled %}

                    <label>Select Relevant Ontology Terms Below</label>
                    <table class="table" id="mp-results">
                        <thead>
                            <tr>
                                <th class="toggle-cell">Toggle</th>
                                <th class="term-cell">Term</th>
                                <th class="relevance-cell">Relevance</th>
                                <th class="description-cell">Description</th>
                                <th class="score-cell">Score</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="submitUserChoices()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <form method="POST">
            {% csrf_token %}
            <a href="{% url 'condition_matchings' %}" class="hover-link"><i class="fas fa-angle-left"></i> Back to all
                Condition Texts</a>
            <h3>Condition Matching</h3>
            {% page_help_embedded title='Condition Matching' %}
                <p>
                    Help will go here for matching text to conditions
                </p>
            {% end_page_help_embedded %}
            {% labelled label="Lab" %}{{ condition_text.lab.name }}{% endlabelled %}
            {% labelled label="Text" %}{{ condition_text.normalized_text }}{% endlabelled %}
            <ul id="condition-list" class="list-group mt-4">
                {% condition_match condition_match %}
            </ul>
        </form>
        <button id="approve-suggestions" class="btn btn-primary" onclick="approveSuggestions()">
            Approve suggestions
        </button>
    </div>
{% endblock %}