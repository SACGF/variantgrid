{% extends "uicore/page/base.html" %}
{% load static %}
{% load classification_tags %}
{% load ui_help %}
{% load ui_utils %}
{% load js_tags %}
{% load ui_menu_bars %}
{% load ui_tabs_builder %}
{% load datatable_tags %}
{% block title %}Clinical Key Summary{% endblock %}
{% block submenu %}{% menu_bar_classifications %}{% endblock submenu %}
{% block head %}
    <script>
        function records(data) {
            data.clinvar_key = {{ clinvar_key.pk | jsonify }};
        }
        function batches(data) {
            data.clinvar_key = {{ clinvar_key.pk | jsonify }};
        }
        function renderStatus(data, type, row) {
            let dom = null;
            if (data === 'D') {
                dom = severityIcon('success');
                dom.attr('title', 'Up to date');
            } else if (data === 'E') {
                dom = severityIcon('error');
                dom.attr('title', 'Missing data, unable to submit');
            } else if (data === 'N') {
                dom = $('<i class="fas fa-cloud-upload-alt text-success"></i>')
                dom.attr('title', 'New submission');
            } else if (data == 'C') {
                dom = $('<i class="fas fa-cloud-upload-alt text-primary"></i>')
                dom.attr('title', 'Changes to existing ClinVar record pending');
            } else {
                dom = $('<span>', {text: data});
            }
            if (dom.attr('title')) {
                dom.attr('data-toggle', 'tooltip');
            }
            return dom.prop('outerHTML');
        }
        function renderReleaseStatus(data, type, row) {
            let dom = null;
            if (data === 'R') {
                dom = severityIcon('success');
                dom.attr('title', 'Release when ready');
                dom.attr('data-toggle', 'tooltip');
            } else if (data === 'H') {
                dom = $('<i class="fas fa-clock"></i>');
                dom.attr('title', 'On hold');
                dom.attr('data-toggle', 'tooltip');
            } else {
                dom = $('<span>', {text: data});
            }
            if (row.status === "E") {
                dom.css('opacity', 0.4);
            }
            return dom.prop('outerHTML');
        }
        function renderSCV(data, type, row) {
            if (!data) {
                return $('<span>', {text: '-', class:'no-value'}).prop('outerHTML');
            } else {
                return data;
            }
        }
        function renderId(data, type, row) {
            let content = [$('<span/>', {text:data.genome_build}), $("<br/>"), $('<span/>', {text: data.c_hgvs})];
            // let id = data.id;
            // let elem = $('<a/>', {href: `/classification/clinvar_export/${id}`, html: content, class:'id-link'});
            let elem = $('<span>', {html: content});
            return elem.prop('outerHTML');
        };
        $(document).ready(() => {
            {% datatable_definition table_config=export_columns data='records' table_id='records' url='clinvar_exports_datatables' %}
            {% datatable_definition table_config=export_batch_columns data='batches' table_id='batches' url='clinvar_export_batch_datatables' %}
        });
    </script>
    <style>
        .clinvar-export-table .dt-allele {
            width: 10%;
        }
        .clivnar-export-table .dt-scv {
            width: 10%;
        }
        .clinvar-export-table td.dt-release_status, .clinvar-export-table td.dt-status {
            width: 10%;
            text-align: center;
            position: relative;
        }
        .clinvar-export-table td.dt-release_status i, .clinvar-export-table td.dt-status i {
            position: relative;
            left: -10px;
        }
        .clinvar-export-table .dt-classification {
            width: 25%;
        }
        .clinvar-export-table .dt-condition {
            width: 25%;
        }
        .clivnar-export-batches-table .dt-created {
            width: 50%;
        }
        .clivnar-export-batches-table .dt-status {
            width: 50%;
        }
    </style>
{% endblock head %}
{% block content %}
    <div class="container">
        {% if all_keys.count > 1 %}
            <div class="btn-group mb-4" role="group" aria-label="ClinVar Key Picker">
                {% for key in all_keys %}<a type="button" href="{% url 'clinvar_key_summary' key.pk %}" class="btn {% if key.pk == clinvar_key.pk %}btn-secondary{% else %}btn-outline-secondary{% endif %}">{{ key.pk }}</a>{% endfor %}
            </div>
        {% endif %}

        <div data-toggle="ajax" href="{% url 'clinvar_key' clinvar_key.pk %}">Loading</div>
        <h4>Records</h4>
        {% if missing_condition_count %}
            {% labelled label="Classifications w/out standard condition" %}
                <a href="{% url 'condition_matchings' %}" title="Only classifications with standard conditions can be submitted to ClinVar">
                    {{ 'warning' | severity_icon }}
                    {{ missing_condition_count }}</a>
            {% endlabelled %}
        {% else %}
            {% labelled label="Classifications w/out standard condition" %}
                {{ 'success' | severity_icon }} All shared classifications have a standard condition
            {% endlabelled %}
        {% endif %}
        <div class="text-info mb-1">Important: the status of ClinVar exports is cached. Recent changes may not be reflected yet.</div>

        {% ui_register_tab_embedded tab_set="clinvar_tabs" label="Records" badge=count_records badge_status='success' %}
            {% datatable table_config=export_columns table_id='records' class_name='sticky-header clinvar-export-table' %}
        {% end_ui_register_tab_embedded %}
        {% ui_register_tab_embedded tab_set="clinvar_tabs" label="Export Batches" badge=count_batch badge_status='success' %}
            {% datatable table_config=export_batch_columns table_id='batches' class_name='sticky-header clinvar-export-batches-table' %}
        {% end_ui_register_tab_embedded %}

        {% ui_render_tabs tab_set='clinvar_tabs' %}
    </div>
{% endblock content %}