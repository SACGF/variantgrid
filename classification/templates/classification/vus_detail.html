{% load classification_tags %}
{% load english_tags %}
{% load ui_utils %}
{% load ui_tabs_builder %}

<h5>VUS Overlaps</h5>

<table style="display:none">
{% for grouping in overlaps.overlaps_vus %}
    {% if grouping.allele %}
        <tr id="allele-{{ grouping.allele.pk }}-header">
            <td>
                <a href="{{ grouping.allele.get_absolute_url }}" class="hover-link">
                {% for hgvs in grouping.c_hgvses %}
                    <div>{% c_hgvs hgvs %}</div>
                {% endfor %}
                </a>
                <div>
                    <a class="hover-link" href="{% url 'classification_diff' %}?allele={{ grouping.allele.pk }}">Show Diffs</a>
                </div>
            </td>
            <td class="text-right" style="font-weight:500">{{ grouping.max_acmg_points|default_if_none:'-' }}</td>
            <td class="text-right" style="font-weight:500">{{ grouping.patient_count }}</td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>

        </tr>
    {% endif %}
{% endfor %}
</table>

<table class="table sticky-header" id="vus_detail_table">
    <thead>
        <tr class="grouped-row">
            <th>Allele ID</th>
            <th>c.HGVS/Lab</th>
            <th class="text-right">(Max)<br/>Score</th>
            <th class="text-right">(Total)<br/>Patients</th>
            <th class="crit-value">PS4</th>
            <th class="crit-value">PP1<br/>BS4</th>
            <th class="crit-value">PM6</th>
            <th class="crit-value">PS2</th>
            <th class="crit-value">PM3</th>
            <th class="crit-value">PP4</th>
            <th class="crit-value">PS3<br/>BS3</th>
        </tr>
    </thead>
    <tbody>
        {% for grouping in overlaps.overlaps_vus %}
            {% if grouping.allele %}
                {% for lab_summary in grouping.lab_clinical_significances %}
                    <tr>
                        <td>{{ grouping.allele.pk }}</td>
                        <td>
                            <nomin>
                            {{ lab_summary.lab }}
                            {% if lab_summary.count > 1 %} x {{ lab_summary.count }}{% endif %}
                            {% clinical_significance_inline lab_summary.clinical_significance_to %}
                            </nomin>
                        </td>
                        {% with strengths=lab_summary.latest.criteria_strengths %}
                            {% if strengths.has_criteria %}
                                <td class="text-right" data-order="{{ grouping.max_acmg_points|default_if_none:0|add:100|format:"03d" }}_{{ grouping.allele.pk }}_{{ strengths.acmg_point_score|add:100|format:"03d" }}">{{ strengths.acmg_point_score }}</td>
                            {% else %}
                                <td class="text-right" data-order="{{ grouping.max_acmg_points|default_if_none:0|add:100|format:"03d" }}_{{ grouping.allele.pk }}_000"><div class="no-value">-</div></td>
                            {% endif %}
                            <td class="text-right" data-order="{{ grouping.patient_count.count|format:"03d" }}_{{ grouping.allele.pk }}_{{ lab_summary.patient_count.count|format:"03d" }}">{{ lab_summary.patient_count }}</td>
                            {% criteria_strength_td strengths.ps4 %}
                            {% criteria_strength_td strengths.pp1_bs4 %}
                            {% criteria_strength_td strengths.pm6 %}
                            {% criteria_strength_td strengths.ps2 %}
                            {% criteria_strength_td strengths.pm3 %}
                            {% criteria_strength_td strengths.pp4 %}
                            {% criteria_strength_td strengths.bs3_ps3 %}
                        {% endwith %}
                    </tr>
                {% endfor %}
            {% endif %}
        {% endfor %}
    </tbody>
</table>
<script>

    $('#vus_detail_table').DataTable({
        paging: false,
        searching: false,
        columns: [
            {visible: false}, // Allele ID
            {orderable: false}, // Lab
            {orderable: true}, // Score
            {orderable: true}, // Patients
            {orderable: false}, // PS4
            {orderable: false}, // PP1 BS4
            {orderable: false}, // PM6
            {orderable: false}, // PS2
            {orderable: false}, // PM3
            {orderable: false}, // PP4
            {orderable: false}, // PS3 / BS3
        ],
        rowGroup: {
            dataSrc: 0,
            endRender: null,
            startRender: function ( rows, group ) {
                let alleleId = rows.data()[0][0];
                return $(`#allele-${alleleId}-header`).clone().removeAttr('id');
            }
        }
    });
</script>
