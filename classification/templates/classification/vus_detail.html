{% load classification_tags %}
{% load english_tags %}
{% load ui_utils %}
{% load ui_tabs_builder %}

<h5>VUS Overlaps</h5>

<style>
    #vus_detail_table .dtrg-group .value-with-icon .value {
        font-weight: 600;
    }
    #vus_detail_table .value {
        font-family: monospace;
    }
    #vus_detail_table .value-with-icon i {
        font-size: 8pt;
    }
</style>

<table style="display:none">
{% for grouping in overlaps.overlaps_vus %}
    {% if grouping.allele %}
        <tr id="allele-{{ grouping.allele.pk }}-header">
            <td>
                <a href="{{ grouping.allele.get_absolute_url }}" class="hover-link">
                {% for hgvs in grouping.c_hgvses %}
                    <div>{% c_hgvs hgvs %}</div>
                {% endfor %}
                </a>
                <div>
                    <a class="hover-link" href="{% url 'classification_diff' %}?allele={{ grouping.allele.pk }}">Show Diffs</a>
                </div>
            </td>
            <td class="text-right" style="font-weight:500">
                {% with points=grouping.extreme_acmg_points %}
                    {% if points.has_criteria %}
                        {% if points.is_acmg_standard %}
                            {% value_with_icon value=points.points %}
                        {% else %}
                            {% value_with_icon value=points.points help="One or more VUS records for this allele use a non-default ACMG curation method" icon="fa-solid fa-asterisk text-info" %}
                        {% endif %}
                    {% else %}
                        {% value_with_icon value=None %}
                    {% endif %}
                {% endwith %}
            </td>
            <td class="text-right" style="font-weight:500">
                {% with patient_count=grouping.patient_count %}
                    {% if patient_count.consolidates_variant_classifications %}
                        {% value_with_icon value=patient_count.count help="One or more labs is unable to report number of patients, actual number of patients might be higher" icon="fa-solid fa-plus text-info" %}
                    {% else %}
                        {% value_with_icon value=patient_count.count %}
                    {% endif %}
                {% endwith %}
            </td>
            {% with criteria_compare=grouping.criteria_compare %}
                <td class="text-center">{{ criteria_compare.ps4.html }}</td>
                <td class="text-center">{{ criteria_compare.pp1_bs4.html }}</td>
                <td class="text-center">{{ criteria_compare.pm6.html }}</td>
                <td class="text-center">{{ criteria_compare.ps2.html }}</td>
                <td class="text-center">{{ criteria_compare.pm3.html }}</td>
                <td class="text-center">{{ criteria_compare.pp4.html }}</td>
                <td class="text-center">{{ criteria_compare.ps3_bs3.html }}</td>
            {% endwith %}

        </tr>
    {% endif %}
{% endfor %}
</table>

<table class="table sticky-header" id="vus_detail_table">
    <thead>
        <tr class="grouped-row">
            <th>Allele ID</th>
            <th>c.HGVS/Lab</th>
            <th class="text-right">(Max Abs)<br/>Score</th>
            <th class="text-right">(Total)<br/>Patients</th>
            <th class="crit-value">PS4</th>
            <th class="crit-value">PP1<br/>BS4</th>
            <th class="crit-value">PM6</th>
            <th class="crit-value">PS2</th>
            <th class="crit-value">PM3</th>
            <th class="crit-value">PP4</th>
            <th class="crit-value">PS3<br/>BS3</th>
        </tr>
    </thead>
    <tbody>
        {% for grouping in overlaps.overlaps_vus %}
            {% if grouping.allele %}
                {% for lab_summary in grouping.lab_clinical_significances %}
                    <tr>
                        <td>{{ grouping.allele.pk }}</td>
                        <td>
                            <nomin>
                            {{ lab_summary.lab }}
                            {% if lab_summary.count > 1 %} x {{ lab_summary.count }}{% endif %}
                            {% clinical_significance_inline lab_summary.clinical_significance_to %}
                            </nomin>
                        </td>
                        {% with strengths=lab_summary.latest.criteria_strengths %}
                            {% with points=strengths.acmg_point_score %}
                                <td class="text-right" data-order="{{ grouping.extreme_acmg_points.sort_string }}_{{ grouping.allele.pk }}_{{ points.sort_string }}">
                                    {% if points.has_criteria %}
                                        {% if points.is_acmg_standard %}
                                            {% value_with_icon value=points.points %}
                                        {% else %}
                                            {% value_with_icon value=points.points help="This record used a non-default ACMG curation method.</br>Points might not be an accurate reflection of the record." icon="fa-solid fa-asterisk text-info" %}
                                        {% endif %}
                                    {% else %}
                                        {% value_with_icon %}
                                    {% endif %}
                                </td>
                            {% endwith %}
                            <td class="text-right" data-order="{{ grouping.patient_count.sort_string }}_{{ grouping.allele.pk }}_{{ lab_summary.patient_count.sort_string }}">
                                {% with patient_count=lab_summary.patient_count %}
                                    {% if patient_count.consolidates_variant_classifications %}
                                        {% value_with_icon value=patient_count.count help="This lab is unable to report number of patients, actual number of patients might be higher" icon="fa-solid fa-plus text-info" %}
                                    {% else %}
                                        {% value_with_icon value=patient_count.count %}
                                    {% endif %}
                                {% endwith %}
                            </td>
                            {% criteria_strength_td strengths.ps4 %}
                            {% criteria_strength_td strengths.pp1_bs4 %}
                            {% criteria_strength_td strengths.pm6 %}
                            {% criteria_strength_td strengths.ps2 %}
                            {% criteria_strength_td strengths.pm3 %}
                            {% criteria_strength_td strengths.pp4 %}
                            {% criteria_strength_td strengths.bs3_ps3 %}
                        {% endwith %}
                    </tr>
                {% endfor %}
            {% endif %}
        {% endfor %}
    </tbody>
</table>
<script>

    $('#vus_detail_table').DataTable({
        paging: false,
        searching: false,
        dom: 'p',
        columns: [
            {visible: false}, // Allele ID
            {orderable: false}, // Lab
            {orderable: true, orderData: [2, 3]}, // Score
            {orderable: true}, // Patients
            {orderable: false}, // PS4
            {orderable: false}, // PP1 BS4
            {orderable: false}, // PM6
            {orderable: false}, // PS2
            {orderable: false}, // PM3
            {orderable: false}, // PP4
            {orderable: false}, // PS3 / BS3
        ],
        rowGroup: {
            dataSrc: 0,
            endRender: null,
            startRender: function ( rows, group ) {
                let alleleId = rows.data()[0][0];
                return $(`#allele-${alleleId}-header`).clone().removeAttr('id');
            }
        }
    });
</script>
