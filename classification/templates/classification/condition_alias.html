{% extends "uicore/page/base.html" %}
{% load classification_tags %}
{% load js_tags %}
{% load ui_menu_bars %}
{% load ui_help %}
{% load ui_utils %}
{% block title %}Condition Alias{% endblock %}
{% block submenu %}{% menu_bar_classifications %}{% endblock submenu %}
{% block head %}
    <style>
        .selectable-card.selected .card-body {
            background-color: #efe;
        }
        .selectable-card:hover .fa-plus-circle {
            color: blue !important;
        }
        .selectable-card:hover .fa-minus-circle {
            color: red !important;
        }
        .selectable-card:hover {
            box-shadow: 0 0 3px #ccf;
        }
        .simple-pill {
            display: inline-block;
            padding: 2px 6px 2px 6px;
            border: 2px solid #ccc;
            background-color: #eee;
        }
        .simple-pill:first-child {
            border-top-left-radius: 12px;
            border-bottom-left-radius: 12px;
        }
        .simple-pill:last-child {
            border-top-right-radius: 12px;
            border-bottom-right-radius: 12px;
        }
        .joiner {
            display: inline-block;
            text-align: center;
            width: 3rem;
        }
    </style>
    <script>
        matches = {};

        function submit(next) {
            let keys = Object.keys(matches);
            keys.sort();

            let form = $("#alias-form");
            form.find(`[name="aliases"]`).val(keys.join(","));
            form.find(`[name="join_mode"]`).val($(`[name="multiple-mode"]:checked`).val() == "and" ? "A" : "O");
            if (next) {
                form.find(`[name="next"]`).val("next")
            }
            form.submit();
        }

        function updateSummary() {
            let mmode = $(`[name="multiple-mode"]:checked`).val();
            let keys = Object.keys(matches);
            let summaryDom = $("#alias-summary");
            summaryDom.empty();
            if (keys.length == 0) {
                $('<span>', {class:"simple-pill", text:"?"}).appendTo(summaryDom);
            } else {
                keys.sort();
                let first = true;
                for (let key of keys) {
                    if (!first) {
                        $('<span>', {class:'joiner', text:mmode}).appendTo(summaryDom);
                    }
                    $('<span>', {class:'simple-pill', text:key}).appendTo(summaryDom);
                    first = false;
                }
            }
        }

        function toggleMatch(result) {
            let adding = !matches[result.id];
            if (adding) {
                matches[result.id] = result;
            } else {
                delete matches[result.id];
            }
            let matchesDom = $("#condition-alias-matches");
            matchesDom.empty();

            let keys = Object.keys(matches);
            if (keys.length == 0) {
                $('<div/>', {class: 'no-value w-100 text-center', text: 'None Yet'}).appendTo(matchesDom);
            } else {
                keys.sort();
                for (let key of keys) {
                    let card = makeCard(matches[key]).appendTo(matchesDom);
                    if (key === result.id) {
                        card.collapse('show');
                    }
                }
            }

            let multiple = keys.length >= 2;
            let multipleHandler = $("#multiple-handling");
            if (multiple) {
                multipleHandler.collapse('show');
            } else {
                multipleHandler.collapse('hide');
            }

            let cards = $(`[data-mondo="${result.id}"]`)
            let icon = cards.find('.toggle-icon');
            if (adding) {
                cards.removeClass('possible').addClass('selected');
                icon.removeClass('fa-plus-circle').addClass('fa-minus-circle');
            } else {
                cards.removeClass('selected').addClass('possible');
                icon.removeClass('fa-minus-circle').addClass('fa-plus-circle');
            }
            updateSummary();
        }

        function makeCard(result) {
            let adding = !!matches[result.id];
            let icon = adding ? "minus" : "plus";
            let mode = adding ? "selected" : "possible";
            let htmlWrapper = $(`
                <div class="card selectable-card ${mode} w-100 mb-2" style="cursor:pointer" data-mondo="${result.id}">
                    <div class="card-header"><i class="toggle-icon fas fa-${icon}-circle"></i> ${result.id}</div>
                    <div class="card-body">${result.highlight || result.label}</div>
                </div>
            `);
            let cardBody = htmlWrapper.find('.card-body');
            cardBody.append($('<div>', {class:"text-secondary", text:result.definition || "This MONDO term has not been loaded locally"}));
            htmlWrapper.click(() => {
                toggleMatch(result);
            });
            return htmlWrapper;
        }

        function searchConditions() {
            let text = $('#condition-search-text').val();
            // TODO load URLS
            let url = '{% url "condition_search_api" %}';
            let resultsDom = $("#condition-search-results");
            resultsDom.LoadingOverlay('show');
            $.ajax({
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                data: {
                    "search_term": text
                },
                url: url,
                type: 'GET',
                error: (call, status, text) => {
                    resultsDom.LoadingOverlay('hide');
                    resultsDom.empty();
                    console.log(status);
                    console.log(text);
                    $('<div/>', {class:'no-value w-100 text-center', text:'Error Retrieving'}).appendTo(resultsDom);
                },
                success: async (results) => {
                    $("#search-result-for").text(text);
                    resultsDom.LoadingOverlay('hide');
                    resultsDom.empty();
                    if (results.length) {
                        for (let result of results) {
                            makeCard(result).appendTo(resultsDom);
                        }
                    } else {
                        $('<div/>', {class:'no-value w-100 text-center', text:'No Results'}).appendTo(resultsDom);
                    }
                }
            });
        }

        $(document).ready(() => {
            $("#condition-search-button").click(() => {
                searchConditions();
            });
            $(`[name="multiple-mode"]`).click(() => {
               updateSummary();
            });
            $('#alias-save').click(() => submit(false));
            $('#alias-save-next').click(() => submit(true));

            let matches = {{ matches | jsonify }};
            for (let match of matches) {
                toggleMatch(match);
            }
            searchConditions();
        });
    </script>
{% endblock head %}
{% block content %}
    <div class="container">
        <a href="{% url 'condition_aliases' %}" class="hover-link"><i class="fas fa-angle-left"></i> Back to all aliases</a>
        {% page_help_embedded title='Condition Alias' %}
            <p>
            This page exists because there was one or more classifications with the given lab, gene symbol and condition text combination
            and the condition text did not include an ontology ID e.g. MONDO:0018151.
            </p>
            <p>
            For uploading records to ClinVar an ontology ID must be provided. By searching through MONDO and associating this lab, gene symbol, condition text
            combination to MONDO ids, we will be one step closer to uploading the records to ClinVar.<br/>
            Note that future records that also share that combination will automatically be assigned this alias.
            </p>
            <p>
            Note that the gene symbol is automatically included in searches as many diseases have multiple versions distinguished between which gene is the cause.
            </p>
            <p>
            If the condition text actually relates to two or more conditions, you can search multiple times and add multiple terms.
            If doing that you will need to determine if the matches are all affecting the patient, or if it's just one of them but unsure as to which.
            </p>
        {% end_page_help_embedded %}
        <form id="alias-form" method="post">
            {% csrf_token %}
            <input type="hidden" name="aliases" />
            <input type="hidden" name="join_mode" />
            <input type="hidden" name="next" />
        </form>

        <div class="card">
            <div class="card-header">Condition Alias ({{ condition_alias.id }})</div>
            <div class="card-body">
                {% labelled label="Classification Records Affected" %}{{ condition_alias.records_affected }}{% endlabelled %}
                {% labelled label="Lab" %}{{ condition_alias.lab.name }}{% endlabelled %}
                {% labelled label="Gene Symbol" %}{{ condition_alias.source_gene_symbol }}{% endlabelled %}
                {% labelled label="Text" %}<b>{{ condition_alias.source_text }}</b>{% endlabelled %}
                {% labelled label="Status" %}{{ condition_alias.get_status_display }}{% endlabelled %}
                {% labelled label="Summary" %}
                    <span>
                    <span class="simple-pill">{{ condition_alias.lab.name }}</span>
                    <span class="simple-pill">{{ condition_alias.source_gene_symbol }}</span>
                    <span class="simple-pill">{{ condition_alias.source_text }}</span>
                    </span>
                    <i class="fas fa-arrow-right d-inline-block mx-4"></i>
                    <span id="alias-summary">
                        <span class="simple-pill">?</span>
                    </span>
                {% endlabelled %}
            </div>
            <div class="card-footer">
                <div class="btn-toolbar" style="float:right">
                    <button id="alias-save" class="btn btn-primary">Save</button>
                    <button id="alias-save-next" class="btn btn-primary">Save & Next</button>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-6">
                <h4 class="w-100 text-center my-4">Search Results for "<span id="search-result-for"></span>"</h4>
                {% labelled label="Search MONDO Again Using" %}
                    <div class="input-group">
                        <input class="form-control" type="text" id="condition-search-text" value="{{ condition_alias.source_text }} {{ condition_alias.source_gene_symbol }}" />
                        <span class="input-group-append"><button id="condition-search-button" class="btn btn-primary" name="action">Search</button></span>
                    </div>
                {% endlabelled %}
                <div id="condition-search-results"></div>
            </div>
            <div class="col-6">
                <h4 class="w-100 text-center my-4">Chosen Match(es)</h4>
                <div id="multiple-handling" class="collapse">
                    {% labelled label="Multiple chosen" %}
                    <div class="btn-group btn-group-toggle" data-toggle="buttons">
                        <label class="btn btn-outline-secondary {% if condition_alias.join_mode != "A" %}active{% endif %}">
                            <input type="radio" name="multiple-mode" id="multiple-mode-or" value="or" autocomplete="off" {% if condition_alias.join_mode != "A" %}checked{% endif %}> Uncertain (or)
                        </label>
                        <label class="btn btn-outline-secondary {% if condition_alias.join_mode == "A" %}active{% endif %}">
                            <input type="radio" name="multiple-mode" id="multiple-mode-and" value="and" autocomplete="off" {% if condition_alias.join_mode == "A" %}checked{% endif %}> Combined (and)
                        </label>
                    </div>
                    {% endlabelled %}
                </div>
                <div id="condition-alias-matches">
                    <div class="no-value w-100 text-center">None Yet</div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}