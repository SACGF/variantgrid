{% extends "uicore/page/base.html" %}
{% load crispy_forms_tags %}
{% load static %}
{% load js_tags %}
{% load compress %}
{% load ui_utils %}
{% load ui_help %}
{% load ui_menu_bars %}
{% load settings_tags %}
{% load classification_tags %}
{% load lab_tags %}
{% block title %}Conflicts{% endblock %}
{% block submenu %}{% menu_bar_classifications %}{% endblock submenu %}
{% block head %}
    <style>
        .dt-context {
            width: 25%;
        }
        .dt-c_hgvs {
            width: 23%;
        }
        .dt-severity {
            width: 12%;
        }
        .dt-involved-labs {
            width: 40%;
        }
        .table thead th {
            border-top: none;
        }
    </style>
    <script>
        function renderContext(data, type, row) {
            // return JSON.stringify(data);
            let dom = $('<div>', { style: 'display:inline-block' } );
            dom.append(VCTable.allele_origin_bucket_label(
                data.allele_origin_bucket,
                "",
                "horizontal"));
            if (data.testing_context_bucket !== "G") {
                dom.append($("<span>", {"class": "testing-context", text: data.testing_context_bucket_label}));
            }
            dom.append(" - ")
            dom.append($("<span>", {"class": "text-muted", text: data.conflict_type_label}));
            return dom;
        }
        function renderSeverity(data, type, row) {
            if (data.code == 2) {
                return data.label;
            } else if (data.code <= 1) {
                return $("<span>", {class: 'no-value', text: data.label});
            }
            return $("<div>", {html: [
                $('<a>', {
                    "class": "modal-link-comments",
                    "data-toggle": "ajax-modal",
                    "data-size": "lg",
                    "data-title": "Comments",
                    "data-href": Urls.conflict_comments(data.conflict_id),
                    "text": data.label
                })
            ]});
        }

        const debouncedFilterGrid = debounce(filterGrid);
        function filterGrid() {
            $('#conflicts-datatable').DataTable().ajax.reload();
        }

        function conflictFilter(data) {
            data.lab = "{{ dlab.lab_ids_str }}";
            // data.status = $('#status-tab').val();
            //data.exclude_unknown = $('#filter_unknown').is(":checked");
            //data.multiple_submitters = $('#multiple_submitters').is(":checked");
        }

        function updateStatus(status) {
            // $('#status-tab').val(status);
            debouncedFilterGrid();
        }

        $(document).ready(() => {
            $('.filter-input').change(() => {
               debouncedFilterGrid();
            }).keyup(() => {
               debouncedFilterGrid();
            });
        });
    </script>
{% endblock %}
{% block content %}
    <div class="container">
        {% lab_picker dlab.lab_picker %}

    {% comment %}
        {% labelled label="Filter Out Unknown Contexts" %}
            <div class="ml-4">
                <input type="checkbox" id="filter_unknown" class="form-check-input filter-input" value="true" checked />
                <label for="filter_unknown">Filters out overlaps for unknown allele origin / testing context</label>
            </div>
        {% endlabelled %}
        {% labelled label="Relevant Differences" %}
            <div class="ml-4">
                <input type="checkbox" id="relevant_diff" class="form-check-input filter-input" value="true" checked />
                <label for="relevant_diff">Only include overlaps with relevant differences (e.g. exclude LB vs B)</label>
            </div>
        {% endlabelled %}
        <input id="status-tab" type="hidden" value="T" />

        <div id="conflict_tabs">
            <ul class="nav nav-tabs" role="tablist" style="position: relative; bottom: -6px;">
                <li class="nav-item"><a class="nav-link show active" data-tab-set="conflict_tabs" data-toggle="tab" id="tawaiting-triage-tab" role="tab" onclick="updateStatus('T')">
                    Awaiting Triage <span class="d-inline-block ml-1 badge badge-info">{{ status_counts.T }}</span>
                </a></li>
                <li class="nav-item"><a class="nav-link" data-tab-set="conflict_tabs" data-toggle="tab" id="tready-to-discuss-tab" role="tab" onclick="updateStatus('D')">
                    Ready to Discuss <span class="d-inline-block ml-1 badge badge-info">{{ status_counts.D }}</span>
                </a></li>
                <li class="nav-item"><a class="nav-link" data-tab-set="conflict_tabs" data-toggle="tab" id="tawaiting-amendment-tab" role="tab" onclick="updateStatus('A')">
                    Awaiting Amendment <span class="d-inline-block ml-1 badge badge-info">{{ status_counts.A }}</span>
                </a></li>
                <li class="nav-item"><a class="nav-link not-important" data-tab-set="conflict_tabs" data-toggle="tab" id="twaiting-on-other-lab-tab" role="tab" onclick="updateStatus('O')">
                    Waiting on Other Lab <span class="d-inline-block ml-1 badge badge-info">{{ status_counts.O }}</span>
                </a></li>
                <li class="nav-item"><a class="nav-link not-important" data-tab-set="conflict_tabs" data-toggle="tab" id="tcomplex-tab" role="tab" onclick="updateStatus('C')">
                    Complex <span class="d-inline-block ml-1 badge badge-info">{{ status_counts.C }}</span>
                </a></li>
                <li class="nav-item"><a class="nav-link not-important" data-tab-set="conflict_tabs" data-toggle="tab" id="discordance_reports_history_detail-tab" role="tab" onclick="updateStatus('Z')">
                    Resolved <span class="d-inline-block ml-1 badge badge-info">{{ status_counts.Z }}</span>
                </a></li>
            </ul>
        </div>
{% endcomment %}
        <table id="conflicts-datatable"
               data-datatable-url="{% url 'conflicts_datatables' %}"
               data-datatable-data='conflictFilter'
               class="sticky-header classification-table"
               data-adjust-columns="false"
        ></table>
    </div>
{% endblock %}