{% extends "uicore/page/base.html" %}
{% load datatable_tags %}
{% load classification_tags %}
{% load ui_menu_bars %}
{% load ui_help %}
{% load ui_utils %}
{% load ui_tabs_builder %}
{% load english_tags %}
{% load js_tags %}
{% block title %}Clinvar Export{% endblock %}
{% block submenu %}{% menu_bar_classifications %}{% endblock submenu %}
{% block head %}
    <style>
        .term-cell {
            width: 200px;
        }
        .relevance-cell {
            width: 250px;
        }
        .relevance-cell div + div {
            margin-top: 0.5rem;
        }
        .description-cell {
            white-space: pre-line;
            overflow-wrap: break-word;
        }
        /* need to do this for checkboxes inside tabs */
        td {
            position: relative;
        }
    </style>
    <script>
        let mondos = {{ ontology_terms | jsonify }};

        const gene_symbol = "{{ clinvar_export.gene_symbol }}";
        const basicHighlight = ["autosomal", "x-linked", "recessive", "dominant", gene_symbol];
        const basicHighlightStr = basicHighlight.join("|");
        const highlightRegex = new RegExp(`(${basicHighlightStr})`, 'g');

        function highlightDescription(description) {
            if (!description) {
                return description;
            }
            return description.replace(highlightRegex, "<b>$1</b>")
        }

        function mergeIn(ontology) {
            let existing = mondos[ontology.id];
            if (!existing) {
                mondos[ontology.id] = ontology;
            } else {
                Object.assign(existing.contexts, ontology.contexts);
            }
        }

        function search() {
            let text = $('#condition-search-text').val();
            // TODO load URLS
            let url = '{% url "api_mondo_search" %}';
            let resultsDom = $("#ontology_table");
            resultsDom.LoadingOverlay('show');
            $.ajax({
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                data: {
                    "search_term": text,
                    "gene_symbol": gene_symbol
                },
                url: url,
                type: 'GET',
                error: (call, status, text) => {
                    resultsDom.LoadingOverlay('hide');
                    renderOntologies();
                    console.log(status);
                    console.log(text);
                    // $('<div/>', {class:'no-value w-100 text-center', text:'Error Retrieving'}).appendTo(resultsDom);
                    // FIXME show errors
                },
                success: async (results) => {
                    resultsDom.LoadingOverlay('hide');
                    Object.values(mondos).forEach((item) => {
                        delete item.contexts["searched"];
                    });
                    let mondo_list = Object.values(mondos).filter((item) => {
                        return Object.keys(item.contexts).length > 0;
                    });
                    mondos = {}

                    for (let value of mondo_list.concat(Object.values(results))) {
                        mergeIn(value);
                    }

                    renderOntologies();
                    $("#ontology_table");
                }
            });
        }

        // TODO, should the JSON coming down be in a more general format that can always be rendered the same?
        function renderContext(title, context) {
            if (title == "selected") {
                return null; // redundant to checkbox, so no need to show it here
            }
            if (title == "searched") {
                return $('<div>', {html: [
                        $(`<i class="fas fa-circle text-secondary"></i>`),
                        $('<span>', {text: "Text search" })
                ]});
            }
            if (title == "referenced") {
                return $('<div>', {html: [
                        $(`<i class="fas fa-circle text-dark"></i>`),
                        $('<span>', {text: "Referenced in Condition Text" })
                ]});
            }
            if (title == "similar_match") {
                return $('<div>', {html: [
                    $(`<i class="fas fa-circle text-primary"></i>`),
                    $('<span>', {text: `Selected by another record for same text${context.matches_gene ? ' and gene symbol' : ''}` }),
                    " ",
                    // FIXME use URLS
                    $('<a>', {href:`/classification/clinvar_export/${context.vce_id}`, target:"_blank", text:"View other export"})
                ]});
            }
            if (title == "Monarch") {
                return $('<div>', {html: [
                        $(`<i class="fas fa-circle text-success"></i>`),
                        $('<span>', {text: title }),
                        " ",
                        $('<span>', {class: 'text-muted', text: `${context.relation} ${context.gene_symbol}`})
                ]});
            } else if (title == "PanelApp AU") {
                let evidence = context.evidence.join(", ");
                return $('<div>', {html: [
                        $(`<i class="fas fa-circle text-success"></i>`),
                        $('<span>', {text: title }),
                        " ",
                        $('<span>', {class: 'hover-detail text-muted', text: `${context.phenotype_row}`, title: evidence})
                ]});
            }
        }

        function toggleSelection(onto) {
            let isSelected = !!onto.contexts.selected;
            if (isSelected) {
                delete onto.contexts.selected;
            } else {
                onto.contexts.selected = true;
            }
            updateMultiModeVisibility();
        }

        function updateMultiModeVisibility() {
            let selected = Object.values(mondos).filter(onto => !!onto.contexts.selected);
            let resolvedDom;
            if (selected.length === 0) {
                resolvedDom = $('<div>', {class: 'no-value', text: 'No selection yet'})
            } else {
                resolvedDom = $('<div>', {class: 'pills'});
                if (selected.length >= 2) {
                    // TODO load actual value
                    let label = {
                        "N": "Multi-Term Operation Required",
                        "U": "Uncertain",
                        "C": "Co-occuring"
                    }[$('[name=multimode]:checked').val()];
                    $('<span>', {text: label + ": "}).appendTo(resolvedDom);
                }

                for (let term of selected) {
                    $('<a>', {
                        href: term.url,
                        text: term.id,
                        target: '_blank',
                        class: 'external-link',
                        title: term.name,
                        "data-toggle": 'tooltip'
                    }).appendTo(resolvedDom);
                }
            }

            $('#resolved_condition').empty().append(resolvedDom);
            let selectedCount = Object.values(mondos).filter(onto => !!onto.contexts.selected).length;
            if (selectedCount >= 2) {
                $('#multimode').collapse('show');
                $('#singlemode').collapse('hide');
            } else {
                $('#multimode').collapse('hide');
                $('#singlemode').collapse('show');
            }
        }

        function ontologyTr(onto) {
            let row = $('<tr>');
            let checkbox = $('<input>', {type:'checkbox', class:'form-check-input'});
            checkbox.click(() => {
                this.toggleSelection(onto);
            });
            if (onto.contexts.selected) {
                checkbox.attr('checked', 'checked');
            }
            $('<td>', {html:checkbox, class:'text-center'}).appendTo(row);

             $('<td>', {class: 'term-cell', html:[
                $('<a>', {class: 'external-link', target:'blank', href:onto.url, text:onto.id}),
                $('<br>'),
                onto.title
            ]}).appendTo(row);

            let contexts = $('<td>', {class: 'relevance-cell'});
            for (let [title, context] of Object.entries(onto.contexts)) {
                let contextBox = renderContext(title, context);
                if (contextBox) {
                    contextBox.appendTo(contexts);
                }
            }

            contexts.appendTo(row);

            $('<td>', {class:'description-cell text-muted', html: highlightDescription(onto.definition)}).appendTo(row);

            return row;
        }

        function renderOntologies() {
            // FIXME some kind of sensible ordering
            let selected = [];
            sortedOntos = Object.values(mondos);
            sortedOntos.sort((a, b) => {
                let scoreOnto = (onto) => {
                    let score = 0;
                    if (onto.contexts["referenced"]) {
                        score += 100;
                    }
                    if (onto.contexts["selected"]) {
                        score += 1000;
                    }
                    if (onto.contexts["PanelApp AU"]) {
                        score += 3;
                    }
                    if (onto.contexts["Monarch"]) {
                        score += 2;
                    }
                    if (onto.contexts["searched"]) {
                        score += 1;
                    }
                    return score;
                }
                let score1 = scoreOnto(a);
                let score2 = scoreOnto(b);
                if (score1 == score2) {
                    return (a.name || '').localeCompare((b.name || ''));
                } else {
                    return score2 - score1;
                }
            });

            let tbody = $('#ontology_table tbody');
            tbody.empty();
            for (let onto of Object.values(sortedOntos)) {
                ontologyTr(onto).appendTo(tbody);
            }
        }

        function submit() {
            let form = $('#clinvar_form');
            let selected = Object.values(mondos).filter(onto => !!onto.contexts.selected).map(onto => onto.id);
            form.find('[name=terms]').val(selected.join(","));
            form.find('[name=multimode]').val($('#multimode input[name=multimode]:checked').val());
            form.find('[name=apply').val($('#saveModal input[name=applyLevel]:checked').val());
            form.submit();
        }

        $(document).ready(() => {
            renderOntologies();
            updateMultiModeVisibility();
            $('#submission_json').text(JSON.stringify({{ clinvar_export.as_json | jsonify }}, null, 4));
            $('#condition-search-button').click(() => search());
            $('[name=multimode]').click(() => updateMultiModeVisibility());
            search();
        });
    </script>
{% endblock %}
{% block content %}
    <form method="POST" id="clinvar_form">
        {% csrf_token %}
        <input type="hidden" name="terms" />
        <input type="hidden" name="multimode" />
        <input type="hidden" name="apply" />
    </form>
    <div class="container">
        <a href="{% url 'clinvar_exports' %}" class="hover-link"><i class="fas fa-angle-left"></i> Back to all ClinVar Exports</a>
        <h3>ClinVar Export</h3>
        {% page_help_embedded title='ClinVar Export' %}
            <p>
            Help will go here for exporting to Clinvar
            </p>
        {% end_page_help_embedded %}

        <div class="modal fade" id="saveModal" tabindex="-1" aria-labelledby="saveModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="saveModalLabel">Save</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                Apply condition terms to:

                  <div class="list-group mt-2">
                      <label class="list-group-item list-group-item-action"><input type="radio" name="applyLevel" value="record" class="mr-2" checked>To this record only</label>
                      <label class="list-group-item list-group-item-action"><input type="radio" name="applyLevel" value="gene_symbol" class="mr-2">As default for records with condition text "<span class="text-muted">{{ clinvar_export.condition_text_normal }}</span>" and Gene {{ clinvar_export.gene_symbol }}
                      <div class="text-muted">{% count same_text_gene_vcs singular="1 other existing ClinVar Export" plural="other existing ClinVar Exports" %}</div>
                      </label>
                      <label class="list-group-item list-group-item-action"><input type="radio" name="applyLevel" value="text" class="mr-2">As default for records with condition text "<span class="text-muted">{{ clinvar_export.condition_text_normal }}</span>"
                      <div class="text-muted">{% count same_text_vcs singular="1 other existing ClinVar Export" plural="other existing ClinVar Exports" %}</div>
                      </label>
                  </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="submit()">Apply Changes</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">Summary</div>
            <div class="card-body">
                {% labelled label="Genome Build" %}{{ clinvar_export.genome_build }}{% endlabelled %}
                {% labelled label="c.hgvs" %}{{ clinvar_export.c_hgvs }}{% endlabelled %}
                {% labelled label="Source Classification" %}<a href="{% url 'view_classification' clinvar_export.classification_based_on.id_str %}" target="_blank">{{ clinvar_export.classification_based_on.classification.friendly_label }}</a>{% endlabelled %}
                {% labelled label="Curated" %}{{ clinvar_export.curated_date }}{% endlabelled %}
                {% labelled label="Clinical Significance" %}{{ clinvar_export.clinical_significance }}{% endlabelled %}
                {% labelled label="Resolved Condition(s)" id="resolved_condition" %}...{% endlabelled %}
                {% labelled label="Submit" %}
                    <div class="btn-group btn-group-toggle" data-toggle="buttons">
                        <label class="btn btn-outline-secondary"><input type="radio" name="submit_when_possible" value="true" {% if not clinvar_export.submit_when_possible %}checked="checked"{% endif %}>Under Review</label>
                        <label class="btn btn-outline-secondary"><input type="radio" name="submit_when_possible" value="false" {% if clinvar_export.submit_when_possible %}checked="checked"{% endif %}>Auto-Submit When Ready</label>
                    </div>
                {% endlabelled %}
            </div>
            <div class="card-footer">
                <btn class="btn btn-primary" data-toggle="modal" data-target="#saveModal">Save</btn>
            </div>
        </div>
        {% ui_register_tab_embedded label="Condition Matcher" tab_set="clinvar_tabs" %}
            {% labelled label="Condition Text" %}{{ clinvar_export.condition_text_normal }} - <span class="text-muted">{% count same_text_vcs singular="1 other classification" plural="other classifications" %} with the same text</span>{% endlabelled %}
            {% labelled label="Gene Symbol" %}{{ clinvar_export.gene_symbol }} - <span class="text-muted">{% count same_text_gene_vcs singular="1 other classification" plural="other classifications" %} with the same text and gene symbol</span>{% endlabelled %}
            {% labelled label="Mode of Inheritance" %}{{ clinvar_export.mode_of_inheritance }}{% endlabelled %}
            {% labelled label="Search Text" %}
                <div class="input-group">
                    <input class="form-control" type="text" id="condition-search-text" value="{{ clinvar_export.condition_text_normal }} {{ clinvar_export.gene_symbol }}" />
                    <span class="input-group-append"><button id="condition-search-button" class="btn btn-outline-primary" name="action">Search</button></span>
                </div>
            {% endlabelled %}
            {% labelled label="Multi-Term Operation" %}
                <div id="multimode" class="collapse">
                    <div class="btn-group btn-group-toggle" data-toggle="buttons">
                        <label class="btn btn-outline-secondary"><input type="radio" name="multimode" id="multimode-n" value="N" {% if clinvar_export.condition_multi_operation == "N" %}checked="checked"{% endif %}>Multi-Term Operation Required</label>
                        <label class="btn btn-outline-secondary"><input type="radio" name="multimode" id="multimode-u" value="U" {% if clinvar_export.condition_multi_operation == "U" %}checked="checked"{% endif %}>Uncertain</label>
                        <label class="btn btn-outline-secondary"><input type="radio" name="multimode" id="multimode-c" value="C" {% if clinvar_export.condition_multi_operation == "C" %}checked="checked"{% endif %}>Co-occuring</label>
                    </div>
                </div>
                <div id="singlemode" class="collapse no-value">N/A</div>
            {% endlabelled %}
            <label>Select Relevant Ontology Terms Below</label>
            <table class="table" id="ontology_table">
                <thead>
                    <tr>
                        <th>Include</th>
                        <th class="term-cell">Term</th>
                        <th class="relevance-cell">Relevance</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>

                </tbody>
            </table>
        {% end_ui_register_tab_embedded %}
        {% ui_register_tab_embedded label="Other Details" tab_set="clinvar_tabs" %}
            {% labelled label="Allele Origin" %}{{ clinvar_export.allele_origin }}{% endlabelled %}
            {% labelled label="Affected Status" %}{{ clinvar_export.affected_status }}{% endlabelled %}
            {% comment %}TODO format intepretations summary with new lines{% endcomment %}
            {% labelled label="Interpretation Summary" class="formatted-text"%}<div class="formatted-text">{{ clinvar_export.interpretation_summary }}</div>{% endlabelled %}
            {% labelled label="Mode of Inheritance" %}{{ clinvar_export.mode_of_inheritance }}{% endlabelled %}
            {% labelled label="Assertion Method" %}{{ clinvar_export.assertion_method }}{% endlabelled %}
            {% labelled label="Curation Context" %}{{ clinvar_export.curation_context }}{% endlabelled %}
            {% labelled label="Citations" %}
                <div class="pills">
                {% for ref_data in clinvar_export.citation_refs %}
                    {% db_ref data=ref_data %}
                {% endfor %}
                </div>
            {% endlabelled %}
            <h4>Export Preview</h4>
            <p class="text-muted">This is how the data will be submitted to ClinVar</p>
            <div class="code formatted-text" id="submission_json">
            </div>
        {% end_ui_register_tab_embedded %}

        {% ui_register_tab_embedded label="Submission History" tab_set="clinvar_tabs" %}
            Submission is not yet implemented.
        {% end_ui_register_tab_embedded %}

        {% ui_render_tabs tab_set="clinvar_tabs" %}
    </div>
{% endblock %}