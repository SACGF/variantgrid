{% extends "uicore/page/base.html" %}
{% load crispy_forms_tags %}
{% load static %}
{% load js_tags %}
{% load english_tags %}
{% load compress %}
{% load ui_help %}
{% load ui_utils %}
{% load ui_menu_bars %}
{% load ui_tabs_builder %}
{% load lab_tags %}
{% load classification_tags %}
{% block title %}Classification Dashboard{% endblock %}
{% block submenu %}{% menu_bar_classifications %}{% endblock submenu %}
{% block content %}
<script type="text/javascript" src="{% static 'js/lib/plotly-latest.min.js' %}"></script>
<script type="text/javascript" src="{% static 'js/plotly_helper.js' %}"></script>
<script>
    // for showing issues
    function classificationMatchingVariant(data) {
        data.flags = JSON.stringify(['classification_matching_variant', 'classification_matching_variant_warning', 'classification_transcript_version_change']);
        data.labs = {{ dlab.lab_ids_str | jsonify }};
    }
    function classificationComments(data) {
        data.flags = JSON.stringify(['classification_suggestion', 'classification_internal_review', 'classification_significance_change']);
        data.labs = {{ dlab.lab_ids_str | jsonify }};
    }
    function classificationUnshared(data) {
        data.flags = JSON.stringify(['classification_unshared']);
        data.labs = {{ dlab.lab_ids_str | jsonify }};
    }
    function classificationWithdrawn(data) {
        data.flags = JSON.stringify(['classification_withdrawn']);
        data.labs = {{ dlab.lab_ids_str | jsonify }};
    }
    function classificationExcludeClinVar(data) {
        data.flags = JSON.stringify(['classification_not_public']);
        data.labs = {{ dlab.lab_ids_str | jsonify }};
    }
    $(document).ready(() => {
        $('a[data-toggle="tab"]').on('shown.bs.tab', function (event) {
            Flags.instance.init({userId: '{{user.id}}', filter: '.active', forceRender: true});
        });
        $('.dataTable').on('draw.dt', () => {
            Flags.instance.init({userId: '{{user.id}}', filter: '.active', forceRender: true});
        });

        $('input[name=discordances-filter]').click(() => {
            let selected = $("input[name=discordances-filter]:checked").val();

            $('.contact-details').hide();
            $(`.contact-details[data-lab=${selected}]`).show();
            $('.discordance-row').each((index, row) => {
                row = $(row);
                let show = false;
                if (selected == "all") {
                    show = true;
                } else {
                    let data_labs = row.attr('data-labs')
                    if (selected == "internal") {
                        show = data_labs == 'internal'
                    } else {
                        let labs = data_labs.split(";");
                        show = labs.includes(selected);
                    }
                }
                if (show) {

                    row.show();
                } else {

                    row.hide();
                }
            });
        });
    });
</script>
<div class="container">
    {% lab_picker view_name="classification_dashboard" selected_lab=dlab.lab_id all_option=True %}
</div>
<div class="container">
    {% if not dlab.lab_id %}
        {% labelled row_css="my-4" label="Email Preview" admin_only=True %}
            <div class="link-toolbar">
                <a class="download-link type-csv" href="{% url 'summary_email_html' %}">HTML</a>
                <a class="download-link type-json" href="{% url 'summary_email_text' %}">TEXT</a>
            </div>
        {% endlabelled %}
    {% endif %}

    {% if use_shared %}
        {% page_help_embedded title="Shared Classifications Over Time" %}
            This graphs shows how many shared classifications your lab has submitted over time.
        {% end_page_help_embedded %}

        <div data-toggle="ajax" href="{% url 'classification_dashboard_graph_detail' dlab.lab_id %}">
            <div class="loading-message" style="height:381px">Loading Graph</div>
        </div>
        <div>
            <label>See recent activity for</label>: {% for lab in dlab.labs %}{% if not forloop.first %}, {% endif %}<a href="{% url 'activity_lab' lab.pk %}">{% lab lab %}</a>{% endfor %}
        </div>

        {% comment %}section only makes sense for where Shared is king{% endcomment %}
        {% page_help_embedded title="Classification Counts" %}
            <p>
            See the grand total of classifications provided by your lab, the progress of ClinVar submissions, and a comparison between your lab's classifications and ClinVar's.
            </p>

        {% end_page_help_embedded %}

        {% labelled hint="tiny" label="Matched & Shared Classifications" %}
            {{ dlab.shared_classifications.count | number:'S' }}
        {% endlabelled %}

        {% labelled hint="tiny"  label="Unique Alleles" %}
            {{ dlab.unique_classified_alleles_count | number:'S' }}
        {% endlabelled %}
        {% if 'clinvar_key_summary'|is_view_enabled %}
            {% labelled hint="tiny"  label="Classifications Uploaded to Clinvar" %}
                {% if dlab.clinvar_keys %}
                    {{ dlab.uploads_to_clinvar_qs.count | number:'S' }}
                    {% for clinvar_key in dlab.clinvar_keys %}
                        <a class="hover-link" href="{% url 'clinvar_key_summary' clinvar_key.id %}"><small class="form-text">Review {{ clinvar_key.label }} ClinVar submissions here</small></a>
                    {% endfor %}
                {% else %}
                    <span class="text-muted">Your {% plural dlab.labs singular="lab is" plural="labs are" %} not configured for ClinVar.</span>
                {% endif %}
            {% endlabelled %}
        {% endif %}

        {% if 'condition_matchings_lab'|is_view_enabled %}
            {% labelled hint="tiny"  label="Classifications without Standard Condition" %}
                {{ dlab.classifications_wout_standard_text | number:'W' }}
                <a class="hover-link" href="{% url 'condition_matchings_lab' dlab.lab_id %}"><small class="form-text">Review your lab's unresolved condition text here</small></a>
            {% endlabelled %}
        {% endif %}

        {% labelled hint="tiny" label="Downloads" %}
            <a href="{{ dlab.compare_to_clinvar_url }}" class="download-link">Classifications compared with ClinVar</a>
        {% endlabelled %}

    {% endif %}

    {% if 'discordance_report'|is_view_enabled %}
        {% page_help_embedded title="Outstanding Discordances" %}
            <p>Below is a list of all outstanding discordances where your lab is involved.</p>
             <p>If you have discordances you can filter based on which other labs are involved - which will also display any contact details that lab has provided for resolving discordances.</p>
        {% end_page_help_embedded %}

        {% if not dlab.discordance_summaries %}
            <div class="no-value">There are no outstanding discordances for this lab {{ 'S' | severity_icon }}</div>
        {% else %}

            <ul class="list-group mb-4">
                <li class="list-group-item">
                    <label class="form-check" for="discordances-filter-all">
                        <input class="form-check-input" type="radio" name="discordances-filter" id="discordances-filter-all" value="all" checked />
                        <span class="form-check-label">
                        {% if summaries.count == 1 %}
                            Show the 1 discordance
                        {% else %}
                            Show all {{ dlab.discordance_summaries.summaries.count }} discordances <span class="text-info">(Use the below filters to show discordances with specific labs)</span>
                        {% endif %}
                        </span>
                    </label>
                </li>
                {% for lab_count in dlab.discordance_summaries.counts %}
                <li class="list-group-item">
                    {% if lab_count.is_internal %}
                        <label class="form-check" for="discordances-filter-internal">
                            <input class="form-check-input" type="radio" name="discordances-filter" id="discordances-filter-internal" value="internal" />
                            <span class="form-check-label">

                                Discordances only within {{ dlab.discordance_summaries.labs_quick_str }} account for <strong>{{ lab_count.count }}</strong> of these discordances
                            </span>
                        </label>
                    {% else %}
                        <label class="form-check" for="discordances-filter-{{ lab_count.lab.pk }}">
                            <input class="form-check-input" type="radio" name="discordances-filter" id="discordances-filter-{{ lab_count.lab.pk }}" value="{{ lab_count.lab.pk }}" />
                            <span class="form-check-label">
                                <span style="font-weight:500">{% lab lab_count.lab %}</span> are involved in <strong>{{ lab_count.count }}</strong> of these discordances
                            </span>
                            {% with contact=lab_count.lab.contact_details %}
                                {% if contact %}
                                    <div class="float-right">
                                        {% if contact.website %}<i class="fas fa-globe"></i>{% endif %}
                                        {% if contact.email %}<i class="fas fa-envelope"></i>{% endif %}
                                        {% if contact.phone %}<i class="fas fa-phone"></i>{% endif %}
                                    </div>
                                {% endif %}
                            {% endwith %}
                        </label>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>

            {% for lab_count in dlab.discordance_summaries.counts %}
                {% with lab=lab_count.lab %}
                    {% if lab.id != dlab.lab_id %}
                        {% with contact=lab.contact_details %}
                            {% if contact %}
                                <div class="contact-details mb-4" style="display:none" data-lab="{{ lab.id }}">

                                    {% if contact.website %}
                                        {% labelled label="Website" hint="tiny" %}<a href="{{ contact.website }}">{{ contact.website }}</a>{% endlabelled %}
                                    {% endif %}
                                    {% if contact.name %}
                                        {% labelled label="Contact Person" hint="tiny" %}{{ contact.name }}{% endlabelled %}
                                    {% endif %}
                                    {% if contact.phone %}
                                        {% labelled label="Contact Phone" hint="tiny" %}{{ contact.phone }}{% endlabelled %}
                                    {% endif %}
                                    {% if contact.email %}
                                        {% labelled label="Contact Email" hint="tiny" %}<a href="mailto:{{ contact.email }}">{{ contact.email }}</a>{% endlabelled %}
                                    {% endif %}
                                </div>
                            {% endif %}
                        {% endwith %}
                    {% endif %}
                {% endwith %}
            {% endfor %}


            <table class="table">
                <thead>
                    <tr>
                        <th style="width:100px">ID</th>
                        <th class="text-left">Discordance Detected</th>
                        <th class="text-left">c.HGVS ({{ genome_build.name }})</th>
                        <th class="text-left" style="width:40%">Lab / Clinical Significances</th>
                    </tr>
                </thead>
                <tbody>
                {% for summary in dlab.discordance_summaries.summaries %}
                {% comment %}TODO fix internal{% endcomment %}
                    <tr class="discordance-row" data-labs="{% if summary.is_internal %}internal{% else %}{{ summary.all_actively_involved_labs_ids }}{% endif %}">
                        <td class="text-center"><a href="{% url 'discordance_report' summary.discordance_report.id %}" class="hover-link">DR_{{ summary.discordance_report.id }}</a></td>
                        <td>{% timestamp summary.discordance_report.created %}</td>
                        <td>{% for c_hgvs_val in summary.c_hgvses %}
                            <div>{% c_hgvs c_hgvs_val %}</div>
                            {% endfor %}

                        </td>
                        <td style="width:40%">{% for lab_summ in summary.lab_significances %}
                            <div>
                                <span class="d-inline-block mr-2" style="min-width:150px">{% lab lab_summ.lab your_lab=lab_summ.is_internal %}</span>
                                {% for cs in lab_summ.clinical_significances %}{% clinical_significance cs %}{% endfor %}
                            </div>
                            {% endfor %}
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        {% endif %}

    {% endif %}



    {% page_help_embedded title="Flagged Classifications" %}
        <p>
            This section show you how many classifications belonging to your lab(s) that have flags raised against them.<br/>
            Click "Show details" to see the specific classifications.<br/>
            Clicking on each flag will give you instructions on what needs to be done to resolve it.
        </p><p>
            Flags range from issues with variant matching, to discordances or suggestions.
        </p>
    {% end_page_help_embedded %}

    {% if dlab.counts.internal_review %}{% labelled hint="tiny" label="Outstanding Internal Reviews" %}{{ dlab.counts.internal_review | number:'I' }}{% endlabelled %}{% endif %}
    {% if dlab.counts.significance_change %}{% labelled hint="tiny" label="Outstanding Clinical Significance Changes" %}{{ dlab.counts.significance_change | number:'W' }}{% endlabelled %}{% endif %}
    {% if dlab.counts.clinvar_exclude %}{% labelled hint="tiny" label="Classifications Excluded from ClinVar" %}{{ dlab.counts.clinvar_exclude | number }}{% endlabelled %}{% endif %}

    <p><a href="#flagged-classifications" class="toggle-link" data-toggle="collapse">Show details</a></p>

    <div id="flagged-classifications" class="collapse">
        <p><br/><a class="download-link type-csv" href="{% url 'classification_dashboard_download' dlab.lab_id %}">Download all issues requiring action</a></p>

        <p class="text-info">For instructions on how to fix the outstanding actions, click on the icons in the flag column for each classification.</p>

        <div class="mt-4">

            {% ui_register_tab_embedded tab_set="classification_issues" label="Suggestion/Internal Review/Clin Change" badge=dlab.counts.comments %}
                <table id="classifications-comment" data-datatable-url="{% url 'classification_datatables' %}" class="sticky-header classification-table" data-datatable-data="classificationComments"></table>
            {% end_ui_register_tab_embedded %}

            {% ui_register_tab_embedded tab_set="classification_issues" label="Variant Matching Issues" badge=dlab.counts.variant_matching %}
                <table id="classifications-matching" data-datatable-url="{% url 'classification_datatables' %}" class="sticky-header classification-table" data-datatable-data="classificationMatchingVariant"></table>
            {% end_ui_register_tab_embedded %}

            {% ui_register_tab_embedded tab_set="classification_issues" label="Unshared" badge=dlab.counts.unshared %}
                <table id="classifications-unshared" data-datatable-url="{% url 'classification_datatables' %}" class="sticky-header classification-table" data-datatable-data="classificationUnshared"></table>
            {% end_ui_register_tab_embedded %}

            {% if clinvar_export_enabled %}
                {% ui_register_tab_embedded tab_set="classification_issues" label="Exclude from ClinVar" badge=dlab.counts.clinvar_exclude %}
                    <table id="classifications-exclude-clinvar" data-datatable-url="{% url 'classification_datatables' %}" class="sticky-header classification-table" data-datatable-data="classificationExcludeClinVar"></table>
                {% end_ui_register_tab_embedded %}
            {% endif %}

            {% ui_register_tab_embedded tab_set="classification_issues" label="Withdrawn" badge=dlab.counts.withdrawn %}
                <table id="classifications-withdrawn" data-datatable-url="{% url 'classification_datatables' %}" class="sticky-header classification-table" data-datatable-data="classificationWithdrawn"></table>
            {% end_ui_register_tab_embedded %}

            {% ui_render_tabs tab_set="classification_issues" %}
        </div>
    </div>

</div>
{% endblock content %}