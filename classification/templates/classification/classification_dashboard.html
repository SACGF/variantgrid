{% extends "uicore/page/base.html" %}
{% load crispy_forms_tags %}
{% load static %}
{% load js_tags %}
{% load compress %}
{% load datatable_tags %}
{% load ui_help %}
{% load ui_menu_bars %}
{% load ui_tabs_builder %}
{% block title %}Classification Issues{% endblock %}
{% block submenu %}{% menu_bar_classifications %}{% endblock submenu %}
{% block head %}
    <script>
    function classificationDiscordant(data) {
        data.flags = JSON.stringify(['classification_discordant']);
        data.my_labs = "true";
    }
    function classificationMatchingVariant(data) {
        data.flags = JSON.stringify(['classification_matching_variant', 'classification_matching_variant_warning', 'classification_transcript_version_change']);
        data.my_labs = "true";
    }
    function classificationComments(data) {
        data.flags = JSON.stringify(['classification_suggestion', 'classification_internal_review', 'classification_significance_change']);
        data.my_labs = "true";
    }
    function classificationUnshared(data) {
        data.flags = JSON.stringify(['classification_unshared']);
        data.my_labs = "true";
    }
    function classificationWithdrawn(data) {
        data.flags = JSON.stringify(['classification_withdrawn']);
        data.my_labs = "true";
    }

    $(document).ready(() => {
        EKeys.load().then(() => {
            $('a[data-toggle="tab"]').on('shown.bs.tab', function (event) {
                Flags.instance.init({userId: '{{user.id}}', filter: '.active', forceRender: true});
            });

            {% datatable_definition table_config=datatable_config data='classificationDiscordant' table_id='classifications-discordant' url='classification_datatables' %}
            {% datatable_definition table_config=datatable_config data='classificationMatchingVariant' table_id='classifications-matching' url='classification_datatables' %}
            {% datatable_definition table_config=datatable_config data='classificationComments' table_id='classifications-comment' url='classification_datatables' %}
            {% datatable_definition table_config=datatable_config data='classificationUnshared' table_id='classifications-unshared' url='classification_datatables' %}
            {% datatable_definition table_config=datatable_config data='classificationWithdrawn' table_id='classifications-withdrawn' url='classification_datatables' %}

            $('.dataTable').on('draw.dt', () => {
                Flags.instance.init({userId: '{{user.id}}', filter: '.active', forceRender: true});
            });
        });
    });
    </script>
{% endblock %}

{% block content %}
    <div class="container-table" id="dashboard-links">
        {% page_help_embedded page_id='classification/issues_help' title='Classification Issues' %}
            <p>
                This page will list all classifications belonging to your lab/s that have flags raised against them.<br/>
                Each classification flag indicates that there is an action that needs to be performed against the classification.<br/>
                Clicking on each flag will give you instructions on what needs to be done to resolve it.
            </p>
            <p>
                Flags range from issues with variant matching, to discordances or suggestions.<br/>
            </p>
        {% end_page_help_embedded %}
        <p>For instructions on how to fix the outstanding actions, click on the icons in the flag column for each classification.</p>
        {% if user.is_superuser %}
        <div class="admin-only my-4">
            Email preview:
            <a href="{% url 'summary_email_html' %}" class="hover-link">HTML</a>,
            <a href="{% url 'summary_email_text' %}" class="hover-link">TEXT</a>
        </div>
        {% endif %}
        <a class="btn btn-outline-primary" href="{% url 'classification_dashboard_download' %}"><i class="fas fa-file-csv"></i> Download all issues requiring action</a>

        <div class="mt-4">
            {% ui_register_tab_embedded tab_set="classification_issues" label="Discordance" badge=counts.classifications.discordant %}
                {% datatable table_config=datatable_config table_id='classifications-discordant' class_name='sticky-header classification-table' %}
            {% end_ui_register_tab_embedded %}

            {% ui_register_tab_embedded tab_set="classification_issues" label="Suggestion/Internal Review/Clin Change" badge=counts.classifications.comments %}
                {% datatable table_config=datatable_config table_id='classifications-comment' class_name='sticky-header classification-table' %}
            {% end_ui_register_tab_embedded %}

            {% ui_register_tab_embedded tab_set="classification_issues" label="Variant Matching Issues" badge=counts.classifications.variant_matching %}
                {% datatable table_config=datatable_config table_id='classifications-matching' class_name='sticky-header classification-table' %}
            {% end_ui_register_tab_embedded %}

            {% ui_register_tab_embedded tab_set="classification_issues" label="Unshared" badge=counts.classifications.unshared %}
                {% datatable table_config=datatable_config table_id='classifications-unshared' class_name='sticky-header classification-table' %}
            {% end_ui_register_tab_embedded %}

            {% ui_register_tab_embedded tab_set="classification_issues" label="Withdrawn" badge=counts.classifications.withdrawn %}
                {% datatable table_config=datatable_config table_id='classifications-withdrawn' class_name='sticky-header classification-table' %}
            {% end_ui_register_tab_embedded %}


            {% ui_render_tabs tab_set="classification_issues" %}
        </div>
    </div>
{% endblock %}