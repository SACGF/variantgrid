{% extends "uicore/page/base.html" %}
{% load datatable_tags %}
{% load classification_tags %}
{% load ui_menu_bars %}
{% load ui_help %}
{% load ui_utils %}
{% block title %}Condition Matching{% endblock %}
{% block submenu %}{% menu_bar_classifications %}{% endblock submenu %}
{% block head %}

{% endblock head %}
{% block content %}
    <div class="container">
        <h3>Condition Match Testing</h3>
        {% page_help_embedded title='Condition Match Testing' %}
            <p>
            Help will go here for matching text to conditions
            </p>
        {% end_page_help_embedded %}

        <h4>Download</h4>
        <form method="POST" action="{% url 'condition_match_test_download' %}">
            {% csrf_token %}
            Run and download auto matching attempts. (Note doesn't apply the results, just produces them for download).<br/>
            This takes a while so it's recommended you limit your results.<br/>
            <div class="form-group">
                <input type="checkbox" name="external_search" id="external_search" value="True" checkled="True" />
                <label class="form-label ml-1" for="external_search">Fallback to External Server Search</label>
            </div>
            <input class="btn btn-primary" type="submit" value="Download" />
        </form>
        <hr/>
        <h4>Test Single Term</h4>

        <form method="GET">
            {% labelled label="Condition Text" %}<input class="form-control" name="condition_text" value="{{ condition_text | default_if_none:'' }}" />{% endlabelled %}
            {% labelled label="Gene Symbol" %}<input class="form-control" style="max-width:300px" name="gene_symbol" value="{{ gene_symbol | default_if_none:'' }}" />
                <span class="text-muted">(optional)</span>
            {% endlabelled %}
            <button class="btn btn-primary">Search</button>
        </form>

        {% if search_text %}
            <div class="text-muted">
                {% labelled label="Prefix" %}{{ search_text.prefix }}{% endlabelled %}
                {% labelled label="Prefix Terms" %}{{ search_text.prefix_terms_display }}{% endlabelled %}
                {% labelled label="Suffix" %}{{ search_text.suffix }}{% endlabelled %}
                {% labelled label="Suffix Terms" %}{{ search_text.suffix_terms_display }}{% endlabelled %}
            </div>
        {% endif %}

        {% if attempted %}
            <div class="card">
                <div class="card-header">Suggestion (applies at top level only)</div>
                <div class="card-body">
                    {% labelled label="Suggested Term" %}{% if suggestion.terms %}
                        {% for term in suggestion.terms %}
                            {{ term.id }} {{ term.name }}
                        {% endfor %}
                    {% endif %}{% endlabelled %}
                    {% labelled label="Can auto-assign (without confirmation)" %}{{ suggestion.is_auto_assignable }}{% endlabelled %}
                    {% if suggestion.terms %}
                        {% labelled label="Is leaf term" %}{{ suggestion.is_leaf }}{% endlabelled %}
                    {% endif %}
                    {% if suggestion.alias_index %}
                        {% labelled label="OMIM index found in" %}{{ suggestion.alias_index }}{% endlabelled %}
                    {% endif %}
                    {% labelled label="Found IDs in text" %}{{ suggestion.ids_in_text }}{% endlabelled %}
                    {% labelled label="Found IDs in text warning" %}{{ suggestion.ids_in_text_warning }}{% endlabelled %}
                    {% labelled label="Local database candidate terms inspected" %}{{ suggestion.checked_local_terms }}{% endlabelled %}
                    {% labelled label="MONDO search server candidate terms inspected" %}{{ suggestion.checked_server_terms }}{% endlabelled %}
                </div>
            </div>

            {% if auto_matches %}
            <table class="table">
                <thead>
                    <tr>
                        <th>Term</th>
                        <th>Score</th>
                    </tr>
                </thead>
                {% for auto_match in auto_matches %}
                    <tr>
                        <td width="30%">{{ auto_match.term.id }}<br/>
                            {{ auto_match.term.name }}
                            {% if auto_match.term.definition %}<br/><span class="text-muted wy-text-small">{{ auto_match.term.definition }}</span>{% endif %}
                        </td>
                        <td>
                            <div class="row mb-1">
                                <div class="col-1 text-right text-monospace border-bottom" style="font-weight: bold">
                                    {{ auto_match.score | floatformat:0 }}
                                </div>
                                <div class="col-11"></div>
                            </div>
                            {% for part in auto_match.scores %}
                                <div class="row mb-1">
                                    <div class="col-1 text-right text-monospace">{{ part.score | floatformat:0 }}</div>
                                    <div class="col-11">{{ part.name }} : <span class="text-secondary">{{ part.note }} - <span style="font-size:small">{{ part.percent | floatformat:0 }}% of {{ part.max | floatformat:0 }}</span></span></div>
                                </div>
                            {% endfor %}
                        </td>
                    </tr>
                {% endfor %}
            </table>
            {% else %}
                <span class="no-results">No Results</span>
            {% endif %}
        {% endif %}
    </div>
{% endblock %}