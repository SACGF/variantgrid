# Generated by Django 3.1 on 2020-09-29 06:09
import configparser
import re

from django.conf import settings
from django.db import migrations

from library.django_utils import bulk_insert_class_data


def populate_mutational_signature_info(apps, schema_editor):
    MutationalSignatureInfo = apps.get_model("annotation", "MutationalSignatureInfo")

    config = configparser.ConfigParser(interpolation=None)
    config.read(settings.MUTATIONAL_SIGNATURE_INFO_FILE)
    num_signatures = 0
    for section in config.sections():
        if m := re.match(r"Signature (\d+)", section):
            num_signatures += 1
            signature_id = int(m.group(1))
            sdata = config[section]
            comments = sdata["Comments"]
            if comments == "N/A":
                comments = ''

            MutationalSignatureInfo.objects.create(signature_id=signature_id,
                                                   cancer_types=sdata["Cancer types"],
                                                   proposed_aetiology=sdata["Proposed aetiology"],
                                                   additional_mutational_features=sdata["Additional mutational features"],
                                                   comments=comments,)

    print(f"Created info about {num_signatures} mutational signatures")


def populate_column_vep_fields(apps, schema_editor):
    COLUMN_VEP_FIELD = [
        {'column': 'af_1kg', 'vep_plugin': None, 'source_field_has_custom_prefix': False,
         'source_field_processing_description': None, 'vep_custom': None, 'variant_grid_column_id': 'af_1kg',
         'source_field': 'AF', 'category': 'F'},
        {'column': 'af_uk10k', 'vep_plugin': None, 'source_field_has_custom_prefix': True,
         'source_field_processing_description': None, 'vep_custom': 'u', 'variant_grid_column_id': 'af_uk10k',
         'source_field': 'AF', 'category': 'F'},
        {'column': 'amino_acids', 'vep_plugin': None, 'source_field_has_custom_prefix': False,
         'source_field_processing_description': None, 'vep_custom': None, 'variant_grid_column_id': 'amino_acids',
         'source_field': 'Amino_acids', 'category': 'G'},
        {'column': 'cadd_phred', 'vep_plugin': 'd', 'source_field_has_custom_prefix': False,
         'source_field_processing_description': None, 'vep_custom': None, 'variant_grid_column_id': 'cadd_phred',
         'source_field': 'CADD_phred', 'category': 'P'},
        {'column': 'canonical', 'vep_plugin': None, 'source_field_has_custom_prefix': False,
         'source_field_processing_description': None, 'vep_custom': None, 'variant_grid_column_id': 'canonical',
         'source_field': 'CANONICAL', 'category': 'G'},
        {'column': 'codons', 'vep_plugin': None, 'source_field_has_custom_prefix': False,
         'source_field_processing_description': None, 'vep_custom': None, 'variant_grid_column_id': 'codons',
         'source_field': 'Codons', 'category': 'G'},
        {'column': 'consequence', 'vep_plugin': None, 'source_field_has_custom_prefix': False,
         'source_field_processing_description': None, 'vep_custom': None, 'variant_grid_column_id': 'consequence',
         'source_field': 'Consequence', 'category': 'G'},
        {'column': 'cosmic_count', 'vep_plugin': None, 'source_field_has_custom_prefix': True,
         'source_field_processing_description': None, 'vep_custom': 'c', 'variant_grid_column_id': 'cosmic_count',
         'source_field': 'CNT', 'category': 'F'},
        {'column': 'cosmic_id', 'vep_plugin': None, 'source_field_has_custom_prefix': False,
         'source_field_processing_description': 'Extract COSMIC IDs', 'vep_custom': None,
         'variant_grid_column_id': 'cosmic_id', 'source_field': 'Existing_variation', 'category': 'E'},
        {'column': 'cosmic_legacy_id', 'vep_plugin': None, 'source_field_has_custom_prefix': True,
         'source_field_processing_description': None, 'vep_custom': 'c', 'variant_grid_column_id': 'cosmic_legacy_id',
         'source_field': 'LEGACY_ID', 'category': 'E'},
        {'column': 'dbscsnv_ada_score', 'vep_plugin': 'v', 'source_field_has_custom_prefix': False,
         'source_field_processing_description': None, 'vep_custom': None, 'variant_grid_column_id': 'dbscsnv_ada_score',
         'source_field': 'ada_score', 'category': 'S'},
        {'column': 'dbscsnv_rf_score', 'vep_plugin': 'v', 'source_field_has_custom_prefix': False,
         'source_field_processing_description': None, 'vep_custom': None, 'variant_grid_column_id': 'dbscsnv_rf_score',
         'source_field': 'rf_score', 'category': 'S'},
        {'column': 'dbsnp_rs_id', 'vep_plugin': None, 'source_field_has_custom_prefix': False,
         'source_field_processing_description': 'Extract rsIDs', 'vep_custom': None,
         'variant_grid_column_id': 'dbsnp_rs_id', 'source_field': 'Existing_variation', 'category': 'E'},
        {'column': 'distance', 'vep_plugin': None, 'source_field_has_custom_prefix': False,
         'source_field_processing_description': None, 'vep_custom': None, 'variant_grid_column_id': 'distance',
         'source_field': 'DISTANCE', 'category': 'N'},
        {'column': 'domains', 'vep_plugin': None, 'source_field_has_custom_prefix': False,
         'source_field_processing_description': None, 'vep_custom': None, 'variant_grid_column_id': 'domains',
         'source_field': 'DOMAINS', 'category': 'D'},
        {'column': 'ensembl_protein', 'vep_plugin': None, 'source_field_has_custom_prefix': False,
         'source_field_processing_description': None, 'vep_custom': None, 'variant_grid_column_id': 'ensembl_protein',
         'source_field': 'ENSP', 'category': 'E'},
        {'column': 'exon', 'vep_plugin': None, 'source_field_has_custom_prefix': False,
         'source_field_processing_description': None, 'vep_custom': None, 'variant_grid_column_id': 'exon',
         'source_field': 'EXON', 'category': 'G'},
        {'column': 'fathmm_pred_most_damaging', 'vep_plugin': 'd', 'source_field_has_custom_prefix': False,
         'source_field_processing_description': 'Most damaging', 'vep_custom': None,
         'variant_grid_column_id': 'fathmm_pred_most_damaging', 'source_field': 'FATHMM_pred', 'category': 'P'},
        {'column': 'flags', 'vep_plugin': None, 'source_field_has_custom_prefix': False,
         'source_field_processing_description': None, 'vep_custom': None, 'variant_grid_column_id': 'flags',
         'source_field': 'FLAGS', 'category': 'G'},
        {'column': 'gerp_pp_rs', 'vep_plugin': 'd', 'source_field_has_custom_prefix': False,
         'source_field_processing_description': None, 'vep_custom': None, 'variant_grid_column_id': 'gerp_pp_rs',
         'source_field': 'GERP++_RS', 'category': 'C'},
        {'column': 'gnomad_af', 'vep_plugin': None, 'source_field_has_custom_prefix': True,
         'source_field_processing_description': '(exome_AC+genome_AC)/(exome_AN+genome_AN)', 'vep_custom': 'g',
         'variant_grid_column_id': 'gnomad_af', 'source_field': 'AF', 'category': 'F'},
        {'column': 'gnomad_afr_af', 'vep_plugin': None, 'source_field_has_custom_prefix': True,
         'source_field_processing_description': '(exome_AC+genome_AC)/(exome_AN+genome_AN)', 'vep_custom': 'g',
         'variant_grid_column_id': 'gnomad_afr_af', 'source_field': 'AF_afr', 'category': 'F'},
        {'column': 'gnomad_amr_af', 'vep_plugin': None, 'source_field_has_custom_prefix': True,
         'source_field_processing_description': '(exome_AC+genome_AC)/(exome_AN+genome_AN)', 'vep_custom': 'g',
         'variant_grid_column_id': 'gnomad_amr_af', 'source_field': 'AF_amr', 'category': 'F'},
        {'column': 'gnomad_asj_af', 'vep_plugin': None, 'source_field_has_custom_prefix': True,
         'source_field_processing_description': '(exome_AC+genome_AC)/(exome_AN+genome_AN)', 'vep_custom': 'g',
         'variant_grid_column_id': 'gnomad_asj_af', 'source_field': 'AF_asj', 'category': 'F'},
        {'column': 'gnomad_eas_af', 'vep_plugin': None, 'source_field_has_custom_prefix': True,
         'source_field_processing_description': '(exome_AC+genome_AC)/(exome_AN+genome_AN)', 'vep_custom': 'g',
         'variant_grid_column_id': 'gnomad_eas_af', 'source_field': 'AF_eas', 'category': 'F'},
        {'column': 'gnomad_filtered', 'vep_plugin': None, 'source_field_has_custom_prefix': True,
         'source_field_processing_description': 'Filtered in either exome or genomes VCF', 'vep_custom': 'g',
         'variant_grid_column_id': 'gnomad_filtered', 'source_field': 'gnomad_filtered', 'category': 'F'},
        {'column': 'gnomad_fin_af', 'vep_plugin': None, 'source_field_has_custom_prefix': True,
         'source_field_processing_description': '(exome_AC+genome_AC)/(exome_AN+genome_AN)', 'vep_custom': 'g',
         'variant_grid_column_id': 'gnomad_fin_af', 'source_field': 'AF_fin', 'category': 'F'},
        {'column': 'gnomad_hom_alt', 'vep_plugin': None, 'source_field_has_custom_prefix': True,
         'source_field_processing_description': 'exome_nhomalt + genome_nhomalt', 'vep_custom': 'g',
         'variant_grid_column_id': 'gnomad_hom_alt', 'source_field': 'nhomalt', 'category': 'F'},
        {'column': 'gnomad_nfe_af', 'vep_plugin': None, 'source_field_has_custom_prefix': True,
         'source_field_processing_description': '(exome_AC+genome_AC)/(exome_AN+genome_AN)', 'vep_custom': 'g',
         'variant_grid_column_id': 'gnomad_nfe_af', 'source_field': 'AF_nfe', 'category': 'F'},
        {'column': 'gnomad_oth_af', 'vep_plugin': None, 'source_field_has_custom_prefix': True,
         'source_field_processing_description': None, 'vep_custom': 'g', 'variant_grid_column_id': 'gnomad_oth_af',
         'source_field': 'AF_oth', 'category': 'F'},
        {'column': 'gnomad_popmax', 'vep_plugin': None, 'source_field_has_custom_prefix': True,
         'source_field_processing_description': None, 'vep_custom': 'g', 'variant_grid_column_id': 'gnomad_popmax',
         'source_field': 'popmax', 'category': 'F'},
        {'column': 'gnomad_popmax_af', 'vep_plugin': None, 'source_field_has_custom_prefix': True,
         'source_field_processing_description': 'Re-calculated from max (exome_AC+genome_AC)/(exome_AN+genome_AN)',
         'vep_custom': 'g', 'variant_grid_column_id': 'gnomad_popmax_af', 'source_field': 'AF_popmax', 'category': 'F'},
        {'column': 'gnomad_sas_af', 'vep_plugin': None, 'source_field_has_custom_prefix': True,
         'source_field_processing_description': '(exome_AC+genome_AC)/(exome_AN+genome_AN)', 'vep_custom': 'g',
         'variant_grid_column_id': 'gnomad_sas_af', 'source_field': 'AF_sas', 'category': 'F'},
        {'column': 'grantham', 'vep_plugin': 'g', 'source_field_has_custom_prefix': False,
         'source_field_processing_description': None, 'vep_custom': None, 'variant_grid_column_id': 'grantham',
         'source_field': 'Grantham', 'category': 'P'},
        {'column': 'hgnc_id', 'vep_plugin': None, 'source_field_has_custom_prefix': False,
         'source_field_processing_description': None, 'vep_custom': None, 'variant_grid_column_id': 'hgnc_id',
         'source_field': 'HGNC_ID', 'category': 'E'},
        {'column': 'hgvs_c', 'vep_plugin': None, 'source_field_has_custom_prefix': False,
         'source_field_processing_description': None, 'vep_custom': None, 'variant_grid_column_id': 'hgvs_c',
         'source_field': 'HGVSc', 'category': 'H'},
        {'column': 'hgvs_p', 'vep_plugin': None, 'source_field_has_custom_prefix': False,
         'source_field_processing_description': None, 'vep_custom': None, 'variant_grid_column_id': 'hgvs_p',
         'source_field': 'HGVSp', 'category': 'H'},
        {'column': 'impact', 'vep_plugin': None, 'source_field_has_custom_prefix': False,
         'source_field_processing_description': None, 'vep_custom': None, 'variant_grid_column_id': 'impact',
         'source_field': 'IMPACT', 'category': 'P'},
        {'column': 'interpro_domain', 'vep_plugin': 'd', 'source_field_has_custom_prefix': False,
         'source_field_processing_description': None, 'vep_custom': None, 'variant_grid_column_id': 'interpro_domain',
         'source_field': 'Interpro_domain', 'category': 'D'},
        {'column': 'intron', 'vep_plugin': None, 'source_field_has_custom_prefix': False,
         'source_field_processing_description': None, 'vep_custom': None, 'variant_grid_column_id': 'intron',
         'source_field': 'INTRON', 'category': 'G'},
        {'column': 'loftool', 'vep_plugin': 'l', 'source_field_has_custom_prefix': False,
         'source_field_processing_description': None, 'vep_custom': None, 'variant_grid_column_id': 'loftool',
         'source_field': 'LoFtool', 'category': 'P'},
        {'column': 'mastermind_count_1_cdna', 'vep_plugin': 'n', 'source_field_has_custom_prefix': False,
         'source_field_processing_description': 'MMCNT1', 'vep_custom': None,
         'variant_grid_column_id': 'mastermind_count_1_cdna', 'source_field': 'Mastermind_counts', 'category': 'L'},
        {'column': 'mastermind_count_2_cdna_prot', 'vep_plugin': 'n', 'source_field_has_custom_prefix': False,
         'source_field_processing_description': 'MMCNT2', 'vep_custom': None,
         'variant_grid_column_id': 'mastermind_count_2_cdna_prot', 'source_field': 'Mastermind_counts',
         'category': 'L'},
        {'column': 'mastermind_count_3_aa_change', 'vep_plugin': 'n', 'source_field_has_custom_prefix': False,
         'source_field_processing_description': 'MMCNT3', 'vep_custom': None,
         'variant_grid_column_id': 'mastermind_count_3_aa_change', 'source_field': 'Mastermind_counts',
         'category': 'L'},
        {'column': 'mastermind_mmid3', 'vep_plugin': 'n', 'source_field_has_custom_prefix': False,
         'source_field_processing_description': None, 'vep_custom': None, 'variant_grid_column_id': 'mastermind_mmid3',
         'source_field': 'Mastermind_MMID3', 'category': 'L'},
        {'column': 'maxentscan_alt', 'vep_plugin': 'm', 'source_field_has_custom_prefix': False,
         'source_field_processing_description': None, 'vep_custom': None, 'variant_grid_column_id': 'maxentscan_alt',
         'source_field': 'MaxEntScan_alt', 'category': 'S'},
        {'column': 'maxentscan_diff', 'vep_plugin': 'm', 'source_field_has_custom_prefix': False,
         'source_field_processing_description': None, 'vep_custom': None, 'variant_grid_column_id': 'maxentscan_diff',
         'source_field': 'MaxEntScan_diff', 'category': 'S'},
        {'column': 'maxentscan_ref', 'vep_plugin': 'm', 'source_field_has_custom_prefix': False,
         'source_field_processing_description': None, 'vep_custom': None, 'variant_grid_column_id': 'maxentscan_ref',
         'source_field': 'MaxEntScan_ref', 'category': 'S'},
        {'column': 'mutation_assessor_pred_most_damaging', 'vep_plugin': 'd', 'source_field_has_custom_prefix': False,
         'source_field_processing_description': 'Most damaging', 'vep_custom': None,
         'variant_grid_column_id': 'mutation_assessor_pred_most_damaging', 'source_field': 'MutationAssessor_pred',
         'category': 'P'},
        {'column': 'mutation_taster_pred_most_damaging', 'vep_plugin': 'd', 'source_field_has_custom_prefix': False,
         'source_field_processing_description': 'Most damaging', 'vep_custom': None,
         'variant_grid_column_id': 'mutation_taster_pred_most_damaging', 'source_field': 'MutationTaster_pred',
         'category': 'P'},
        {'column': 'phastcons_100_way_vertebrate', 'vep_plugin': None, 'source_field_has_custom_prefix': False,
         'source_field_processing_description': 'max() for indels', 'vep_custom': '1',
         'variant_grid_column_id': 'phastcons_100_way_vertebrate', 'source_field': 'phastCons100way_vertebrate',
         'category': 'C'},
        {'column': 'phastcons_30_way_mammalian', 'vep_plugin': None, 'source_field_has_custom_prefix': False,
         'source_field_processing_description': 'max() for indels', 'vep_custom': '2',
         'variant_grid_column_id': 'phastcons_30_way_mammalian', 'source_field': 'phastCons30way_mammalian',
         'category': 'C'},
        {'column': 'phastcons_46_way_mammalian', 'vep_plugin': None, 'source_field_has_custom_prefix': False,
         'source_field_processing_description': 'max() for indels', 'vep_custom': '3',
         'variant_grid_column_id': 'phastcons_46_way_mammalian', 'source_field': 'phastCons46way_mammalian',
         'category': 'C'},
        {'column': 'phylop_100_way_vertebrate', 'vep_plugin': None, 'source_field_has_custom_prefix': False,
         'source_field_processing_description': 'max() for indels', 'vep_custom': '4',
         'variant_grid_column_id': 'phylop_100_way_vertebrate', 'source_field': 'phyloP100way_vertebrate',
         'category': 'C'},
        {'column': 'phylop_30_way_mammalian', 'vep_plugin': None, 'source_field_has_custom_prefix': False,
         'source_field_processing_description': 'max() for indels', 'vep_custom': '5',
         'variant_grid_column_id': 'phylop_30_way_mammalian', 'source_field': 'phyloP30way_mammalian', 'category': 'C'},
        {'column': 'phylop_46_way_mammalian', 'vep_plugin': None, 'source_field_has_custom_prefix': False,
         'source_field_processing_description': 'max() for indels', 'vep_custom': '6',
         'variant_grid_column_id': 'phylop_46_way_mammalian', 'source_field': 'phyloP46way_mammalian', 'category': 'C'},
        {'column': 'polyphen2_hvar_pred_most_damaging', 'vep_plugin': 'd', 'source_field_has_custom_prefix': False,
         'source_field_processing_description': 'Most damaging', 'vep_custom': None,
         'variant_grid_column_id': 'polyphen2_hvar_pred_most_damaging', 'source_field': 'Polyphen2_HVAR_pred',
         'category': 'P'},
        {'column': 'protein_position', 'vep_plugin': None, 'source_field_has_custom_prefix': False,
         'source_field_processing_description': None, 'vep_custom': None, 'variant_grid_column_id': 'protein_position',
         'source_field': 'Protein_position', 'category': 'G'},
        {'column': 'pubmed', 'vep_plugin': None, 'source_field_has_custom_prefix': False,
         'source_field_processing_description': None, 'vep_custom': None, 'variant_grid_column_id': 'pubmed',
         'source_field': 'PUBMED', 'category': 'L'},
        {'column': 'repeat_masker', 'vep_plugin': None, 'source_field_has_custom_prefix': False,
         'source_field_processing_description': None, 'vep_custom': 'r', 'variant_grid_column_id': 'repeat_masker',
         'source_field': 'REPEAT_MASKER', 'category': 'Q'},
        {'column': 'revel_score', 'vep_plugin': 'd', 'source_field_has_custom_prefix': False,
         'source_field_processing_description': None, 'vep_custom': None, 'variant_grid_column_id': 'revel_score',
         'source_field': 'REVEL_score', 'category': 'P'},
        {'column': 'sift', 'vep_plugin': None, 'source_field_has_custom_prefix': False,
         'source_field_processing_description': None, 'vep_custom': None, 'variant_grid_column_id': 'sift',
         'source_field': 'SIFT', 'category': 'P'},
        {'column': 'somatic', 'vep_plugin': None, 'source_field_has_custom_prefix': False,
         'source_field_processing_description': 'Any values present', 'vep_custom': None,
         'variant_grid_column_id': 'somatic', 'source_field': 'SOMATIC', 'category': 'E'},
        {'column': 'spliceai_pred_dp_ag', 'vep_plugin': 'a', 'source_field_has_custom_prefix': False,
         'source_field_processing_description': None, 'vep_custom': None,
         'variant_grid_column_id': 'spliceai_pred_dp_ag', 'source_field': 'SpliceAI_pred_DP_AG', 'category': 'S'},
        {'column': 'spliceai_pred_dp_al', 'vep_plugin': 'a', 'source_field_has_custom_prefix': False,
         'source_field_processing_description': None, 'vep_custom': None,
         'variant_grid_column_id': 'spliceai_pred_dp_al', 'source_field': 'SpliceAI_pred_DP_AL', 'category': 'S'},
        {'column': 'spliceai_pred_dp_dg', 'vep_plugin': 'a', 'source_field_has_custom_prefix': False,
         'source_field_processing_description': None, 'vep_custom': None,
         'variant_grid_column_id': 'spliceai_pred_dp_dg', 'source_field': 'SpliceAI_pred_DP_DG', 'category': 'S'},
        {'column': 'spliceai_pred_dp_dl', 'vep_plugin': 'a', 'source_field_has_custom_prefix': False,
         'source_field_processing_description': None, 'vep_custom': None,
         'variant_grid_column_id': 'spliceai_pred_dp_dl', 'source_field': 'SpliceAI_pred_DP_DL', 'category': 'S'},
        {'column': 'spliceai_pred_ds_ag', 'vep_plugin': 'a', 'source_field_has_custom_prefix': False,
         'source_field_processing_description': None, 'vep_custom': None,
         'variant_grid_column_id': 'spliceai_pred_ds_ag', 'source_field': 'SpliceAI_pred_DS_AG', 'category': 'S'},
        {'column': 'spliceai_pred_ds_al', 'vep_plugin': 'a', 'source_field_has_custom_prefix': False,
         'source_field_processing_description': None, 'vep_custom': None,
         'variant_grid_column_id': 'spliceai_pred_ds_al', 'source_field': 'SpliceAI_pred_DS_AL', 'category': 'S'},
        {'column': 'spliceai_pred_ds_dg', 'vep_plugin': 'a', 'source_field_has_custom_prefix': False,
         'source_field_processing_description': None, 'vep_custom': None,
         'variant_grid_column_id': 'spliceai_pred_ds_dg', 'source_field': 'SpliceAI_pred_DS_DG', 'category': 'S'},
        {'column': 'spliceai_pred_ds_dl', 'vep_plugin': 'a', 'source_field_has_custom_prefix': False,
         'source_field_processing_description': None, 'vep_custom': None,
         'variant_grid_column_id': 'spliceai_pred_ds_dl', 'source_field': 'SpliceAI_pred_DS_DL', 'category': 'S'},
        {'column': 'splice_region', 'vep_plugin': 's', 'source_field_has_custom_prefix': False,
         'source_field_processing_description': None, 'vep_custom': None, 'variant_grid_column_id': 'splice_region',
         'source_field': 'SpliceRegion', 'category': 'S'},
        {'column': 'symbol', 'vep_plugin': None, 'source_field_has_custom_prefix': False,
         'source_field_processing_description': None, 'vep_custom': None, 'variant_grid_column_id': 'symbol',
         'source_field': 'SYMBOL', 'category': 'G'},
        {'column': 'topmed_af', 'vep_plugin': None, 'source_field_has_custom_prefix': True,
         'source_field_processing_description': None, 'vep_custom': 't', 'variant_grid_column_id': 'topmed_af',
         'source_field': 'TOPMED', 'category': 'F'},
        {'column': 'variant_class', 'vep_plugin': None, 'source_field_has_custom_prefix': False,
         'source_field_processing_description': None, 'vep_custom': None, 'variant_grid_column_id': 'variant_class',
         'source_field': 'VARIANT_CLASS', 'category': 'G'},
    ]

    bulk_insert_class_data(apps, "annotation", [("ColumnVEPField", COLUMN_VEP_FIELD)])


class Migration(migrations.Migration):
    dependencies = [
        ('annotation', '0002_auto_20200929_1503'),
        ('snpdb', '0002_initial_data'),  # Need VariantGridColumns inserted
    ]

    operations = [
        migrations.RunPython(populate_mutational_signature_info),
        migrations.RunPython(populate_column_vep_fields),
    ]
